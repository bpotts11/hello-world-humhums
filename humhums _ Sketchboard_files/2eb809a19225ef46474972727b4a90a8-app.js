"use strict";function getScopeById(e){var t=document.getElementById(e);return angular.element(t).scope()}function getBoardService(){return"undefined"!=typeof boardService?boardService:(location.reload(),null)}function getAccountService(){return"undefined"!=typeof backend?backend:(location.reload(),null)}window.serverUnreachable=function(){$(document).trigger("server-unreachable")};var pcode="P".charCodeAt(0),globalStreams=function(){var e={};e.onlineStream=Bacon.fromBinder(function(e){function t(t,n){o=!1,e(!1)}function n(t,n){0==o&&(o=!0,e(!0))}var o=!0;return $(document).on("server-unreachable",t),$(document).on("server-ack",n),window.addEventListener("online",n),window.addEventListener("offline",t),function(){$(document).off("server-unreachable",t),$(document).off("server-ack",n),window.removeEventListener("online",n),window.removeEventListener("offline",t)}}),e.webStorageSupportedStream=Bacon.fromBinder(function(e){function t(t,n){e(!1)}return $(document).on("no-local-storage",t),function(){$(document).off("no-local-storage",t)}}),e.spaceKeyStream=$(window).asEventStream("keydown").filter(function(e){return 32==e.keyCode&&1!=e.ctrlKey&&1!=e.metaKey&&1!=e.shiftKey&&1!=e.altKey&&!isMenuOpen()}).debounceImmediate(200),e.arrowsStream=$(window).asEventStream("keydown").filter(function(e){return(37==e.keyCode||38==e.keyCode||39==e.keyCode||40==e.keyCode)&&1!=e.ctrlKey&&1!=e.metaKey&&1!=e.shiftKey&&1!=e.altKey}).map(function(e){return e.keyCode}),e.numberShorcutStream=$(window).asEventStream("keydown").filter(function(e){return e.keyCode>=48&&e.keyCode<=57&&1!=e.ctrlKey&&1!=e.metaKey&&1!=e.shiftKey&&1!=e.altKey}).map(function(e){return e.keyCode}),e.dataItemModifyStream=new Bacon.Bus,e.dataItemDeleteStream=new Bacon.Bus,e.deleteShapeStream=new Bacon.Bus,e.closeLibraryStram=new Bacon.Bus,e.undoStackStream=new Bacon.Bus,e.redoStackStream=new Bacon.Bus,e.shapeLinkStream=new Bacon.Bus,e.shapeResizeStream=new Bacon.Bus,e.newChatMessageStream=new Bacon.Bus,e.clearChatStateStream=new Bacon.Bus,e.currentUserStream=new Bacon.Bus,e.websocketMouseStream=new Bacon.Bus,e.usersStream=new Bacon.Bus,e.notifyStream=new Bacon.Bus,e.shapeContextStream=new Bacon.Bus,e.newShapeStream=new Bacon.Bus,e.mapViewStateStream=new Bacon.Bus,e.contextMenuStream=new Bacon.Bus,e.showFreehandLineWeightStream=new Bacon.Bus,e.updatedFreehandLineWeightStream=new Bacon.Bus,e.onboardingStream=new Bacon.Bus,e.reloadBoardUsersStream=new Bacon.Bus,e.boardScaledStream=new Bacon.Bus,e.scaleRestoreStream=new Bacon.Bus,e.reduxStream=new Bacon.Bus,e.userMessagePropsStream=new Bacon.Bus,e.userMessageEventStream=new Bacon.Bus,e.selectionStream=new Bacon.Bus;var t="N".charCodeAt(0);e.newBoardShortcutStream=$(window).asEventStream("keydown").filter(function(e){var n=e.keyCode==t&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey&&e.altKey;return n&&e.preventDefault(),n});var n="E".charCodeAt(0);e.editPresentationShortcutStream=$(window).asEventStream("keydown").filter(function(e){var t=e.keyCode==n&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey&&e.altKey;return t&&e.preventDefault(),t});var o="I".charCodeAt(0);e.boardInfoShortcutStream=$(window).asEventStream("keydown").filter(function(e){var t=e.keyCode==o&&(e.ctrlKey||e.metaKey)&&!e.shiftKey&&!e.altKey&&!gwtIsEditorOpen();return t&&e.preventDefault(),t});var r="K".charCodeAt(0);e.switchTeamShortcutStream=$(window).asEventStream("keydown").filter(function(e){var t=e.keyCode==r&&(e.ctrlKey||e.metaKey)&&!e.shiftKey&&!e.altKey;return t&&e.preventDefault(),t});var a=13;e.enterCmdShortcutStream=$(window).asEventStream("keydown").filter(function(e){var t=e.keyCode==a&&(e.ctrlKey||e.metaKey)&&!e.shiftKey&&!e.altKey;return t&&e.preventDefault(),t}),e.startPresentationShortcutStream=$(window).asEventStream("keydown").filter(function(e){var t=e.keyCode==pcode&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey&&e.altKey;return t&&e.preventDefault(),t}),e.presentationCommandStream=new Bacon.Bus,e.addSlideStream=new Bacon.Bus,e.quitPresentationStream=new Bacon.Bus,e.editPresentationStream=new Bacon.Bus,e.slideCreatedStream=new Bacon.Bus,e.scaleResetStream=new Bacon.Bus,e.boardSaveStatusChangedStream=new Bacon.Bus,e.reloadTagsStream=new Bacon.Bus,e.backgroundMoveStream=new Bacon.Bus,e.closeEditorStream=new Bacon.Bus,e.handToolStream=new Bacon.Bus,e.shapeAddedStream=new Bacon.Bus,e.hideContextMenuStream=new Bacon.Bus,e.trySendQueueStream=new Bacon.Bus,e.cometSessionStream=new Bacon.Bus;var i="H".charCodeAt(0);e.handToolShortcutStream=$(window).asEventStream("keydown").filter(function(e){var t=!(e.keyCode!=i||e.ctrlKey||e.metaKey||e.shiftKey||e.altKey||gwtIsEditorOpen()||window.isMenuOpen());return t&&e.preventDefault(),t});var c="Z".charCodeAt(0);e.birdsEyeShortcutDownStream=$(window).asEventStream("keydown").filter(function(e){var t=!(e.keyCode!=c||e.ctrlKey||e.metaKey||e.shiftKey||e.altKey||window.isMenuOpen()||gwtIsEditorOpen());return t&&e.preventDefault(),t});var s="C".charCodeAt(0);e.commentShortcutStream=$(window).asEventStream("keydown").filter(function(e){var t=!(e.keyCode!=s||e.ctrlKey||e.metaKey||e.shiftKey||e.altKey||gwtIsEditorOpen()||window.isMenuOpen());return t&&e.preventDefault(),t}),e.birdsEyeShortcutUpStream=$(window).asEventStream("keyup").filter(function(e){var t=!(e.keyCode!=c||e.ctrlKey||e.metaKey||e.shiftKey||e.altKey||window.isMenuOpen()||gwtIsEditorOpen());return t&&e.preventDefault(),t});var l="+".charCodeAt(0),u=187;e.zoomInShortcutStream=$(window).asEventStream("keydown").filter(function(e){var t=!(e.keyCode!=l&&e.keyCode!=u&&"+"!=e.key||e.ctrlKey||e.metaKey||e.shiftKey||e.altKey||window.isMenuOpen()||gwtIsEditorOpen());return t&&e.preventDefault(),t});var d="-".charCodeAt(0),f=189;e.zoomOutShortcutStream=$(window).asEventStream("keydown").filter(function(e){var t=!(e.keyCode!=d&&e.keyCode!=f&&"-"!=e.key||e.ctrlKey||e.metaKey||e.shiftKey||e.altKey||window.isMenuOpen()||gwtIsEditorOpen());return t&&e.preventDefault(),t});var p="0".charCodeAt(0);e.zoomResetShortcutStream=$(window).asEventStream("keydown").filter(function(e){var t=!(e.keyCode!=p&&"0"!=e.key||e.ctrlKey||e.metaKey||e.shiftKey||e.altKey||window.isMenuOpen()||gwtIsEditorOpen());return t&&e.preventDefault(),t});var m=113;e.editShapeStream=$(window).asEventStream("keydown").filter(function(e){var t=!(e.keyCode!=m&&e.keyCode!=a||e.ctrlKey||e.metaKey||e.shiftKey||e.altKey||window.isMenuOpen()||gwtIsEditorOpen());return t&&e.preventDefault(),t}),e.scaleAtStream=new Bacon.Bus,e.surfaceTransformStream=new Bacon.Bus,e.shapeDragStream=new Bacon.Bus,e.applyOperationsStream=new Bacon.Bus,e.freehandStream=new Bacon.Bus;var h=!1;return e.boardLoadedWrapStream={onValue:function(e){var t;return h?e():t=boardLoadedStream.onValue(function(){h=!0,e()}),t}},e.isBoardLoaded=function(){return h},e}(),spaceKeyManager=function(){var e=!1,t={stream:globalStreams.spaceKeyStream};return t.stream.onValue(function(t){_.defer(function(){e=!1})}),t.isHandled=function(){return e},t.handled=function(){e=!0},t}(),globalState=function(){var e={contextMenuOpen:!1,addSlideMode:!1};return globalStreams.contextMenuStream.filter(function(e){return e&&"context-menu-open"===e.type}).onValue(function(t){e.contextMenuOpen=!0}),globalStreams.contextMenuStream.filter(function(e){return e&&"context-menu-hide"===e.type}).onValue(function(t){e.contextMenuOpen=!1}),globalStreams.addSlideStream.onValue(function(){e.addSlideMode=!e.addSlideMode}),e.cancelAddSlideMode=function(){e.addSlideMode&&globalStreams.addSlideStream.push()},e}();window.cancelStream=$(window).asEventStream("keydown").filter(function(e){return 27==e.keyCode&&1!=e.ctrlKey&&1!=e.metaKey&&1!=e.shiftKey&&1!=e.altKey});var doubleDelta=500,lastESC=0;globalStreams.doubleCancelStream=$(window).asEventStream("keydown").filter(function(e){var t=27==e.keyCode&&1!=e.ctrlKey&&1!=e.metaKey&&1!=e.shiftKey&&1!=e.altKey,n=!1;if(t){var o=new Date;o-lastESC<=doubleDelta&&(n=!0,o=0),lastESC=o}return n}),window.shiftDownStream=$(window).asEventStream("keydown").filter(function(e){return 16==e.keyCode&&1==e.shiftKey&&!isEditorOpen()&&1!=e.ctrlKey&&1!=e.metaKey&&1!=e.altKey}),window.shiftUpStream=$(window).asEventStream("keyup").filter(function(e){return 16==e.keyCode&&!isEditorOpen()&&1!=e.ctrlKey&&1!=e.metaKey&&1!=e.altKey}),window.switchBoardStream=$(window).asEventStream("keydown").filter(function(e){var t=e.keyCode==pcode&&(1==e.ctrlKey||1==e.metaKey)&&1!=e.shiftKey&&1!=e.altKey;return t&&e.preventDefault(),t}),window.boardLoadedStream=Bacon.fromBinder(function(e){function t(t,n){e(n)}return $(document).on("board-loaded",t),function(){$(document).off("board-loaded",t)}}),window.changeFreehandColorStream=Bacon.fromBinder(function(e){function t(t,n){e(n)}return $(document).on("showFreehandColorMenu",t),function(){$(document).off("showFreehandColorMenu",t)}}),window.freehandOnStream=globalStreams.freehandStream.filter(function(e){return e}),window.streamShapeContextMenuShown=Bacon.fromBinder(function(e){function t(t,n){e(n)}return $(document).on("shape-context-menu-shown",t),function(){$(document).off("shape-context-menu-shown",t)}}),window.streamStartTour=Bacon.fromBinder(function(e){function t(t,n){e(n)}return $(document).on("start-tour",t),function(){$(document).off("start-tour",t)}}),window.streamEndTour=Bacon.fromBinder(function(e){function t(t,n){e(n)}return $(document).on("end-tour",t),function(){$(document).off("end-tour",t)}}),window.newLibraryImageStream=Bacon.fromBinder(function(e){function t(t,n){e(n)}return $(document).on("add-img-lib",t),function(){$(document).off("add-img-lib",t)}}),window.deleteLibraryImageStream=Bacon.fromBinder(function(e){function t(t,n){e(n.deleted)}return $(document).on("del-img-lib",t),function(){$(document).off("del-img-lib",t)}}),window.themeChangedStream=Bacon.fromBinder(function(e){function t(t,n){window.themeName.value=n,e(n)}return $(document).on("theme-changed",t),function(){$(document).off("theme-changed",t)}}),window.mapViewStream=Bacon.fromBinder(function(e){function t(t,n){e(n)}return $(document).on("map-view",t),function(){$(document).off("map-view",t)}}).map(function(e){return"start"==e}),window.boardReadyStream=Bacon.fromBinder(function(e){function t(t){e(themeName)}return $(document).on("board-rendered",t),function(){$(document).off("board-rendered",t)}});var sketchboard=function(){function e(e){for(var t=[],n=null,o=1;o-1>=0&&o+1<e.length;++o){var a=e[o+1],i=e[o-1],c=a.subtract(e[o]),s=i.subtract(e[o]),l=c.getLength(),u=s.getLength();if(l>0&&u>0){var d=u/l,f=c.multiply(d).subtract(s).normalize(),p=f.negate().multiply(u/3),m=f.multiply(l/3);p=p.add(e[o]),m=m.add(e[o]),1==o?t.push(new r(i,e[o],i,p)):t.push(new r(i,e[o],n,p)),n=m}}return e.length-2<e.length&&t.push(new r(e[e.length-2],e[e.length-1],n,e[e.length-1])),t}function t(e){for(var t="M",n=0;n<e.length;++n)0==n?(t+=e[n].p1.x+","+e[n].p1.y,t+=" C"):t+=" ",t+=e[n].cp1.x+","+e[n].cp1.y+" ",t+=e[n].cp2.x+","+e[n].cp2.y+" ",t+=e[n].p2.x+","+e[n].p2.y;return t}function n(e){for(var t=[],n=0;n<e.length;n+=2){var o=new a(e[n+0],e[n+1]);t.push(o)}return t}var o={},r=function(e,t,n,o){this.p1=e,this.p2=t,this.cp1=n,this.cp2=o},a=function(e,t){this.x=e,this.y=t,this.read=function(){var e=arguments[0];return e.length>0&&e[0]instanceof a?e[0]:e.length>0&&"number"==typeof e[0]?new a(e[0],e[0]):void 0},this.subtract=function(){var e=this.read(arguments);return new a(this.x-e.x,this.y-e.y)},this.toString=function(){return"{ x: "+this.x+", y: "+this.y+" }"},this.add=function(){var e=this.read(arguments);return new a(this.x+e.x,this.y+e.y)},this.multiply=function(){var e=this.read(arguments);return new a(this.x*e.x,this.y*e.y)},this.getLength=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},this.normalize=function(e){void 0===e&&(e=1);var t=this.getLength(),n=0!==t?e/t:0,o=new a(this.x*n,this.y*n);return o},this.negate=function(){return new a(-this.x,-this.y)},this.equals=function(e){return this===e||e&&(this.x===e.x&&this.y===e.y||Array.isArray(e)&&this.x===e[0]&&this.y===e[1])||!1}};return o.Segment=r,o.Point=a,o.smoothPointsToSegments=e,o.segmentsToPath=t,o.toPoints=n,o}(),mousews=function(){function e(){var e=new Date;return e.getTime()}function t(){var t=e();if(!(n&&t<n+5e3)){n=t;var o=function(){return"https:"==location.protocol?"wss:":"ws:"},r=function(){return location.port.length>0?":"+location.port:""},a=o()+"/"+location.hostname+r()+_config.mousewsURL;console.info("mousews:",a);var i=new WebSocket(a);return i.onmessage=function(e){var t=JSON.parse(e.data);globalStreams.websocketMouseStream.push(t)},i.onopen=function(){},i.onclose=function(){},i}}var n=null,o={},r=!0;return globalStreams.onlineStream.onValue(function(e){r=e}),o.synchronize=function(){try{if(o.ws&&1==o.ws.readyState)return!0;!r||o.ws&&3!=o.ws.readyState||(o.ws=t())}catch(e){}return!1},o.send=function(e){r&&o.ws&&1==o.ws.readyState?(o.ws.send(e),o.userLastActivity=(new Date).getTime()):o.synchronize()},o}(),webStorage=function(){var e,t={},n="ls_",o="localStorage",r=function(e){return n+e},a=function(){try{var t=o in window&&null!==window[o],n=r("__"+Math.round(1e7*Math.random()));return t&&(e=window[o],e.setItem(n,""),e.removeItem(n)),t}catch(e){return $(document).trigger("no-local-storage"),!1}}();return t.browserSupportsLocalStorage=a,t.set=function(t,n){try{e&&e.setItem(r(t),n)}catch(e){return $(document).trigger("no-local-storage"),!1}return!0},t.get=function(t){var n=null;try{n=e?e.getItem(r(t)):null}catch(e){return $(document).trigger("no-local-storage"),!1}return n},t.isEmpty=function(e){return null==t.get(e)},t.remove=function(t){try{e.removeItem(r(t))}catch(e){return $(document).trigger("no-local-storage"),!1}return!0},t.listen=function(e,t){window.addEventListener("storage",function(n){var o=r(e);n.key===o&&t(n)})},t}(),app=angular.module("myApp",["myApp.controllers","myApp.directives","myApp.factories","myApp.services","myApp.filters","myApp.constants","ngRoute","ngSanitize","ngCookies","ngTouch"]).config(["$locationProvider",function(e){e.hashPrefix("")}]).config(["$routeProvider",function(e){e.when("/account",{templateUrl:"partials/account.html",controller:"AccountController"}),e.when("/profile",{templateUrl:"partials/profile.html",controller:"ProfileController"}),e.when("/integrations",{templateUrl:"partials/integrations.html",controller:"IntegrationsController2"}),e.when("/flowdockint",{templateUrl:"partials/flowdockint.html",controller:"IntegrationsController"}),e.when("/flowdock",{templateUrl:"partials/flowdock.html",controller:"FlowdockController"}),e.when("/slackint",{templateUrl:"partials/slackint.html",controller:"SlackIntController"}),e.when("/hipchatauth",{templateUrl:"partials/hipchatauth.html",controller:"HipChatAuthController"}),e.when("/slack",{templateUrl:"partials/slack.html",controller:"SlackController"}),e.when("/comments",{templateUrl:"partials/comments.html",controller:"CommentsController"}),e.when("/comments2",{templateUrl:"partials/comments2.html",controller:"Comments2Controller"}),e.when("/plans",{templateUrl:"partials/plans.html",controller:"PlansController"}),e.when("/teams",{templateUrl:"partials/teams.html",controller:"TeamsController"}),e.when("/payment",{templateUrl:"partials/payment.html",controller:"PaymentController"}),e.when("/makepayment",{templateUrl:"partials/makepayment.html",controller:"MakePaymentController"}),e.when("/stripepayment",{templateUrl:"partials/stripepayment.html",controller:"StripePaymentController"}),e.when("/billing",{templateUrl:"partials/billing.html",controller:"BillingController"}),e.when("/managesubscription",{templateUrl:"partials/managesubscription.html",controller:"ManageSubscriptionController"}),e.when("/account-delete",{templateUrl:"partials/account-delete.html",controller:"AccountDeleteController"}),e.when("/login",{templateUrl:"partials/login.html",controller:"LoginController"}),e.when("/feedback",{templateUrl:"partials/feedback.html",controller:"FeedbackController"}),e.when("/contacts",{templateUrl:"partials/contacts.html"}),e.when("/githubhelp",{templateUrl:"partials/githubhelp.html"}),e.when("/exportgithub",{templateUrl:"partials/exportgithub.html",controller:"ExportGitHubController"}),e.when("/error",{templateUrl:"partials/error.html",controller:"ErrorController"}),e.when("/stripe",{templateUrl:"partials/stripecharge.html",controller:"StripeChargeController"}),e.when("/modifyimages",{templateUrl:"partials/modifylibimages.html",controller:"LibImgController"}),e.when("/sendeditemail",{templateUrl:"partials/sendeditemail.html",controller:"SendEditEmailController"}),e.when("/menu",{templateUrl:"partials/menu.html",controller:"MenuController"}),e.when("/createversion",{templateUrl:"partials/createversion.html",controller:"CreateVersionController"}),e.when("/versions",{templateUrl:"partials/versions.html",controller:"VersionsController"}),e.when("/publishongallery",{templateUrl:"partials/publishongallery.html",controller:"PublishOnGalleryController"}),e.when("/boardname",{templateUrl:"partials/boardname.html",controller:"BoardNameController"}),e.when("/background",{templateUrl:"partials/background.html",controller:"BackgroundController"}),e.when("/changepwd",{templateUrl:"partials/changepwd.html",controller:"ChangePasswordController"}),e.when("/apimsg",{templateUrl:"partials/apimsg.html",controller:"APIMessageController"}),e.when("/teamsetup",{templateUrl:"partials/teamsetup.html",controller:"TeamSetupController"}),e.when("/team-add-members",{templateUrl:"partials/team-add-members.html",controller:"TeamSetupMembersController"}),e.when("/setup-part-of-org",{templateUrl:"partials/setup-part-of-org.html",controller:"SetupPartOfOrganizationController"}),e.when("/accept",{templateUrl:"partials/accept.html",controller:"AcceptController"}),e.when("/googledrive",{templateUrl:"partials/googledrive.html",controller:"GoogleDriveController"}),e.when("/hipchat",{templateUrl:"partials/hipchat.html",controller:"HipChatIntController"}),e.when("/hipchatshare",{templateUrl:"partials/hipchatshare.html",controller:"HipChatController"}),e.when("/presentation-edit",{templateUrl:"partials/presentation-edit.html",controller:"PresentationEditController"}),e.when("/boarddetails",{templateUrl:"partials/boardinfo.html",controller:"BoardInfoController"}),e.when("/switchteam",{templateUrl:"partials/switchteam.html",controller:"SwitchTeamController"}),e.when("/newteam",{templateUrl:"partials/newteam.html",controller:"NewTeamController"}),e.when("/presentation",{templateUrl:"partials/presentation.html",controller:"PresentationController"}),e.when("/tutorial",{templateUrl:"partials/tutorial.html",controller:"OnboardingController"})}]);"function"!=typeof String.prototype.startsWith&&(String.prototype.startsWith=function(e){return this.slice(0,e.length)==e}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(e){return this.slice(-e.length)==e}),window.downloadFile=function(e){var t=getScopeById("ExportCallback");t.$apply(function(){t.downloadFile(e)})},window.downloadFileSocketNotif=function(e){var t=getScopeById("ExportCallback");t.downloadFileSocketNotif(e)},window.messageSentToFlowdock=function(e){var t=getScopeById("FlowdockController");t.messageSentToFlowdock(e)},window.showIntro=function(){var e=getScopeById("TourController");e?e.$apply(function(){e.startTour()}):showHelp(!0)},window.showHelp=function(e){var t=getScopeById("GuideController");t&&(e?t.showIntro(!0):t.showIntro(!1),t.$digest())},window.analyticsTrackEvent=function(e,t,n){var o=getScopeById("AnalyticsController");o&&"function"==typeof o.trackEvent&&o.trackEvent(e,t,n)},window.ChatController=function(e,t,n){var o=getScopeById("ChatController");o[e](t,n)},window.isMenuOpen=function(){var e=appInjector().get("PopoverService");if(e&&e.isMenuOpen())return!0;var t=appInjector().get("AppStateService");return!(!t||!t.isDialogOpen())},window.currentUser=function(){try{var e=angular.element("body").injector(),t=e.get("AuthService");return t.currentUser()}catch(e){console.log("ERROR: currentUser retriaval failed")}return""},window.currentBoard=function(){try{var e=angular.element("body").injector(),t=e.get("AuthService");return t.currentBoard()}catch(e){console.log("ERROR: currentBoard retriaval failed")}return null},window.currentBoardFullId=function(){try{var e=angular.element("body").injector(),t=e.get("Helpers");return t.currentBoardFullId()}catch(e){console.log("ERROR: currentBoardFullId retriaval failed")}return null},window.copyToClipboard=function(){try{var e=angular.element("body").injector(),t=e.get("ClipboardService");return t.copyToClipboard(),!0}catch(e){console.log("ERROR: failed to copy data to clipboard: "+e)}return!1},window.pasteFromClipboard=function(){try{var e=angular.element("body").injector(),t=e.get("ClipboardService");t.pasteFromClipboard()}catch(e){console.log("ERROR: failed to paste from clipboard: "+e)}return""},window.ngShowLibrarySettings=function(){try{var e=angular.element("body").injector(),t=e.get("LibrarySettingsService");t.showLibrarySettings()}catch(e){console.error("ERROR: ngShowLibrarySetttings: "+e)}},window.ngHideLibrarySettings=function(){try{var e=angular.element("body").injector(),t=e.get("LibrarySettingsService");t.hideLibrarySettings()}catch(e){console.error("ERROR: ngHideLibrarySettings: "+e)}},window.ngShowImageLibrary=function(){try{var e=angular.element("body").injector(),t=e.get("ImageLibraryService");t.showImageLibrary()}catch(e){console.log("ERROR: ngShowImageLibrary: "+e)}},window.ngHideImageLibrary=function(){try{var e=angular.element("body").injector(),t=e.get("ImageLibraryService");t.hideImageLibrary()}catch(e){console.log("ERROR: hideImageLibrary: "+e)}},window.ngShowLibrary=function(e){try{var t=angular.element("body").injector(),n=t.get("LibraryShapeService");n.show(e)}catch(e){console.log("ERROR: ngShowTeamLibrary: "+e)}},window.ngHideLibrary=function(e){try{var t=angular.element("body").injector(),n=t.get("LibraryShapeService");n.hide(e)}catch(e){console.log("ERROR: ngHideTeamLibrary: "+e)}},window.ngLoadThumbnails=function(e,t){try{var n=angular.element("body").injector(),o=n.get("ImageService");o.loadThumbnails(e,t)}catch(e){console.log("ERROR: failed to load images: "+e)}},window.ngCopyLibraryFileToBoard=function(e){try{var t=getScopeById("FileUploadController");t.copyLibraryFileToBoard(e,gwtReceiveFileInfo)}catch(e){console.log("ERROR: ngCopyLibraryFileToBoard: "+e)}},window.ngStartUploadFile=function(e,t){try{var n=getScopeById("FileUploadController");n.startUploadFile(e,t)}catch(e){console.log("ERROR: ngStartUploadFile: "+e)}},window.removeCookie=function(e){var t=angular.element("[ng-app]");if("undefined"!=typeof t)try{var n=t.injector().get("$cookies");n.remove(e);var o=t.injector().get("$rootScope");o.$apply()}catch(e){console.log("removeCookie... failed",e)}},window._ng=function(){return angular.element("[ng-app]")},window.waterMark=function(e,t){var n=_ng(),o="";if(n){var r=n.injector().get("AuthService");r&&!r.currentBoard().isPaidBoard()&&(o="<text x='"+(e-15)+"' y='"+(t-15)+"' style='font-weight:Normal; font-size: 16px; text-anchor: end; font-family: Arial; fill: #ccc;'>http://sketchboard.io</text>")}return o},window.ngIsLibraryManualShowHide=function(e,t){var n=_ng();if(n){var o=n.injector().get("AuthService");if(o&&o.currentUser())return o.currentUser().isLibraryManualShowHide()}return!1},window.saveBoardShape=function(e,t){var n=_ng();if(n){var o=n.injector().get("ShapeService");o.saveBoardShape(e,t)}},window.quitPresentation=function(){globalStreams.quitPresentationStream.push()},window.editPresentation=function(){globalStreams.editPresentationStream.push()},window.presentationRealTimeNavigation=function(e){var t=_ng();if(t){var n=t.injector().get("PresentationService");n.presentationRealTimeNavigation(e)}},window.presentationRealTimeNavigation2=function(e){var t=_ng();if(t){var n=t.injector().get("PresentationService");n.presentationRealTimeNavigation2(e)}},window.presentationRealTimeApplyCmd=function(e){var t=_ng();if(t){var n=t.injector().get("PresentationService");n.presentationRealTimeApplyCmd(e)}},window.applyCommentOperation=function(e,t){var n=_ng();if(n){var o=n.injector().get("CommentsService");o.applyCommentOperation(e,t)}},window.clientReloadUsers=function(e){try{var t=_ng();if(t){var n=t.injector().get("BoardUsers");n.reloadUsers()}}catch(e){console.log("clientReloadUsers: ",e)}},window.ngGetBoardPositionFactory=function(){var e=_ng();return e?e.injector().get("BoardPositionFactory"):null},window.ack=function(e,t,n,o){"function"==typeof window.gwtack&&window.gwtack(e,t,n,o)},globalStreams.onboardingStream.filter(function(e){return e.steps_done}).onValue(function(){var e=_ng();if(e){var t=e.injector().get("TutorialHelpers");t&&t.showTutorialShare()}}),angular.module("myApp.controllers",["texts"]).controller("NotifyController",["$scope","NotifyService",function(e,t){e.state=t.getInfoState()}]).controller("MainController",["$scope","$rootScope","$window","$location","AuthService","PopoverService","Helpers","AppStateService","DeleteLegacyCookies","NotifyService","BoardPositionFactory","Comments2Factory",function(e,t,n,o,r,a,i,c,s,l,u,d){e.currentUser=r.currentUser(),e.currentBoard=r.currentBoard(),e.$watch(r.isLoggedIn,function(t){e.isLoggedIn=t}),e.$watch(r.currentUser,function(t){e.currentUser=t}),e.$watch(r.currentBoard,function(t){e.currentBoard=t}),s.doIt(),e.galleryUrl=_config.galleryUrl,e.goToGallery=function(){backend.getTeamId().then(function(t){e.$apply(function(){t?n.location.href=e.galleryUrl+"/team/"+t+"?s="+e.currentBoardId():n.location.href=e.galleryUrl})})},$("body").on("keyup",function(e){27===e.keyCode&&a.closeAllOpenPopovers()}),window.switchBoardStream.onValue(function(t){e.$apply(function(){n.location.href="/dashboard/"+e.currentUser.currentTeam.team_id})}),globalStreams.commentShortcutStream.onValue(function(){e.$apply(function(){"/comments2"===o.path()?o.path("/"):o.path("/comments2")})}),cancelStream.onValue(function(){globalState.cancelAddSlideMode()}),globalStreams.startPresentationShortcutStream.onValue(function(){e.$apply(function(){o.path("presentation")})}),globalStreams.presentationCommandStream.onValue(function(t){"play"===t.cmd&&"/presentation"!==o.path()?e.$apply(function(){o.path("/presentation").search({})}):"quit"===t.cmd&&"/presentation"===o.path()&&globalStreams.quitPresentationStream.push()}),globalStreams.editPresentationShortcutStream.onValue(function(){e.$apply(function(){"/presentation-edit"===o.path()?o.path("/"):o.path("/presentation-edit").search({})})}),globalStreams.boardInfoShortcutStream.onValue(function(){e.$apply(function(){"/boarddetails"===o.path()?o.path("/"):o.path("/boarddetails").search({})})}),globalStreams.switchTeamShortcutStream.onValue(function(){e.$apply(function(){"/switchteam"===o.path()?o.path("/"):o.path("/switchteam").search({})})}),globalStreams.newBoardShortcutStream.onValue(function(){e.$apply(function(){e.newBoard()})}),cancelStream.onValue(function(){"/comments2"!==o.path()&&e.$apply(function(){o.path("/").search({})})}),e.openBoard=function(e){n.location.href=e},e.billingUrl=function(){return e.currentUser.org_id?"/orgs/"+e.currentUser.org_id+"/bills":"#/billing"},e.newBoard=function(){ReqNewBoard()},e.goto=function(e){o.path(e).search({})},e.currentBoardLink=function(){return o.absUrl().split("#")[0]},e.isLoggedInAndFreeBoard=function(){return e.isLoggedIn&&e.currentBoard.isFree()},e.isLoggedInAndProBoard=function(){return e.isLoggedIn&&e.currentBoard.isPro()},e.isLoggedInAndProAndSharedWithPwBoard=function(){return e.isLoggedIn&&e.currentBoard.isPro()&&e.currentBoard.isPasswordProtected()},e.isLoggedInAndProAndNotSharedWithPwBoard=function(){return e.isLoggedIn&&e.currentBoard.isPro()&&!e.currentBoard.isPasswordProtected()},e.isVersion=function(){return i.isBoardVersion()},e.currentBoardId=function(){return i.currentBoardId()},e.currentBoardVersion=function(){return i.currentBoardVersion()},e.currentBoardFullId=function(){return i.currentBoardFullId()},e.isBlackTheme=function(){return"black"===themeName.value},e.showUpgradeButton=function(){return!e.currentUser.isAnonymous()&&e.currentBoard.isBoardAccountExpired()},e.isComments=function(){return d.commentThreads},e.upgradeCurrentTeam=function(){_track("upgrade",{category:"board",label:"subscription"}),n.location.href="/settings/"+e.currentUser.currentTeam.team_id+"/pricing"},e.upgradeCurrentTeamLink=function(){return e.currentUser.org_id?"/orgs/"+e.currentUser.org_id+"/subscribe/org-standard2-usd/month":"/settings/"+e.currentUser.currentTeam.team_id+"/pricing"},e.upgradeTeamToOrgLink=function(){return upgradeTeamToOrgLink()},e.showsUserMessage=!1,globalStreams.userMessagePropsStream.onValue(function(t){e.showsUserMessage=t>0,e.$digest()}),"undefined"!=typeof sketchboard_ng_page&&(e.sketchboardNgPage=sketchboard_ng_page),initialState.firstTeamLogin&&(initialState.setupDomain?o.path("/setup-organization").search({account_hash:initialState.account_hash}):initialState.setupPartOfOrganization?o.path("/setup-part-of-org").search({account_hash:initialState.account_hash}):o.path("/teamsetup").search({account_hash:initialState.account_hash})),e.slackLink=function(){return _appState.slackLink}}]).controller("MenuController",["$scope","$location","NotifyService",function(e,t,n){function o(){return!!e.currentBoard.isPaidBoard()||(n.info("Print is not supported on Free plan. You can download board as PNG."),!1)}e.done=!1,e.close=function(){e.done=!0,t.path("/")},e.print=function(e){o()&&(analyticsTrackEvent("Menu","Print",e),print(e))},e.teamId=function(){}}]).controller("BackgroundController",["$scope","$location",function(e,t){e.done=!1,e.close=function(){e.done=!0,t.path("/")}}]).controller("ChangePasswordController",["$scope","$location",function(e,t){e.done=!1,e.close=function(){e.done=!0,t.path("/")}}]).controller("LoginController",["$scope","$route","$window",function(e,t,n){e.user={},e.signIn=function(){backendLoginService.login(e.user).then(function(t){t&&(n.location.href="/"+e.currentBoard.boardId)})}}]).controller("AnalyticsController",["$scope",function(e){e.trackEvent=function(t,n,o){"undefined"!=typeof ga&&e.currentUser&&(ga("set","UserType",e.currentUser.userType),_trackGA(t,n,o))},"undefined"!=typeof boardLoadedStream&&"undefined"!=typeof initialState&&boardLoadedStream.onValue(function(){_track("updateBoard",{category:"user",label:"visit",userType:initialState.userType})})}]).controller("TourController",["$scope","$document",function(e,t){e.startTour=function(){t.trigger("start-tour"),e.toururl="partials/tour.html"},e.okGotIt=function(){t.trigger("end-tour")}}]).controller("TourSignUpController",["$scope","$document",function(e,t){e.startTour=function(){t.trigger("start-tour"),e.toururl="partials/toursignup.html"},e.okGotIt=function(){t.trigger("end-tour")}}]).controller("OnboardingController",["$scope","$location",function(e,t){function n(){t.path("/").search({})}e.skip=t.search().skip,e.share=t.search().share,e.skip&&globalStreams.onboardingStream.push({skip:!0}),e.skip&&setTimeout(function(){n(),e.$apply()},3e3),e.gotIt=function(){n()}}]).controller("GuideController",["$scope","Helpers","SettingsService",function(e,t,n){function o(t){e.guides=t,i=0,c=e.guides[i]}var r=["basics1","adddoubleclick","connect-helpers","click-connect","freehand","move-bg","markdown","map-view"],a=["basics1","adddoubleclick","connect-helpers","move-bg","markdown","map-view"],i=0,c="none";e.showTitle=!0,$(".tooltip-enabled").tooltip().on("click",function(){$(this).tooltip("hide")});var s=function(){++i},l=function(){i>0&&--i},u=function(){i<e.guides.length&&(c=e.guides[i],e.$broadcast("step-changed",i)),e.showBasics2()?e.basics2url="partials/guide/basics2.html":e.showColors()?e.colorsurl="partials/guide/colors.html":e.showAccounts()?e.accountsurl="partials/guide/accounts.html":e.showTextDecoration()?e.textdecorationurl="partials/guide/textdecoration.html":e.showShortcuts()?e.shortcutsurl="partials/guide/shortcuts.html":e.learnMore()?e.learnmoreurl="partials/guide/learnmore.html":e.addDoubleClick()?e.adddoubleclick="partials/guide/adddoubleclick.html":e.clickConnect()?e.clickconnect="partials/guide/click-connect.html":e.connectHelpers()?e.connecthelpers="partials/guide/connect-helpers.html":e.mapView()?e.mapview="partials/guide/map-view.html":e.moveBg()?e.movebg="partials/guide/move-bg.html":e.freehandGuide()?e.freehand="partials/guide/freehand.html":e.markdownGuide()&&(e.markdown="partials/guide/markdown.html");
};e.showNext=function(){s(),u()},e.done=function(){e.hideGuide(),n.showWelcomeGuideNextTime(!1)},e.showBasics1=function(){return"basics1"==c},e.showBasics2=function(){return"basics2"==c},e.showColors=function(){return"colors"==c},e.showAccounts=function(){return"accounts"==c},e.showTextDecoration=function(){return!1},e.showShortcuts=function(){return"shortcuts"==c},e.learnMore=function(){return"learnmore"==c},e.addDoubleClick=function(){return"adddoubleclick"==c},e.clickConnect=function(){return"click-connect"==c},e.connectHelpers=function(){return"connect-helpers"==c},e.mapView=function(){return"map-view"==c},e.moveBg=function(){return"move-bg"==c},e.freehandGuide=function(){return"freehand"==c},e.markdownGuide=function(){return"markdown"==c},e.showPrev=function(){l(),u()},e.prevActiveClass=function(){return 0==i?"disabled":""},e.lastGuide=function(){return!!e.guides&&i>=e.guides.length-1},e.showIntro=function(t){o(t?a:r),i=0,c=e.guides[i],e.show()}}]).controller("ProfileController",["$scope","$timeout","$location","Helpers","AuthService","AvatarUrl",function(e,t,n,o,r,a){e.newprofile={},e.timestamp=(new Date).getTime(),e.hidePage=function(){n.path("/")},e.updateImage=function(){backendProfileService.currentUserAvatarUrl().then(function(t){e.$apply(function(){e.currentUser.avatarUrl=t,e.timestamp=(new Date).getTime()}),_trackGA("UserProfile","Updated","Avatar")})},e.$watch(r.currentUser,function(t){_.extend(e.newprofile,t)}),globalStreams.currentUserStream.onValue(function(t){e.$apply(function(){_.extend(e.newprofile,t)})}),e.updateProfile=function(){backendProfileService.updateProfile(e.newprofile).then(function(n){e.$apply(function(){_.extend(e.currentUser,n),e.updated=!0,t(function(){e.updated=!1},4e3),_trackGA("UserProfile","Updated","BasicInfo")})})},e.avatarUrl=function(){return a.makeUrl(e.currentUser,200)},e.showing=!1,e.showDeleteAccount=function(){e.showing=!e.showing,e.showing&&backend.findMyAllAccountsByPrimaryOwner().then(function(t){t?e.$apply(function(){e.ownedAccounts=t}):e.deleteAccountFailed=!0})},e.deleteAccount=function(){confirm("Delete permanently team(s) and user account?")&&(e.deleting=!0,t(function(){window.location.reload()},15e3),backend.deleteAccount().then(function(e){window.location.reload()}))}}]).controller("FileUploadController",["$rootScope","$scope","$document","errormsg","NotifyService",function(e,t,n,o,r){function a(t,n,o){e.$broadcast("notificationStep",{state:"uploading"});var r=[{action:"loadImageMetaData",disableExif:!1},{action:"loadImage",fileTypes:/^image\/(gif|jpeg|png)$/,maxFileSize:5e6},{action:"resizeImage",maxWidth:1e3,maxHeight:1e3,orientation:!0},{action:"saveImage"}];n.processQueue=r,n.disableImageResize?n.submit():o(n)}function i(t,n,o){e.$broadcast("notificationStep",{state:"uploading"}),o(n)}t.clientX=0,t.clientY=0,globalStreams.contextMenuStream.filter(function(e){return e&&"upload"===e.type}).onValue(function(e){t.startUploadFile(e.x,e.y)}),globalStreams.contextMenuStream.filter(function(e){return e&&"add-image"===e.type}).onValue(function(e){t.copyLibraryFileToBoard(e.hash,e.handler)}),t.allowToUpload=function(e){var n=t.currentUser.currentTeam.notExpired;n||(t.$apply(function(){r.info("You need to be logged in and have upgraded team to add images.")}),globalStreams.userMessageEventStream.push(3));for(var o=0;o<e.originalFiles.length;++o){var a=e.originalFiles[o];if("image/gif"!=a.type&&"image/png"!=a.type&&"image/jpeg"!=a.type)return-1}return n?0:-2},t.uploadUrl=function(){return"/upload/image/"+t.currentBoard.boardId},t.fileUploadDropPosition=function(e,n){t.clientX=e,t.clientY=n},t.startUploadFile=function(n,o){function r(){e.$broadcast("notificationStart",{part:"partials/fileupload.html",state:"upload-mobile"})}t.clientX=n,t.clientY=o,t.$$phase?r():t.$apply(function(){r()})},t.fileUploadStart=function(){t.$apply(function(){e.$broadcast("notificationStart",{part:"partials/fileupload.html",state:"uploading",data:{downloads:[]}})})},t.confirmSize=function(n,o,r,c){r>5e6?a(n,o,c):t.$apply(function(){e.$broadcast("notificationStep",{state:"bigfile",callback:{yes:function(){a(n,o,c)},no:function(){i(n,o,c)}}})})},t.fileUploadFailed=function(n){var r=null,a=n.errorThrown.toLowerCase(),i="failed";"unauthorized"==a?r=o.fileTypeNotSupported:"not found"==a?(r="",i="failed-upgrade-img"):"precondition failed"==a?(r="",i="failed-upgrade-img"):"payload too large"==a&&1==n.files.length&&n.files[0].size>5e6?r=o.tooBigFile:"payload too large"==a&&(r=o.fileUploadFull),t.$apply(function(){e.$broadcast("notificationReady",{state:i,data:{msg:r}})})},t.fileUploaded=function(o){t.$apply(function(){e.$broadcast("notificationReady",{state:"success",data:{},hidesoon:!0}),n.trigger("add-img-lib",o.result),gwtCreateImage(o.result,t.clientX,t.clientY)})},t.copyLibraryFileToBoard=function(n,o){function a(){e.$broadcast("notificationStart",{part:"partials/fileupload.html",state:"copying",data:{downloads:[]}})}t.$$phase?a():t.$apply(function(){a()}),backendProfileService.copyLibraryFileToBoard({hash:n,boardId:t.currentBoard.boardId}).then(function(n){if(t.$apply(function(){e.$broadcast("notificationReady",{state:"copied",data:{},hidesoon:!0})}),n&&"string"!=typeof n&&"function"==typeof o)o(n);else if("string"==typeof n){var a="Sorry, failed to add image.";a=n,t.$apply(function(){r.info(a)})}})}}]).controller("AccountController",["$scope","$location","$filter","$window","Helpers","AuthService","AccountService","accountType","AvatarUrl",function(e,t,n,o,r,a,i,c,s){function l(){_.each(e.accounts,function(t){u[t.accountHash]={},t.defaultAccount&&(e.defaultAccount=t.accountHash)})}e.accounts=[],e.defaultAccount="",e.newAccountName={};var u={},d=(new Date).getTime();e.formatPlan=function(e){if(_.isUndefined(e.plan))return e.expired?n("formatFreePlan")():n("formatAccountType")(e.accountType,"");var t="";if(e.subscription_info){var o=i.findIntervalByIntervalId(e.subscription_info.interval_id);t=o?" "+o.name:" DEV-"+e.subscription_info.interval_id}return n("formatPlan")(e.plan.name+t,"")},e.currentAccounts=function(t){return _.filter(t,function(t){return t.teamId===e.currentUser.currentTeam.team_id})},e.isFreeAccount=function(e){return e.accountType<=1},e.loadAccounts=function(){backend.load().then(function(t){e.$apply(function(){void 0!==t?(d=(new Date).getTime(),e.accounts=t,l()):(e.accounts=[],u={})})})},e.avatarUrl=function(e,t){return s.makeUrl(e,t)},e.accountName=function(e){var t=e.name;return e.expired&&(t+=" -- expired"),t},e.showRename=function(t){e.newAccountName.name=t.name,e.toggle(t)},e.changeAccountName=function(t){var n=_.omit(t,"users");n.name=e.newAccountName.name,backend.changeAccountName(n).then(function(n){e.$apply(function(){n&&(t.name=n,e.newAccountName.name="",e.toggle(t),e.currentUser.currentTeam.team_name=t.name,_trackGA("Account","changeAccountName"))})})},e.timeLeft=function(e){return i.timeLeft(e)},e.showBuyButton=function(e){if(e.org)return!1;var t=e.iamAdmin&&e.accountType<c.business;return t||!e.validSubscription},e.showManageSubscription=function(e){return!e.org&&("undefined"!=typeof e.plan&&e.iamAdmin||e.validSubscription&&e.iamAdmin)},e.upgradeAccount=function(e){$("#modal").modal("hide"),o.location.href="/settings/"+e.teamId+"/pricing"},e.canRemove=function(e,t){return(0==t.role||2==t.role||3==t.role)&&e.iamAdmin},e.removeAccountUser=function(t,n){confirm("Confirm to delete user from the team")&&backend.removeAccountUser({accountHash:t.accountHash,email:n.email,boardId:e.currentBoard.boardId}).then(function(o){e.$apply(function(){t.users=_.filter(t.users,function(e){return!_.isEqual(e,n)})})})},e.toggle=function(t){r.toggle(e,t.accountHash)},e.newuser=function(e){return u[e]},e.addUser=function(t){u[t].accountHash=t;var n=u[t];n.boardId=e.currentBoard.boardId,e.submitting=!0,backend.addUser(n).then(function(n){e.submitting=!1,_.isObject(n)?(e.$apply(function(){var o=_.find(e.accounts,function(e){return e.accountHash==t});if(o){var r=_.find(o.users,function(e){return e.email==n.email});r||o.users.push(n)}u[t]={}}),_trackGA("Account","addUser")):_.isString(n)?e.$apply(function(){e.msg="Please, check the email address, use another email address or contact <a href='mailto:support@sketchboard.io'>support</a> for help."}):e.$apply(function(){e.msg="Maximum number of users reached. <a href='/settings/"+e.currentUser.currentTeam.team_id+"/pricing'>Upgrade plan</a> to add more users."})})},e.stateLeaveTeam=!1,e.showLeaveTeam=function(){e.stateLeaveTeam=!e.stateLeaveTeam},e.leaveTeam=function(){backend.leaveTeam({team_id:e.currentUser.currentTeam.team_id}).then(function(t){t?o.location.href="/":e.failureLeaveTeam=!0,e.$digest()})};var f=[];e.accountRoles=[],e.currentUser.currentTeam.org?e.accountRoles=[{value:"",name:"pick new role",id:-1},{value:"rw",name:"member",id:0},{value:"ro",name:"read-only member",id:2},{value:"admin",name:"admin",id:3}]:e.accountRoles=[{value:"",name:"pick new role",id:-1},{value:"rw",name:"member",id:0},{value:"admin",name:"admin",id:3}];var p=e.accountRoles[0].id;e.selectedRole={id:p},e.showEditRole=function(t,n){return!r.isPrimaryOwner(n)&&(t.iamAdmin&&!e.showEditRoleEditor(n))},e.showEditRoleEditor=function(e){return f[e.email]},e.editRole=function(e){f[e.email]=!0},e.changeRole=function(t){e.selectedRole.id!=-1&&backend.changeAccountUserRole({user:t.email,role:e.selectedRole.id,team_id:e.currentUser.currentTeam.team_id}).then(function(n){n?(e.loadAccounts(),e.failedToUpdateUserRole=!1):e.failedToUpdateUserRole=!0,f[t.email]=!1,e.selectedRole.id=p,e.$digest()})},e.acceptAccount=function(t){backend.acceptAccount(_.omit(t,"users")).then(function(n){e.$apply(function(){var o=_.find(n.users,function(t){return t.email===e.currentUser.email}),r=_.find(t.users,function(t){return t.email===e.currentUser.email});_.extend(r,o)}),_trackGA("Account","acceptAccount")})},e.loadAccounts()}]).controller("IntegrationsController2",["$scope",function(e){}]).controller("IntegrationsController",["$scope","IntegrationsService","Helpers",function(e,t,n){e.accounts=[],e.selectedAccount={name:""},e.newFlow={eventTypes:!0},e.loadAccounts=function(){backendIntegrations.listAccountsWhereUserIsAdmin().then(function(n){e.$apply(function(){void 0!==n&&(e.accounts=n,e.selectedAccount=t.selectAccount(e.accounts),e.selectedAccount&&backendIntegrations.listFlowsForAccount(e.selectedAccount).then(function(t){e.$apply(function(){e.flows=t})}))})})},e.showFlowForm=function(){n.toggle(e,"show-flow-form")},e.addFlow=function(){e.newFlow.accountHash=e.selectedAccount.accountHash,e.newFlow.eventTypes=e.newFlow.eventTypes?1:0,backendIntegrations.addFlowToAccount(e.newFlow).then(function(t){e.$apply(function(){e.newFlow={eventTypes:!0},e.flows=t,e.$broadcast("flow-added")}),_trackGA("Flowdock","AddFlow")})},e.removeFlow=function(t){backendIntegrations.removeFlow(t.flowHash).then(function(t){e.$apply(function(){_.isArray(t)&&(e.flows=t)})})},e.eventTypes=function(e){return 1===e.eventTypes},e.loadAccounts()}]).controller("FlowdockController",["$rootScope","$scope","IntegrationsService","Helpers","NotifyService",function(e,t,n,o,r){function a(){t.flowsend={subject:t.currentBoard.name+" | Sketchboard"}}t.state="",a(),backendIntegrations.listFlowsForBoard(t.currentBoard.boardId).then(function(e){t.$apply(function(){t.flows=e,_.isArray(e)&&e.length>0?(t.flowsend.flowHash=_.first(t.flows).flowHash,t.state="flows-exist"):t.state="no-flows"})}),t.sendToFlow=function(){e.$broadcast("notificationStart",{state:"sending",part:"partials/sendtoflowdock.html"}),t.$broadcast("flow-hide");var n=getBoardSvg();t.flowsend.svg=n.svg,t.flowsend.boardId=n.boardId,flowdockIntegration(t.flowsend),_trackGA("Flowdock","Send")},t.messageSentToFlowdock=function(n){t.$apply(function(){"success"===n?(e.$broadcast("notificationReady",{state:"ready",hidesoonish:!0}),r.info("Board is sent to Flowdock."),_trackGA("Flowdock","Send","Success")):(e.$broadcast("notificationReady",{state:"failed",hidesoonish:!0}),r.info("Sorry, send to Flowdock failed"),_trackGA("Flowdock","Send","Failed")),a()})}}]).controller("HipChatAuthController",["$scope","$window","$timeout",function(e,t,n){e.authorize=function(){e.authorizing||(e.authorizing=!0,n(function(){backendIntegrations.oauthHipChat({board_id:e.currentBoard.boardId}).then(function(n){e.$apply(function(){n?t.location.href=n:(e.authorizing=!1,e.failed=!0)})})},200))}}]).controller("SlackController",["$rootScope","$scope","$location","$timeout","$window",function(e,t,n,o,r){function a(e){t.fetchChannels=!0,backendIntegrations.loadSlackChannels({board_id:t.currentBoard.boardId,sid:e}).then(function(e){switch(t.fetchChannels=!1,e.ok){case 0:t.channels=e.channels,e.createdFromChannel?t.selectedChannelName=e.createdFromChannel:e.channels.length>0&&(t.selectedChannelName=e.channels[0].name),t.notifyChannel=!0,t.notifyText=e.notify_text,t.$broadcast("channels-loaded");break;case-2:t.failedTokenRevoked=!0;break;case-3:t.failedAccountInactive=!0;break;default:t.failedToLoadChannels=!0}t.$digest()})}if(t.currentBoard){e.$on("slack-uploaded",function(n,r){t.$apply(function(){t.sending=!1,r.data.ok?(t.sent=!0,o(function(){e.$broadcast("slack-hide")},4e3)):(t.failed=!0,t.error=r.data.error)})});var i=[];"function"==typeof gwtGetSeletedShapeIds&&(i=gwtGetSeletedShapeIds()),t.snapshotSelectedShapes=i.length>0,t.sendSlackMessage=function(){if(!t.sending){t.failed=!1,t.error="",t.sending=!0,t.notifyChannel||(t.notifyText="");var e={board_id:t.currentBoard.boardId,sid:t.selectedSlackTeamSid,msg:t.msg,channel:t.selectedChannelName,notify_text:t.notifyText,event:"slack-uploaded",sketchboard_ng_page:t.sketchboardNgPage};t.snapshotSelectedShapes&&i.length>0&&(e.client_ids=i),backendIntegrations.sendSlackMessage(e).then(function(e){e||t.$apply(function(){t.failed=!0})})}},t.sketchHistory=function(){return t.currentUser.currentTeam&&_initialBoard?"/settings/"+t.currentUser.team_id+"/sketch-history/"+_initialBoard.boardId:""},t.slackTeamChanged=function(){t.isUserAuthorizedForTeam(t.selectedSlackTeamSid)?a(t.selectedSlackTeamSid):n.path("/slackauth")},t.isUserAuthorizedForTeam=function(e){if(!t.slackTeams)return!1;var n=0;for(n=0;n<t.slackTeams.length;++n)if(t.slackTeams[n].sid===e)return t.slackTeams[n].userAuthorized;return!1},backendIntegrations.loadSlackTeams({board_id:t.currentBoard.boardId}).then(function(e){switch(e.ok){case 0:if(e.slackTeams.length>0){t.slackTeams=e.slackTeams;var n=_.filter(t.slackTeams,function(e){return e.userAuthorized});n.length>0&&(t.selectedSlackTeamSid=n[0].sid,a(t.selectedSlackTeamSid))}break;default:t.failedToLoadChannels=!0}t.$digest()})}}]).controller("ThreadReplyController",["$scope","CommentPositionFactory",function(e,t){e.$event=t.replyThreadParams.event}]).controller("BoardCommentsController",["$rootScope","$scope","$location","$timeout","Comments2Factory","CommentPositionFactory","BoardUsers","MentionsEditor",function(e,t,n,o,r,a,i,c){function s(e){t.$broadcast("changed."+e.threadid,e)}function l(){a.resetAllocations(),t.commentThreads&&t.commentThreads.forEach(function(e){e.shape_ids&&e.shape_ids.length>0&&(e.dimension=gwtGetShapesDimension(e.shape_ids),s(e))})}function u(e){var n=gwtGetJsItems();t.commentThreads=_.filter(e,function(e){var t=_.filter(n,function(t){return _.filter(e.shape_ids,function(e){return t.clientId===e}).length>0});return!e.resolved&&t.length>0&&e.shape_ids&&e.shape_ids.length>0}),l()}function d(){t.commentThreads&&t.commentThreads.forEach(function(e){t.$broadcast("hide."+e.threadid,e)})}function f(){t.$apply(function(){t.commentThreads=r.commentThreads,u(r.commentThreads)})}t.markdown=function(e){return e?marked(e):""},t.resolveThread=function(e,t){r.postUpdateThreadResolveStatus(t.threadid,!0)},t.editMode=!1,t.submitReplyForm=function(e){var n=e.threadid;r.postSaveComment(t.newReply,e,t.selectedShapeIds,function(e){switch(e){case 0:break;case-1:t.infoPlanRestriction=!0;break;case-2:t.failedToCreateComment=!0}t.thread=null,t.selectedShapeIds=null,t.$broadcast("hide-reply-thread."+n),t.$digest()})},t.shouldEnableCommentMenu=function(e,t){return!r.isSystemOrOthersOwn(t)},t.showOptions=function(e,n,o){r.isSystemComment(n)||(t.showCommentOptions=!0,t.currentCommentScope={targetEvent:e,comment:n,thread:o},t.$broadcast("open-comment-options-menu",{targetEvent:e,comment:n,thread:o}))},t.submitUpdateForm=function(e,n){var o={commentEdited:t.editedComment,comment:e,thread:n};t.editMode=!1,r.postUpdateComment(o,function(){})},t.cancelEditComment=function(e){t.editMode=!1,t.$broadcast("cancel-edit-"+e.id)},t.cancelReplyThread=function(e){t.$broadcast("hide-reply-thread."+e.threadid)},t.editComment=function(e){t.editMode||(t.editMode=!0,t.editedComment=t.currentCommentScope.comment.comment_text,t.$broadcast("bedit-"+t.currentCommentScope.comment.id))},t.deleteComment=function(){r.removeComment(t.currentCommentScope,function(e){t.$apply(function(){t.failedToDeleteComment=!e})})},t.replyThread=function(e,n){t.thread=n,t.selectedShapeIds=null,t.newReply="",t.$broadcast("breply-"+n.threadid)},t.avatarUrl=function(e){return i.avatarUrl(e)},t.minimizeThread=function(e){t.$broadcast("minimize."+e.threadid,e)},t.openThread=function(n){t.editMode=!1,r.openThread(n,!0),t.infoPlanRestriction=!1,t.failedToCreateComment=!1,e.$broadcast("open."+n.threadid)},globalStreams.shapeDragStream.onValue(function(e){"start"===e.type?d():"end"===e.type&&l()}),globalStreams.freehandStream.onValue(function(e){e?d():l()}),globalStreams.applyOperationsStream.onValue(function(e){globalStreams.isBoardLoaded()&&l()}),e.$on("do.comment.create",function(e,n){t.$apply(function(){u(r.commentThreads),o(function(){t.$broadcast("scrollToBottom."+n.thread.threadid),t.$broadcast("new.comment."+n.thread.threadid,n)})})}),e.$on("do.comment.update",function(e,t){f()}),e.$on("do.comment.update.switch.shapes",function(e,t){f()}),e.$on("do.comment.delete",function(e,t){f()}),e.$on("do.thread.resolve",function(e,n){n.thread.resolved?t.$broadcast("thread.resolved.animate."+n.thread.threadid,{thread:n.thread,done:function(){f()}}):f()});var p=".board-comments";t.$on(r.constCommentsLoaded+p,function(){switch(r.loadResult){case 0:u(r.commentThreads);break;case-1:t.failedToLoadThreads=!0}t.$digest()}),globalStreams.boardLoadedWrapStream.onValue(function(){r.loadCommentThreads(p)})}]).controller("CreateCommentController",["$rootScope","$scope","Comments2Factory","NotifyService","MentionsEditor",function(e,t,n,o,r){t.newComment="",globalStreams.contextMenuStream.filter(function(e){return e&&"comment.create"===e.type}).onValue(function(o){t.mentionsVisible=!1;var r=n.getSelectedShapes();t.newComment=r.selectedText,t.selectedShapeIds=r.selectedShapeIds,t.thread=null,e.$broadcast("create-comment-thread",o.element),t.$digest()}),t.cancelCreateComment=function(){t.$broadcast("hide-create-thread")},t.closeIfEmpty=function(){""==t.newComment&&t.cancelCreateComment()};var a=!1;t.submitComment=function(){function e(){t.newComment="",t.thread=null,t.selectedShapeIds=null,t.$broadcast("hide-create-thread"),a=!1}function r(){t.cancelCreateComment(),a=!1}function i(n){switch(a=!1,n){case 0:e();break;case-1:e(),o.info("The free plan includes max 500 comments to be created altogether within the team."),t.$digest();break;default:o.info("Sorry failed to save comment. Note that board needs be owned before it can be commented."),t.$digest()}}a||(a=!0,n.postSaveComment(t.newComment,t.thread,t.selectedShapeIds,i,r))}}]).controller("MentionPopupController",["$rootScope","$scope","MentionsEditor",function(e,t,n){var o="open-mentions-selector";n.init(t),t.addMention=function(e){n.addMention(e.mention,o)},t.mentionsHighlightUpdated=function(){t.mentionSelectedIndex=n.getSelectionIndex(),t.$$phase||t.$digest()},e.$on(o,function(){t.mentionSelectedIndex=n.getSelectionIndex(),t.mentions=n.getMentions()})}]).controller("MentionPopupBoardController",["$rootScope","$scope","MentionsEditor",function(e,t,n){var o="open-mentions-selector-1";t.addMention=function(e){n.addMention(e.mention,o)},t.mentionsHighlightUpdated=function(){t.mentionSelectedIndex=n.getSelectionIndex(),t.$$phase||t.$digest()},e.$on(o,function(){t.mentionSelectedIndex=n.getSelectionIndex(),t.mentions=n.getMentions()})}]).controller("Comments2Controller",["$rootScope","$scope","$location","$timeout","$filter","Comments2Factory","BoardUsers","NotifyService","MentionsEditor",function(e,t,n,o,r,a,i,c,s){function l(){t.$apply(function(){t.commentThreads=a.commentThreads})}function u(e){t.$apply(function(){switch(e){case 0:t.$broadcast("do-auto-resize");break;case-1:t.infoPlanRestriction=!0;break;case-2:t.failedToCreateComment=!0}t.newReply=""})}function d(){n.search().tid&&""!==n.search().tid?t.replyThreadId=n.search().tid:t.replyThreadId=null}t.getComments=function(e){var t=e.comments;return!e.showAll&&e.comments.length>3&&(t=e.comments.slice(0,1).concat(e.comments.slice(-3))),t},t.threadLimit=5,t.loadMoreThreads=function(){t.threadLimit+=5},t.showAllComments=function(e){e.showAll=!0},t.createdBy=function(e){return r("createdBy")(e)},t.statusMessage=function(e){return r("statusMessage")(e)},t.simplifyDate=function(e){return r("simplifyDate")(e)},t.avatarUrl=function(e){return i.avatarUrl(e)},t.markdown=function(e){return e?marked(e):""},t.openThreadMenu=function(e,n,o){t.isSystemComment(n)||t.$broadcast("open-thread-menu",{targetEvent:e,comment:n,thread:o})},t.toggleNewComment=function(){t.$broadcast("show-new-comment")},t.setting={showCommentsPublicly:t.currentBoard.isShowCommentsPublicly()},t.toggleCommentSettings=function(){t.$broadcast("show-comment-settings")},t.saveShowCommentsPublicly=function(){t.setting.showCommentsPublicly=!t.setting.showCommentsPublicly,getBoardService().saveShowCommentsPublicly({board_id:t.currentBoard.boardId,team_id:t.currentUser.currentTeam.team_id,show_comments:t.setting.showCommentsPublicly}).then(function(e){console.log("saveShowCommentsPublicly:",e),t.setting.showCommentsPublicly=e.show_comments,t.$digest()})},t.hideComments=function(){n.path("/")},t.showCallback=function(){},t.toggleNewReplyButtons=function(e){e.newReply="",t.$broadcast("toggle-reply-buttons")},t.hideCommentEdit=function(e){t.$broadcast(e)},t.editComment=function(e){t.$broadcast("edit-"+e.comment.id,e)},t.isSystemOrOthersOwn=function(e){return a.isSystemOrOthersOwn(e)},t.isSystemComment=function(e){return a.isSystemComment(e)},t.shouldDisableCommentMenu=function(e,t){return a.shouldDisableCommentMenu(e,t)},t.deleteComment=function(e){a.removeComment(e,function(e){t.$apply(function(){t.failedToDeleteComment=!e})})},t.updateComment=function(e){a.postUpdateComment(e,function(e){t.$apply(function(){t.failedToUpdateComment=!e})})},t.replyThread=function(e){e.forceShowReplies=!0,t.$broadcast(e.threadid)},t.resolveThread=function(e){a.postUpdateThreadResolveStatus(e.threadid,!0)},t.reopenThread=function(e){a.postUpdateThreadResolveStatus(e.threadid,!1)},t.showReplies=function(e){e.forceShowReplies=!e.forceShowReplies},e.$on("do.comment.create",function(e,t){l()}),e.$on("do.comment.update.switch.shapes",function(e,t){l()}),e.$on("do.comment.update",function(e,n){l(),t.$broadcast("hide-comment-edit")}),e.$on("do.comment.delete",function(e,t){l()}),e.$on("do.thread.resolve",function(e,t){l()}),t.replyPlaceholder=function(e){return e.resolved?"Reply re-opens thread...":"Reply..."},t.saveReply=function(e){var t=e.newReply;e.newReply=null,a.postSaveComment(t,e,null,u)},t.saveThreadFirstComment=function(){t.toggleNewComment(),a.postSaveComment(t.newComment,null,t.selectedShapeIds,u),t.selectedShapeIds=null,t.newComment=""},t.topicClicked=function(e,t){t.topic&&e.shape_ids&&e.shape_ids.length>0&&gwtSelectShapes(e.shape_ids,!0,!1)},t.isTopicAndHasShapeIds=function(e,t){return t.topic&&e.shape_ids&&e.shape_ids.length>0},t.topicTitleWithShapes=function(e,n){return t.isTopicAndHasShapeIds(e,n)?"Select commented shapes":""};var f=".comments2";t.$on(a.constCommentsLoaded+f,function(){switch(a.loadResult){case 0:d(),t.commentThreads=a.commentThreads;break;case-1:t.failedToLoadThreads=!0}t.$digest()}),globalStreams.boardLoadedWrapStream.onValue(function(){a.loadCommentThreads(f)}),n.search().create&&o(function(){t.toggleNewComment()}),t.$on("$destroy",function(){t.saveThreadFirstComment(),t.$broadcast("main-comments-closed")})}]).controller("CommentsController",["$scope","elementType",function(e,t){e.firstCommentUser=function(e){return e.length>0?e[0].cbyd:""},e.reopen=function(t){backendComments.reopen({boardId:e.currentBoard.boardId,threadCid:t.clientId,clientIdentifier:gwtClientIdentifier(),siteId:gwtGetSiteId()}).then(function(n){e.$apply(function(){t.r=null})})},publicBackendComments.boardComments(e.currentBoard.boardId).then(function(n){e.$apply(function(){var o=_.groupBy(n,function(e){return e.elementType}),r=o[t.commentThread],a=o[t.comment],i=_.groupBy(a,function(e){return e.p});e.threads=_.map(r,function(e){return e.comments=i[e.clientId],e})})})}]).controller("LibImgController",["$scope","$document",function(e,t){function n(){e.images=[],e.offset=0,e.max=40}function o(){0==e.images.length&&(e.state=e.states.empty)}function r(){"undefined"!=typeof backendProfileService&&backendProfileService.loadThumbnails({boardId:e.currentBoard.boardId,team_id:e.currentUser.currentTeam.team_id,offset:e.offset,max:e.max}).then(function(t){e.$apply(function(){_.each(t,function(t){e.images.push(t)}),e.state=e.states.loaded,o()})})}e.states={init:1,deleting:2,deleted:3,failed:4,empty:5,loaded:6,notallowed:7},e.state=e.states.init,n(),"undefined"==typeof backendProfileService&&(e.state=e.states.notallowed),r(),e.loadMoreImages=function(){e.offset+=e.max,r()},e.markItem=function(e){e.selected?e.selected=!1:e.selected=!0},e.deleteImages=function(){var n=_.chain(e.images).filter(function(e){return e.selected}).pluck("hash").value();e.state=e.states.deleting,backendProfileService.deleteFromLibrary(n).then(function(r){e.$apply(function(){r?(e.state=e.states.deleted,e.images=_.filter(e.images,function(e){return!e.selected}),o(),t.trigger("del-img-lib",{deleted:n}),"function"==typeof gwtLoadedImagesReset&&gwtLoadedImagesReset(e.images)):e.state=e.states.failed})})}}]).controller("ShapeLibraryController",["$scope","NotifyService","ShapeService","ShapeInfo","contextMenuFillColor",function(e,t,n,o,r){function a(){0==e.shapes.length?e.state=e.states.empty:e.state=e.states.loaded}e.states={init:1,loaded:2,empty:3,notallowed:4},e.state=e.states.init,e.offset=0,e.max=50,e.shapes=[];var i=37;e.getProxyName=function(){return"shape"},e.setLibrary=function(t){e.libraryName=t},e.sectionStyle=function(){return"black"===themeName.value?"background: rgba(241, 239, 239, 0.2)":""},themeChangedStream.onValue(function(t){e.$digest()}),e.getShapeLibraryTemplatePath=function(){return"partials/shapelibrary.html"};var c=i,s=i-6;e.shapeWidth=function(e){return c},e.shapeHeight=function(e){return c},e.shapeStyle2=function(e){var t=i/e.w,n=i/e.h,o=t>n?t:n,r="min-width:"+parseInt(o*e.w)+"px;min-height:"+parseInt(o*e.h)+"px;";return r},e.transform=function(e,t){return n.transformCenter(c,s,e,t)},e.shapeStyle=function(e,t){var o="black"===themeName.value?r:null;return n.shapeStyle(e,o,t)},e.loadShapes=function(){"undefined"!=typeof libraryService?libraryService.loadShapes({library_name:e.libraryName,board_id:e.currentBoard.boardId,shape_type:tsCurrentSketchMode(),offset:e.offset,max:e.max}).then(function(t){_.each(t,function(t){__updateGradients__(t),e.shapes.push(t)}),e.state=e.states.loaded,a(),e.$digest()}):e.state=e.states.notallowed},e.loadMoreShapes=function(){e.offset+=e.max,e.loadShapes()},e.addShape=function(e,t,r){_.extend(e,o.prototype),n.saveBoardShape(e,function(){gwtAddShape(e,t,r)})},globalStreams.notifyStream.onValue(function(n){e.$apply(function(){t.info(n)})})}]).controller("LibrarySettingsController",["$scope","AuthService",function(e,t){function n(n){n.ok?e.$apply(function(){e.currentUser.properties=n.properties,t.currentUser().properties=n.properties,e.settingLibraryAutomaticShowHide=!e.currentUser.isLibraryManualShowHide()}):e.failed=!0}e.settingLibraryAutomaticShowHide=!t.currentUser().isLibraryManualShowHide(),e.getTemplatePath=function(){return"partials/librarysettings.html"},e.saveAutomaticShowHide=function(){e.settingLibraryAutomaticShowHide?backendAuthService.enableLibraryManualShowHide().then(function(e){n(e)}):backendAuthService.disableLibraryManualShowHide().then(function(e){n(e)})}}]).controller("ImageLibraryController",["$scope","$log","NotifyService",function(e,t,n){function o(t){e.modifyClass="img-lib-theme-"+t}function r(){0==e.images.length?e.state=e.states.empty:e.state=e.states.loaded}e.states={init:1,loaded:2,empty:3,notallowed:4},e.state=e.states.init,e.offset=0,e.max=30,e.images=[],e.modifyClass="",e.getProxyName=function(){return"img"},o(themeName.value),newLibraryImageStream.onValue(function(t){e.images.unshift(t),r()}),deleteLibraryImageStream.onValue(function(t){e.images=_.reject(e.images,function(e){return _.contains(t,e.hash)}),e.loadMoreImages()}),themeChangedStream.onValue(function(t){e.$apply(function(){o(t)})}),e.getImageLibraryTemplatePath=function(){return"partials/imagelibrary.html"},e.loadImages=function(){"undefined"!=typeof backendProfileService?backendProfileService.loadThumbnails({boardId:e.currentBoard.boardId,team_id:e.currentUser.currentTeam.team_id,offset:e.offset,max:e.max}).then(function(t){e.$apply(function(){_.each(t,function(t){e.images.push(t)}),e.images=_.uniq(e.images,function(e){return e.hash}),e.state=e.states.loaded,r()})}):e.state=e.states.notallowed},e.loadMoreImages=function(){e.offset+=e.max,e.loadImages()},e.addImage=function(t,o,r){e.currentUser.currentTeam.notExpired&&backendProfileService.copyLibraryFileToBoard({hash:t.hash,boardId:e.currentBoard.boardId}).then(function(t){if(t&&"function"==typeof gwtCreateImage)gwtCreateImage(t,o,r);else if("string"==typeof t){var a=t;e.$apply(function(){n.info(a)})}})}}]).controller("SendEditEmailController",["$rootScope","$scope","$location","$timeout","$sce","$sanitize","$compile","BrowserService","NotifyService","sharemenu",function(e,t,n,o,r,a,i,c,s,l){function u(){var e=_.map(t.emails,function(e){var t=e.replace(/\'/g,"\\'");return'<div class="tokens-token" contenteditable="false"><span class="token" email-addr>'+e+'</span><span contenteditable="false" class="icon-cross" ng-click="removeEmail(\''+t+"')\"></span></div>&ensp;"}).join("");t.items=e}function d(e){var n=t.candidateText();"undefined"!=typeof e&&(n=e),n.match(v)?(t.clearText(),t.emails.push(n),u(),t.errormsg=""):""!=n&&(t.errormsg="check your email addresses")}function f(n){n?(t.close(),s.info("Email is sent to "+t.emails.join(", ")+". "+t.additionalMsg),e.$broadcast("")):s.info("Sorry, email sending failed.")}function p(){backendProfileService.sendEmail({emails:t.emails,boardId:t.currentBoard.boardId,customBoardName:t.customBoardName,customMessage:t.customMessage}).then(function(e){t.$apply(function(){f(e)})})}function m(){t.page="share"}function h(e){var n=t.emails;e&&(t.account=e,n=_.filter(t.emails,function(t){return!_.find(e.users,function(e){return e.email==t})})),t.usersNotInAccount=n.join(", "),e.iamAdmin&&n.length>0&&(t.privateboardAndNotInAccount=!0),t.providePassword=!t.currentBoard.isPasswordProtected(),t.currentBoard.isPasswordProtected()||0==n.length?t.currentBoard.isPrivate()&&0==n.length?getBoardService().publishOrPrivate(t.currentBoard).then(function(e){t.$apply(function(){t.currentBoard.visibility=e.visibility,t.additionalMsg=l.sharedWithAccount,p()})}):(t.currentBoard.isPasswordProtected()&&n.length>0&&(t.additionalMsg=l.rememberSharePassword),p()):m()}function g(){h(t.account)}var v="^[^@ \t,]+@([^@ \t,.]+\\.)+[a-z]{2,4}$";t.boardUrl=n.protocol()+"://"+n.host()+"/"+t.currentBoard.boardId,t.emails=[],t.items="",t.errormsg="",t.customMessage="",t.customBoardName=t.currentBoard.name,t.done=!1,t.page="email",t.additionalMsg="",t.accountEmails=[],t.account=null,t.additionalMsg="",c.supportContentEditablePlainText()?t.plainOrEnabled="plaintext-only":t.plainOrEnabled="true",backend.accountUsersForBoard({
boardId:t.currentBoard.boardId}).then(function(e){t.account=e,t.$apply(function(){_.each(e.users,function(e){t.accountEmails.push(e.email)})})}),t.removeEmail=function(e){t.emails=_.without(t.emails,e),u()},t.changed=function(e){var n=_.chain(e).filter(function(e){return 3!=e.nodeType&&e.firstChild&&e.firstChild.attributes&&e.firstChild.attributes.getNamedItem("email-addr")}).map(function(e){return angular.element(e.firstChild).text()}).value();t.emails=n},t.completeToken=function(e,t){d()},t.completeSelectedToken=function(e){d(e)},t.showPassword=function(){t.page="password",o(function(){t.$broadcast("focus-password")})},t.setPassword=function(){getBoardService().setBoardPassword(t.password).then(function(e){t.$apply(function(){"failed"===e?s.info("Sorry, password change failed"):(_.extend(t.currentBoard,e.boardInfo),s.info(e.msg),t.additionalMsg=l.rememberSharePassword,p())})})},t.addEmailUsers=function(){if(t.account){var e=_.map(t.emails,function(e){return{accountHash:t.account.accountHash,email:e}});backend.addUsersAndChangeBoardVisibility({boardId:t.currentBoard.boardId,users:e}).then(function(e){t.$apply(function(){e?(t.currentBoard.visibility=e.board.visibility,t.additionalMsg=l.sharedWithAccount,p()):s.info("Sorry, couldn't add users to the account.")})})}},cancelStream.onValue(function(){t.$apply(function(){t.close()})}),t.close=function(){t.done=!0,n.path("/"),t.hidePopovers()},t.justSend=function(){p()},t.sendEmail=function(){d();var e=t.candidateText();t.emails.length>0&&0==e.length?(t.errormsg="",g()):t.errormsg="check your email addresses"}}]).controller("TeamsController",["$scope","$location","$window","Helpers",function(e,t,n,o){e.upgradeCurrentTeam()}]).controller("PlansController",["$scope","$location","$window","$sce","AccountService","Helpers","SubscriptionInfo","PlanFactory",function(e,t,n,o,r,a,i,c){e.upgradeCurrentTeam()}]).controller("PaymentController",["$scope","$location","$window","AccountService","Helpers","TaxFactory","AuthService","SubscriptionInfo","PlanFactory",function(e,t,n,o,r,a,i,c,s){e.upgradeCurrentTeam()}]).controller("StripePaymentController",["$scope","$location","errormsg",function(e,t,n){e.upgradeCurrentTeam()}]).controller("BillingController",["$scope","$location","AccountService",function(e,t,n){backend.getLicenses({team_id:e.currentUser.currentTeam.team_id}).then(function(t){e.$apply(function(){e.licenses=t})}),e.regenerateInvoice=function(t){e.submitting=!0,backend.regenerateInvoice({team_id:e.currentUser.currentTeam.team_id,bill_hash:t.bill_hash}).then(function(t){e.$apply(function(){e.submitting=!1,e.licenses=t})})}}]).controller("AccountDeleteController",["$scope","$location","$window","$timeout",function(e,t,n,o){function r(){backend.getAccount({accountHash:e.accountHash}).then(function(t){e.$apply(function(){t.account&&(e.account=t.account)})})}e.deleteAccount=function(){var t="Delete permanently team and user?";e.accounts.length>1&&(t="Delete team permanently?"),confirm(t)&&(e.deleting=!0,o(function(){n.location.href="/"},15e3),backend.deleteCurrentTeam({team_id:e.currentUser.currentTeam.team_id}).then(function(t){t?n.location.href="/":e.failed=!0,e.$digest()}))},e.accountHash=t.search().account;var a=function(){backend.load().then(function(t){e.$apply(function(){void 0!==t&&(e.accounts=t,r())})})};a()}]).controller("ManageSubscriptionController",["$scope","$location","AccountService","$window",function(e,t,n,o){e.accountHash=t.search().account,e.states={init:0,canceled:1},e.state=e.states.init,backend.getAccount({accountHash:e.accountHash}).then(function(t){e.$apply(function(){t.account&&(e.account=t.account)})}),e.upgradePlan=function(){t.path("/plans").search({account:e.accountHash})},e.updateSubscription=function(){confirm("Confirm to cancel and renew current billing agreement")&&backend.cancelSubscription(e.accountHash).then(function(n){e.$apply(function(){t.path("/payment").search({account:e.accountHash})})})},e.saveCreditCard=function(t){backend.saveCreditCard({account_hash:e.accountHash,stripe_token:t.id,stripe_email:t.email}).then(function(t){switch(t.ok){case 0:e.creditCardLast4=t.last4;break;default:e.failedToChangeCard=!0}e.$digest()})},e.cancelSubscription=function(){confirm("Confirm cancel subscription")&&backend.cancelSubscription(e.accountHash).then(function(t){e.$apply(function(){t&&(e.state=e.states.canceled)})})},e.hasPlan=function(e){return e&&"undefined"!=typeof e.plan||e&&e.validSubscription}}]).controller("ChatController",["$rootScope","$scope",function(e,t){t.offset=0,t.max=20,t.messages=[];var n=20;t.applyMessages=function(e,n){t.$apply(function(){var o=angular.fromJson(e);o.messages&&(t.offset=o.offset,t.currentUser&&o.messages.map(function(e){e.user==t.currentUser.email&&(e.user="me")}),n?t.messages=o.messages.concat(t.messages):t.messages=o.messages)})},t.applyMessage=function(e){t.$apply(function(){if(t.messages.length>=n){var o=t.messages.length-n;t.messages.splice(0,o),t.offset=t.offset+o}t.currentUser&&e.user==t.currentUser.email&&(e.user="me"),t.messages.push(angular.fromJson(e))})},t.loadOld=function(){loadPrevMessages(t.offset,n)};var o=!0;globalStreams.onlineStream.onValue(function(e){o=e}),t.sendMessage=function(){o&&(sendChatMessage(t.msg),t.msg="",globalStreams.clearChatStateStream.push())},t.showChat=function(){e.$broadcast("show-chat"),globalStreams.clearChatStateStream.push(),loadChatMessages(-20,20)},t.hideChat=function(){e.$broadcast("hide-chat")}}]).controller("AcceptController",["$scope","$location","$timeout","AcceptAcccountInfo",function(e,t,n,o){e.$watch(o.accounts,function(){e.newTeams=o.accounts});var r=function(){backend.load().then(function(t){e.$apply(function(){if(void 0!==t){e.accounts=t;var n=_.find(t,function(e){return e.defaultAccount});n&&(e.defaultAccount=n.accountHash)}else e.accounts={}})})};e.accountName=function(e){var t=e.name;return e.expired&&(t+=" -- expired"),t},e.acceptAccount=function(t){backend.acceptAccount(_.omit(t,"users")).then(function(t){e.$apply(function(){if("too_many"===t)e.teamFailureTooMany=!0;else if("expired"===t)e.teamFailureExpired=!0;else if("unknown"===t)e.teamFailureUnknown=!0;else{var n=_.find(e.newTeams,function(e){return e.accountHash===t.accountHash});n.userAccepted=!0,r(),e.teamAccepted=!0}})})},e.removeInvitation=function(t){backend.removeInvitation(_.omit(t,"users")).then(function(n){e.$apply(function(){t.invitationRemoved=n})})},e.setDefaultAccount=function(){backend.setDefaultAccount({accountHash:e.defaultAccount}).then(function(t){e.$apply(function(){e.defaultAccountChanged=!0})})}}]).controller("NotificationCenterController",["$scope","$timeout","$sce","$location","AcceptAcccountInfo",function(e,t,n,o,r){function a(){"false"==showWelcome.value&&""!=initialState.notifContent&&e.$broadcast("notificationStart",{state:"show",part:"partials/notificationpart.html",callback:{ok:function(){e.$broadcast("notificationReady",{state:"sending",hidenow:!0}),"undefined"!=typeof backendProfileService&&backendProfileService.readNotification(initialState.notifNmbr).then(function(){e.$apply(function(){})})}},data:{title:initialState.ntitle,msg:initialState.notifContent}})}var i=!1;e.showNotificationCenter=function(){return i},"undefined"!=typeof backend?backend.pendingAccounts().then(function(t){e.$apply(function(){t.length>0?(r.setAccounts(t),o.path("/accept").search({})):a()})}):t(function(){a()}),e.$on("notificationStart",function(t,n){e.notificationPart=n.part,e.notificationState=n.state,e.callback=n.callback,e.data=n.data,i=!0}),e.$on("notificationStep",function(t,n){e.notificationState=n.state,e.callback=n.callback,e.data=n.data}),e.$on("notificationReady",function(t,n){_.has(n,"data")&&n.data&&(e.data=n.data),e.notificationState=n.state,_.has(n,"hidesoonish")&&n.hidesoonish&&e.hidesoonish(),_.has(n,"hidesoon")&&n.hidesoon&&e.hidesoon(),_.has(n,"hidenow")&&n.hidenow&&e.hidenow()}),e.hidenow=function(){i=!1},e.hidesoon=function(){t(function(){i=!1},1e3)},e.hidesoonish=function(){t(function(){i=!1},5e3)},e.closeNotifications=function(){i=!1}}]).controller("APIMessageController",["$scope","$location","apimsg",function(e,t,n){var o=t.search().code;o&&(e.code=o)}]).controller("SetupOrganizationController",["$rootScope","$scope","$location","OrganizationInfo","Helpers",function(e,t,n,o,r){t.domain=r.parseEmailDomain(_initialUser.email);var a=n.search().account_hash?n.search().account_hash:initialState.account_hash;backend.getUserDefaultAccount().then(function(e){e&&e.account.accountHash!=a&&t.$apply(function(){n.path("/setup-organization").search({account_hash:e.account.accountHash})})}),t.closeModal=function(){n.path("/").search({})},t.companyDomain=function(){backend.createOrganization({account_hash:a}).then(function(e){t.$apply(function(){e?(_.extend(o,e),n.path("/teamsetup").search({account_hash:a})):t.failedToCreateOrganization=!0})})},t.personalDomain=function(){backend.personalDomain({account_hash:a}).then(function(e){t.$apply(function(){_.extend(o,{domain:null}),n.path("/teamsetup").search({account_hash:a})})})}}]).controller("SetupPartOfOrganizationController",["$scope","$location",function(){}]).controller("TeamSetupController",["$rootScope","$scope","$location","OrganizationInfo","Helpers",function(e,t,n,o,r){initialState.firstTeamLogin||n.path("/"),t.domain=o.domain,t.setupDomain=initialState.setupDomain;var a=n.search().account_hash?n.search().account_hash:initialState.account_hash;backend.getUserDefaultAccount().then(function(e){e&&e.account.accountHash!=a?t.$apply(function(){n.path("teamsetup").search({account_hash:e.account.accountHash}),t.teamName=e.account.name,_.extend(o,e.account.organization),t.domain=o.domain,t.setupDomain=initialState.setupDomain}):e.account.name!=_initialUser.email&&t.$apply(function(){t.teamName=e.account.name,_.extend(o,e.account.organization),t.domain=o.domain,t.setupDomain=initialState.setupDomain})}),t.saveTeamName=function(){t.teamName&&t.teamName.length>0?backend.saveTeamName({team_name:t.teamName,account_hash:a}).then(function(e){t.$apply(function(){e?n.path("/team-add-members").search({account_hash:a}):t.error=!0})}):n.path("/team-add-members").search({account_hash:a})},t.closeModal=function(){e.$broadcast("hide-modal")},t.back=function(){backend.reenableOrganizationSetup({account_hash:a}).then(function(e){t.$apply(function(){e&&n.path("/setup-organization").search({account_hash:a})})})}}]).controller("TeamSetupMembersController",["$rootScope","$scope","$location","$timeout","OrganizationInfo",function(e,t,n,o,r){var a=n.search().account_hash?n.search().account_hash:initialState.account_hash;t.setupDomain=initialState.setupDomain,backend.getUserDefaultAccountIfInvalidHash({account_hash:a}).then(function(e){e&&t.$apply(function(){n.path("team-add-members").search({account_hash:e.account.accountHash})})});var i="^[^@ \t,]+@([^@ \t,.]+\\.)+[a-z]{2,8}$";t.candidates=[{name:null,email:null},{name:null,email:null},{name:null,email:null},{name:null,email:null}],t.failedMembers=[],t.close=function(){e.$broadcast("hide-modal")},t.back=function(){n.path("/teamsetup").search({account_hash:a})},t.saveMembers=function(){var e=_.chain(t.candidates).filter(function(e){return e.email}).map(function(e){return _.clone(e)}).map(function(e){return e.email=e.email.toLowerCase(),e}).value(),r=_.filter(e,function(e){return e.email&&e.email.match(i)});t.failedMembers=_.chain(e).filter(function(e){return e.email&&!e.email.match(i)}).map(function(e){return _.clone(e)}).value();var c=function(e){t.$apply(function(){e?(t.done=!0,t.teamName=e,o(function(){n.path("/boardname").search({})},5e3)):t.setupFailed=!0})};r.length>0&&0==t.failedMembers.length?(t.submitting=!0,backend.saveMembers({account_hash:a,members:r}).then(function(e){t.$apply(function(){t.submitting=!1,_.isArray(e)&&e.length>0?t.failedMembers=_.map(e,function(e){return e}):_.isArray(e)&&0==e.length?backend.setupDone({account_hash:a}).then(c):t.error=!0})})):0==t.failedMembers.length&&backend.setupDone({account_hash:a}).then(c)}}]).controller("PublishOnGalleryController",["$rootScope","$scope",function(e,t){function n(){t.showButtons=!1,getBoardService().isManuallyPublished({board_id:t.currentBoard.boardId}).then(function(e){t.$apply(function(){t.showButtons=!0,t.manuallyPublished=e})})}var o="publish-manually";e.$on(o,function(e,o){t.$apply(function(){t.sending=!1,o.data.ok?(t.success=!0,t.galleryUrl=o.data.galleryUrl):t.failed=!0,n()})}),t.publish=function(){t.sending=!0,getBoardService().publishManually({board_id:t.currentBoard.boardId,event:o,sketchboard_ng_page:t.sketchboardNgPage}).then(function(e){e||(t.failed=!0)})};var r="unpublish-manually";e.$on(r,function(e,o){t.$apply(function(){t.sending=!1,o.data.ok?t.successUnpublish=!0:t.failedUnpublish=!0,n()})}),t.unpublish=function(){t.sending=!0,getBoardService().unpublishManually({board_id:t.currentBoard.boardId,event:r,sketchboard_ng_page:t.sketchboardNgPage}).then(function(e){e||(t.failedUnpublish=!0)})},n()}]).controller("BoardNameController",["$scope","$rootScope","$sce","$location","$filter","AuthService","BoardManagerService","Helpers","NotifyService","boardmenu","accountType","sharemenu",function(e,t,n,o,r,a,i,c,s,l,u,d){function f(){t.$broadcast("board-name-saved")}function p(t){getBoardService().markBoardAsPro(e.currentBoard).then(function(n){e.$apply(function(){_.extend(e.currentBoard,n),s.info(c.format(l.makePrivate,n.accountname)),t&&t()})})}function m(e){a.currentUser().isLoggedIn()&&(a.currentBoard().iAmTheOwner()||a.currentUser().isAccountRoleAdminOrPrimaryOwner()?a.currentBoard().isFree()&&!a.currentUser().isDefaultAccountExpired()?p(function(){o.path("/boardname")}):(0==o.path().length||1==o.path().length&&"/"==o.path())&&o.path("/boardname"):e&&s.info(l.onlyOwnerCanChangeBoardName))}"/boardname"==o.path()&&(e.done=!1,e.currentUser.isAccountRoleReadOnly()?e.done=!0:a.currentUser().isAccountRoleAdminOrPrimaryOwner()||a.currentBoard().iAmTheOwner()||(e.done=!0)),a.currentBoard().name!=a.currentBoard().boardId&&(e.boardname=a.currentBoard().name),!initialState.firstTeamLogin&&a.currentBoard().new_board&&m(!1),e.$watch(e.currentBoard,function(){e.visibility=null,e.currentBoard.isAccountVisibility()?e.visibility="team":e.currentBoard.isPrivate()?e.visibility="private":e.currentBoard.isPublic()&&(e.visibility="public"),e.currentBoard.isCreatedBeforeGalleryLaunch()&&(e.viewInGalleryInfo="Public boards created before "+r("date")(_config.galleryLaunchDate,"mediumDate")+" are not show in Sketch Gallery automatically")});var h="make-private";t.$on(h,function(t,n){e.successMakePrivate=n.data.ok,e.$apply(function(){!n.data.ok&&n.data.upgrade?e.upgradeCurrentTeam():n.data.ok&&(e.currentBoard=_.extend(e.currentBoard,n.data.diagram),document.title=n.data.diagram.name+" | Sketchboard",s.info(c.format(d.nowsharedwithaccount,n.accountname)))})}),e.makePrivate=function(){getBoardService().makePrivate({team_id:e.currentUser.currentTeam.team_id,board_id:e.currentBoard.boardId,sketchboard_ng_page:e.sketchboardNgPage,event:h}).then(function(t){t.ok||e.$apply(function(){e.failedMakePrivate=!0,s.info("Sorry, failed to make board private. Please contact support support@sketcboard.io.")})})},e.takeOwnership=function(){getBoardService().takeOwnership({team_id:e.currentUser.currentTeam.team_id,board_id:e.currentBoard.boardId}).then(function(t){switch(t.ok){case 0:e.currentBoard.owner=t.owner,o.path("/boardname");break;default:s.info("Sorry, failed to take ownership. Please contact support support@sketcboard.io.")}e.$apply()})},e.makePublicBoard=function(){getBoardService().makePublicBoard(e.currentBoard).then(function(t){e.$apply(function(){t&&(e.currentBoard.diagramType=t.diagramType,e.currentBoard.visibility=t.visibility,s.info(c.format(d.nowpublic,t.accountname)),_trackGA("Share","makePublicBoard","ShareOrUnshare"),window.location.reload())})})},e.teamBoard=function(){getBoardService().shareWithAccount(e.currentBoard).then(function(t){e.$apply(function(){e.currentBoard.visibility=t.visibility,s.info(c.format(d.nowsharedwithaccount,t.accountname)),_trackGA("Share","shareWithAccount","ShareOrUnshare")})})},e.makePersonal=function(){getBoardService().makePersonal(e.currentBoard).then(function(t){e.$apply(function(){e.currentBoard.visibility=t.visibility,s.info(d.nowprivate)})})},e.saveBoardName=function(){var t=e.boardname?e.boardname:"";getBoardService().saveBoardName({board_id:a.currentBoard().boardId,board_name:t}).then(function(t){e.$apply(function(){_.isString(t)?s.info(t):_.isObject(t)&&(_.extend(e.currentBoard,t),document.title=t.name+" | Sketchboard",f())})})},e.renameBoard=function(){a.currentUser().isLoggedIn()?m(!0):s.info(l.renameCondition)},e.markCurrentAsPro=function(){p()},e.freeOwnedSomeoneElse=function(){return n.trustAsHtml(c.format(l.freeOwnedSomeoneElse,e.currentBoard.boardId))},e.freeMyBoard=function(){return n.trustAsHtml(l.freeMyBoard)},e.freeNotOwnedBoard=function(){return n.trustAsHtml(l.freeNotOwnedBoard)},e.freeNotOwnedBoardNotLoggedIn=function(){return n.trustAsHtml(c.format(l.freeNotOwnedBoardNotLoggedIn,e.currentBoard.boardId))}}]).controller("ExportCallback",["$rootScope","$scope","$window",function(e,t,n){function o(e){switch(e){case"PNG":case"JPG":case"PDF":case"SVG":case"JSON_CLASS":return!0;default:return!1}}t.downloadFileSocketNotif=function(t){e.$apply(function(){0==t.ok?(e.$broadcast("notificationReady",{state:"ready",hidesoon:!0}),_trackGA("Menu","ExportReady",t.exportType),globalStreams.userMessageEventStream.push(2)):(e.$broadcast("notificationReady",{state:"failed",data:{msg:t.msg}}),_trackGA("Menu","ExportFailed",t.exportType))})},t.downloadFile=function(r){r.success?(e.$broadcast("notificationReady",{state:"ready",data:{downloads:[{name:t.currentBoard.name}],exportType:r.exportType},hidesoon:!0}),_trackGA("Menu","ExportReady",r.exportType),o(r.exportType)&&(t.iframe||(t.iframe=document.createElement("iframe"),t.iframe.style.display="none",document.body.appendChild(t.iframe)),t.iframe.src=r.url)):"string"==typeof r.oauth_url?n.location.href=r.oauth_url:(e.$broadcast("notificationReady",{state:"failed",data:{msg:r.msg,exportType:r.exportType}}),_trackGA("Menu","ExportFailed",r.exportType))}}]).controller("ExportController",["$rootScope","$scope","$window","$location","NotifyService",function(e,t,n,o,r){function a(e){sendToServer(e),o.path("/").search({})}function i(e){return!!t.currentUser.currentTeam.notExpired||("PNG"==e||("JPG"==e||(globalStreams.userMessageEventStream.push(2),!1)))}function c(){return t.currentBoard.noOwner()?(r.info("Board needs to be owned before it can be exported"),!1):t.currentBoard.isPaidBoard()||confirm("Free plan PNG export includes watermark. Remove watermark by upgrading your plan.")}function s(e,n){var o={exportType:e,boardFullId:t.currentBoardFullId()};return n&&(o.client_ids=gwtGetSeletedShapeIds()),o}function l(t){e.$broadcast("notificationStart",{part:"partials/downloadpart.html",state:"generating",data:{downloads:[]}}),o.path("/");var n=[];return t&&(n=gwtGetSeletedShapeIds()),n}function u(n){switch(n.ok){case 0:t.iframe||(t.iframe=document.createElement("iframe"),t.iframe.style.display="none",document.body.appendChild(t.iframe)),t.iframe.src=n.url;break;case-1:e.$apply(function(){r.info("Upgrade to export the board in this format.")});break;default:e.$apply(function(){e.$broadcast("notificationReady",{state:"failed",data:{msg:"Sorry, export failed. Please contact support@sketchboard.io"}}),r.info("Failed to export. Please contact support@sketchboard.io.")})}}t.donwloadPNG=function(e){if(c()){var n=l(e);getSocket().then(function(e){exportBackend.exportRequest({board_id:t.currentBoardId(),format:"png",client_ids:n,socket_id:e.id}).then(function(e){u(e),_trackGA("Menu","ExportStarted","PNG")})})}},t.donwloadJPEG=function(e){if(c()){var n=l(e);getSocket().then(function(e){exportBackend.exportRequest({board_id:t.currentBoardId(),format:"jpg",client_ids:n,socket_id:e.id}).then(function(e){u(e),_trackGA("Menu","ExportStarted","JPG")})})}},t.downloadSVG=function(e){if(i("SVG")){var n=l(e);getSocket().then(function(e){exportBackend.exportRequest({board_id:t.currentBoardId(),format:"svg",client_ids:n,socket_id:e.id}).then(function(e){_trackGA("Menu","ExportStarted","SVG"),u(e)})})}},t.downloadPDF=function(e){if(i("PDF")){var n=l(e);getSocket().then(function(e){exportBackend.exportRequest({board_id:t.currentBoardId(),format:"pdf",client_ids:n,socket_id:e.id}).then(function(e){_trackGA("Menu","ExportStarted","PDF"),u(e)})})}},t.exportPDFToGoogleDrive=function(t){if(i("PDF")){e.$broadcast("notificationStart",{part:"partials/downloadpart.html",state:"generating",data:{downloads:[]}});var n=s("PDF2GDRIVE",t);_trackGA("Menu","ExportStarted","PDF2GDRIVE"),a(n)}},t.exportPNGToGoogleDrive=function(t){if(c()){e.$broadcast("notificationStart",{part:"partials/downloadpart.html",state:"generating",data:{downloads:[]}});var n=s("PNG2GDRIVE",t);_trackGA("Menu","ExportStarted","PNG2GDRIVE"),a(n)}},t.exportSVGToGoogleDrive=function(t){if(i("SVG")){e.$broadcast("notificationStart",{part:"partials/downloadpart.html",state:"generating",data:{downloads:[]}});var n=s("SVG2GDRIVE",t);_trackGA("Menu","ExportStarted","SVG2GDRIVE"),a(n)}},t.exportPNGToGitHub=function(e){var o={board_id:t.currentBoard.boardId};e&&(o.client_ids=gwtGetSeletedShapeIds()),exportBackend.oauthGitHub(o).then(function(e){e&&(n.location.href=e)})},t.exportJsonClass=function(){e.$broadcast("notificationStart",{part:"partials/downloadpart.html",state:"generating",data:{downloads:[]}});var n={};n.exportType="JSON_CLASS",n.boardFullId=t.currentBoardFullId(),_trackGA("Menu","ExportStarted","JSON_CLASS"),sendToServer(n)},t.exportPlainJSON=function(){exportBackend.exportRequest({board_id:t.currentBoardId(),format:"json",client_ids:gwtGetSeletedShapeIds()}).then(function(e){u(e)})},t.exportJSON=function(){exportBackend.exportRequest({board_id:t.currentBoardId(),format:"json_conn",client_ids:gwtGetSeletedShapeIds()}).then(function(e){u(e)})},t.exportCSV=function(){exportBackend.exportRequest({board_id:t.currentBoardId(),format:"csv_conn",client_ids:gwtGetSeletedShapeIds()}).then(function(e){u(e)})}}]).controller("ExportGitHubController",["$rootScope","$scope","$window",function(e,t,n){t.states={init:0,loaded:1,repository:2},t.state=t.states.init,t.currentPath=[],t.filetypes=["png","svg","pdf"],t.filename=t.currentBoard.name.toLowerCase().replace(/\s/g,"-"),t.description="Modify at https://sketchboard.me/"+t.currentBoard.boardId,_trackGA("Menu","View GitHub Export"),exportBackend.listRepositories({board_id:t.currentBoard.boardId}).then(function(e){t.$apply(function(){switch(e.ok){case 0:t.repositories=e.repositories,t.filetype=e.filetype,t.state=t.states.loaded;break;default:n.location.href=e.oauthURL}})});var o=function(){exportBackend.repoTree({repoName:t.currentRepo.name,branch:t.currentBranch,path:[]}).then(function(e){t.$apply(function(){t.dirs=e,t.state=t.states.repository})})};t.selectRepoTree=function(e){t.currentRepo=e,t.currentBranch=e.branches[0],o()};var r=function(){exportBackend.repoTree({repoName:t.currentRepo.name,branch:t.currentBranch,path:t.currentPath}).then(function(e){t.$apply(function(){t.dirs=e})})};t.selectRepoBranch=function(e,n){t.currentBranch=n,t.currentPath=[],r()},t.rootPath=function(){t.currentPath=[],r()},t.addPath=function(e){t.currentPath.push(e),r()},t.changePath=function(e,n){var o=n+1;o<t.currentPath.length&&(t.currentPath.splice(o,t.currentPath.length-n),r())},t.changeFileType=function(e){t.filetype=e},t.commitImage=function(){exportBackend.commitImage({boardId:t.currentBoard.boardId,description:t.description,path:{repoName:t.currentRepo.name,branch:t.currentBranch,path:t.currentPath,filename:t.filename,filetype:t.filetype}}).then(function(n){t.$apply(function(){t.$broadcast("closegithub"),e.$broadcast("notificationStart",{part:"partials/downloadpart.html",state:"generating",data:{downloads:[]}}),_trackGA("Menu","GitHub Export",t.filetype)})})}}]).controller("ChangeNameController",["$scope","$compile","BoardManagerService","PopoverService","Helpers",function(e,t,n,o,r){function a(t){o.showFormAndFocus(s,t,l,"#ChangeNameController",e,function(e){var t=$(l);t.val(n.boardNameOrEmpty())})}var i="#settingsmenu",c="changeboardename",s="ng-templates/changename.html",l="#change-name-field";e.changeNamePopoverOptions=function(e){return{placement:"top",html:"true",trigger:"manual",title:o.popoverTitle("Change Board Name",i),template:o.popoverTemplate(c,i)}},e.localChangeBoardName=function(e){angular.element(i).popover("hide")},e.showChangeNamePopover=function(){var e=angular.element(i);e.next("div.popover:visible").length?e.popover("hide"):a(e)}}]).controller("FeedbackController",["$scope",function(e){e.states={init:0,feedbackleft:1,sendingFeedback:2,feedbackFailed:3},e.state=e.states.init,e.sendFeedback=function(){e.state=e.states.sendingFeedback,unsubsBackend.leaveFeedback(e.feedback).then(function(t){e.$apply(function(){t?e.state=e.states.feedbackleft:e.state=e.states.feedbackFailed})})}}]).controller("ShortcutController",["$scope",function(e){}]).controller("TipFreehandController",["$scope","$compile",function(e,t){window.boardReadyStream.onValue(function(){var n=angular.element("#tip-freehand");n&&(n.attr("tipper",!0),n.attr("data-tip-title","#Tip Freehand"),n.attr("data-tip-content","/partials/tip/freehand.html"),n.attr("data-tip-on-stream","freehandOnStream"),t(n)(e))}),e.freehandDone=function(){"undefined"!=typeof backendAuthService&&backendAuthService.tipFreehandDone(),e.$broadcast("hide-tip")}}]).controller("TipMapViewController",["$scope","$compile",function(e,t){var n=null;n=window.boardReadyStream.onValue(function(){n();var o=angular.element("#tip-map");o&&(o.attr("tipper",!0),o.attr("data-tip-title","#Tip Map View"),o.attr("data-tip-content","/partials/tip/mapview.html"),o.attr("data-tip-on-stream","mapViewStateStream"),t(o)(e))}),e.mapViewDone=function(){"undefined"!=typeof backendAuthService&&backendAuthService.tipMapViewDone(),e.$broadcast("hide-tip")}}]).controller("TipSlackController",["$scope","$compile",function(e,t){var n=angular.element("#slack-menu");n&&(n.attr("tipper",!0),n.attr("data-popover-target-selector","#slack-menu"),n.attr("data-tip-title","#Tip Share in Slack Channel"),n.attr("data-tip-content","/partials/tip/slack.html"),n.attr("data-tip-below",!0),n.attr("data-tip-placement","bottom"),t(n)(e)),e.slackDone=function(){"undefined"!=typeof backendAuthService&&(backendAuthService.tipSlackDone(),e.$broadcast("hide-tip"))}}]).controller("TipController",["$scope","$compile","$timeout",function(e,t,n){var o=null;o=globalStreams.shapeAddedStream.onValue(function(){o();var r=window.streamShapeContextMenuShown.onValue(function(){r(),n(function(){var n=angular.element("#tip-shape-added");n.show(),n&&(n.attr("tipper",!0),n.attr("data-popover-target-selector","#tip-shape-added-container"),n.attr("data-tip-title","#Tip Quick Connect"),n.attr("data-tip-content","/partials/tip/quick-connect.html"),n.attr("data-tip-below",!0),n.attr("data-tip-placement","bottom"),t(n)(e))})})}),e.quickConnectDone=function(){"undefined"!=typeof backendAuthService&&backendAuthService.tipQuickConnectDone(),e.$broadcast("hide-tip")}}]).controller("ErrorController",["$scope",function(e){}]).controller("UnsubscribeController",["$scope",function(e){e.states={init:0,feedbackleft:1,sendingFeedback:2},e.state=e.states.init,e.unsubscribe=function(){var t=$("[name='email']");t&&(e.state=e.states.sendingFeedback,unsubsBackend.leaveFeedbackNewsletter({email:t[0].value,msg:e.feedback}).then(function(t){e.$apply(function(){"success"===t&&(e.state=e.states.feedbackleft)})}))}}]).controller("CreateVersionController",["$scope","$location","$timeout",function(e,t,n){e.summary="",e.description=null,e.message="",e.sending=!1;var o=function(){getBoardService().commitVersion({boardId:e.currentBoard.boardId,summary:e.summary,description:e.description}).then(function(t){e.$apply(function(){e.message=t})})};e.commitVersion=function(){!e.sending&&e.summary.length>0&&(e.sending=!0,n(function(){o()}))}}]).controller("VersionsController",["$scope","$location","$window","$timeout","boardmenu","Helpers",function(e,t,n,o,r,a){function i(t){getBoardService().revertToVersion({boardId:e.currentBoardId(),sha:t.sha}).then(function(t){e.$apply(function(){t||NotifyService.info("Sorry, revert failed.")})})}e.versions=[],e.restoreTip=r.restoreTip,e.loadVersions=function(){getBoardService().loadVersions({boardId:e.currentBoardFullId()}).then(function(t){e.$apply(function(){angular.isArray(t)?e.versions=t:"string"==typeof t?e.errormsg=t:e.errormsg="Sorry, get versions failed."})})},e.loadMoreVersions=function(){var t=null;e.versions.length>0&&(t=e.versions[e.versions.length-1]),getBoardService().loadVersions({boardId:e.currentBoardFullId(),fromSha:t.sha}).then(function(t){e.$apply(function(){angular.isArray(t)?_.each(t,function(t){e.versions.push(t)}):"string"==typeof t?e.errormsg=t:e.errormsg="Sorry, get versions failed."})})},e.loadVersions(),e.textToLines=function(e){return e.split("\n")},e.lineBreak=function(e){return e.join("\n").split("\n")},e.toggleDiff=function(t){e.$broadcast(t)},e.lineStyle=function(e){return e.startsWith("+")?"diff-added":e.startsWith("-")?"diff-removed":""},e.formatVersionUrl=function(t){return"/"+e.currentBoardId()+"-"+t.sha},e.revert=function(t){e.sending||(e.sending=!0,o(function(){i(t)}))}}]).controller("VersionController",["$scope","$location","$window","$timeout","boardmenu","Helpers","NotifyService",function(e,t,n,o,r,a,i){function c(){a.isBoardVersion()&&(e.versionsrc="partials/version.html")}function s(){getBoardService().revertToVersion({boardId:e.currentBoardId(),sha:e.currentBoardVersion()}).then(function(t){e.$apply(function(){t?n.location.href="/"+e.currentBoardId():i.info("Sorry, revert failed.")})})}e.restoreTip=r.restoreTip,c(),e.originalUrl=function(){return e.currentBoardId()},e.revert=function(){e.sending||(e.sending=!0,o(function(){s()}))}}]).controller("OfflineController",["$scope","$http",function(e,t){e.deploying=0,e.reload=function(){window.location.reload()},e.releaseOn=function(t){e.deploying=1,t.release_notes_url&&t.release_notes_url.startsWith("https://sketchboard.io")&&(e.releaseNotes=t.release_notes_url)},e.releaseFalse=function(){e.deploying=0,e.releaseNotes=null},e.hasReleaseNotes=function(){return e.releaseNotes&&e.releaseNotes.length>0}}]).controller("EduController",["$scope",function(e){e.isEduBoard=function(){return"undefined"!=typeof _appState.eduReturnUrl},e.returnUrl=_appState.eduReturnUrl,e.imageUrl=_appState.appImage,e.appName=_appState.appName}]).controller("GoogleDriveController",["$scope",function(e){e.teamChanged=function(){e.success=!1,backend.setGoogleDriveIntegration({account_hash:e.selectedAccount}).then(function(t){e.success=t,e.$digest()})},"undefined"!=typeof backend&&backend.googleDriveIntegration().then(function(t){switch(t.ok){case 0:e.teams=_.sortBy(t.teams,function(e){return e.name});var n=_.find(e.teams,function(e){return e.teamId==t.int_team_id});n&&(e.selectedAccount=n.accountHash);break;default:e.failed=!0}e.$digest()})}]).controller("HipChatIntController",["$scope","$location","hipchatint",function(e,t,n){function o(){backendIntegrations.isHipChatEnabledForTeam({account_hash:e.selectedAccount,oauth_id:e.configureOAuthId}).then(function(t){e.$apply(function(){switch(t.ok){case 0:e.integrationEnabled=!0;break;case-1:e.integrationEnabled=!1}})})}function r(){e.integrationEnabled?e.successMessage=n.enabledText:e.successMessage=n.disabledText}e.integrationEnabled=!1,e.configureOAuthId=t.search().oauthid,e.accountName=function(e){var t=e.name;return e.expired&&(t+=" -- free plan"),t},e.loadAccounts=function(){backendIntegrations.listCurrentUserAccounts().then(function(t){e.$apply(function(){void 0!==t&&(e.accounts=t,e.selectedAccount=_.find(t,function(e){return e.defaultAccount}).accountHash,o())})})},e.loadAccounts(),e.teamChanged=function(){o()},e.updateHipchat=function(){backendIntegrations.updateHipChatIntegration({account_hash:e.selectedAccount,
enabled:e.integrationEnabled,oauth_id:e.configureOAuthId}).then(function(t){e.$apply(function(){switch(t.ok){case 0:e.hipchatSuccess=!0;break;case-1:e.hipchatFailed=!0;break;case-2:e.hipchatFailed=!1,e.hipchatAlreadyUsedFailure=!0}r()})})}}]).controller("SlackIntController",["$scope",function(e){e.slashCmdToken="",e.dataNotOk=function(){return 0==e.slashCmdToken.length||(0==e.slashCmdToken.indexOf("****")||(0==e.webhookURL.length||0==e.webhookURL.indexOf("****")))},e.accountName=function(e){var t=e.name;return e.expired&&(t+=" -- free plan"),t},e.loadAccounts=function(){backendIntegrations.listAccountsWhereUserIsAdmin().then(function(t){e.$apply(function(){void 0!==t&&(e.accounts=t,e.selectedAccount=_.find(t,function(e){return e.defaultAccount}).accountHash,backendIntegrations.isSlackEnabledForTeam({account_hash:e.selectedAccount}).then(function(t){switch(e.$broadcast("slackint-initialized"),t.ok){case 0:e.slashCmdToken=t.slack_slash_token,e.webhookURL=t.webhook_url,e.integrationUrl=t.integration_url,e.integrationEnabled=!0}}))})})},e.loadAccounts(),e.saveSlackToken=function(){e.dataNotOk()||backendIntegrations.saveSlackSlashToken({account_hash:e.selectedAccount,slack_slash_token:e.slashCmdToken,webhook_url:e.webhookURL}).then(function(t){e.$apply(function(){switch(t.ok){case 0:e.success=!0,e.integrationUrl=t.integration_url,e.integrationEnabled=!0;break;case-1:e.failed=!1,e.failedNotAdmin=!0;break;case-2:e.failed=!0}})})},e.regenerateIntegrationUrl=function(){confirm("Are you sure you want to regenerate this integration URL?")&&backendIntegrations.regenerateIntegrationUrl({account_hash:e.selectedAccount}).then(function(t){e.$apply(function(){switch(t.ok){case 0:e.integrationUrl=t.integration_url;break;case-1:e.failedRegenerate=!1,e.failedRegerateNotAdmin=!0;break;case-2:e.failedRegenerate=!0}})})}}]).controller("HipChatController",["$rootScope","$scope","$location",function(e,t,n){t.message="","undefined"!=typeof backendAuthService?backendAuthService.hipchatRoom(t.currentBoard.boardId).then(function(e){e.ok&&t.$apply(function(){t.roomName=e.roomName})}):n.path("/").search({}),e.$on("hipchat-uploaded",function(e,n){t.$apply(function(){t.sending=!1,t.message="",n.data?t.hipchatSuccess=!0:t.hipchatFailed=!0})}),t.shareInHipChat=function(){if(!t.sending){t.sending=!0;var e={board_id:t.currentBoard.boardId,msg:t.message,event:"hipchat-uploaded",sketchboard_ng_page:t.sketchboardNgPage},n=gwtGetSeletedShapeIds();n.length>0&&(e.client_ids=gwtGetSeletedShapeIds()),backendIntegrations.sendToHipChat(e).then(function(e){e||t.$apply(function(){t.failed=!0,t.sending=!1})})}}}]).controller("BoardInfoController",["$scope","$location","$window","NotifyService","AuthService",function(e,t,n,o,r){function a(){e.$broadcast("clear-input")}function i(){getBoardService().findAllTagsByDiagram({board_id:e.currentBoardId()}).then(function(t){e.$apply(function(){e.tags=t})})}e.tags=[],r.currentUser().isLoggedIn()||t.path("/").search({}),e.styleOpposite=function(){return e.currentBoard.isSketchMode()?"Corporate":"Awesome"},e.switchStyle=function(){gwtToggleSketchMode()},e.close=function(){t.path("/").search({})},e.copyCurrentAsNew=function(){getBoardService().copyCurrentAsNew({board_id:e.currentBoard.boardId,team_id:e.currentUser.currentTeam.team_id}).then(function(e){e&&(n.location.href="/"+e)})},e.canIDeleteBoard=function(t){return!e.currentUser.isAccountRoleReadOnly()&&(!!t.iAmTheOwner()||!!e.currentUser.isAccountRoleAdminOrPrimaryOwner())},e.deleteBoard=function(t){confirm("Delete board **"+t.name+"** permanently?\nThis cannot be undone!")&&getBoardService().deleteBoard({board_id:t.boardId}).then(function(n){if(n){var o=e.boards.indexOf(t);e.boards.splice(o,1)}e.$digest()})},e.searchTags=function(t,n){getBoardService().searchTags({board_id:e.currentBoardId(),query:t}).then(function(e){n(_.map(e,function(e){return e.name}))})},e.select=function(t){e.addTag(t)},e.addTag=function(t){t.length>0&&getBoardService().addTag({tag:t,board_id:e.currentBoardId()}).then(function(t){e.$apply(function(){switch(t){case 0:a(),i();break;case-1:o.info("Max 2 tags can be created on free plan.");break;case-2:o.info("Sorry, tag creation failed")}})})},e.openTag=function(t){getBoardService().findBoardsByTag({board_id:e.currentBoardId(),tag:t.name.replace(/ /g,"-")}).then(function(n){e.$apply(function(){t.boards=n})})},e.deleteTag=function(t){getBoardService().deleteTag({board_id:e.currentBoardId(),tag:t.name.replace(/ /g,"-")}).then(function(e){e&&i()})},i()}]).controller("SwitchTeamController",["$scope","$location","$window","$timeout",function(e,t,n,o){function r(t){var n=t-a;n>=0&&n<=8&&n<e.teams.length&&e.setCurrentTeam(e.teams[n])}if(!e.isLoggedIn)return void(n.location.href="#/");var a=49,i=globalStreams.numberShorcutStream.onValue(function(e){r(e)});e.$on("$destroy",function(){i()}),e.close=function(){t.path("/").search({})},e.isCurrentTeam=function(t){return t.teamId==e.currentUser.currentTeam.team_id},e.setCurrentTeam=function(t){e.currentUser.currentTeam.team_id!=t.teamId&&backend.setDefaultAccount({accountHash:t.accountHash}).then(function(e){e&&(n.location.href="/")})},"undefined"!=typeof backend&&backend.teams().then(function(t){e.teams=_.sortBy(t,function(e){return e.name}),e.$digest()})}]).controller("NewTeamController",["$scope","$location","$window",function(e,t,n){e.close=function(){t.path("/").search({})},e.saving=!1,e.saveNewTeam=function(){e.saving||(e.saving=!0,backend.saveNewTeam({name:e.teamName,currentTeam:e.currentUser.currentTeam.team_id}).then(function(t){switch(t.ok){case 0:n.location.href="/";break;case-1:e.failureExpiredAccount=!0;break;default:e.failed=!0}e.saving=!1,e.$digest()}))},e.isOrganizationSubscription=function(){return e.currentUser.currentTeam.notExpired&&null!=e.currentUser.currentTeam.org},e.okToCreateNewTeam=function(){return e.isOrganizationSubscription()&&e.currentUser.isAccountRoleAdminOrPrimaryOwner()}}]).controller("PresentationEditController",["$scope","$location","$sce","NotifyService",function(e,t,n,o){function r(){e.slides=_.sortBy(e.slides,function(e){return e.data.order})}function a(){if(t.path("presentation-edit")){var n=gwtGetSlides(92,70,!0);e.slides=n.slides,r()}}if(!e.currentBoard.isPro())return t.path("/").search({}),void o.info("Presentation is available only on private boards.");e.slides=[];try{a()}catch(t){boardLoadedStream.onValue(function(){e.$apply(function(){a()})})}globalStreams.addSlideStream.onValue(function(){e.$$phase?e.addSlideMode=globalState.addSlideMode:e.$apply(function(){e.addSlideMode=globalState.addSlideMode})}),globalStreams.slideCreatedStream.onValue(function(){e.$apply(function(){a()})}),e.startPresentation=function(){t.path("/presentation").search({})},e.slideId=function(e){return e.clientId},e.changeSlideOrder=function(t,n){var o=_.findIndex(e.slides,function(e){return n===e.clientId}),a=_.findIndex(e.slides,function(e){return t===e.clientId});if(a!=o&&a>=0&&o>=0){var i=e.slides[a],c=e.slides[o];if(0==o)i.data.order=c.data.order/2;else if(o-1>=0&&o<a){var s=e.slides[o].data.order,l=e.slides[o-1].data.order,u=s-l;i.data.order=l+u/2}else o>a&&o+1<e.slides.length?i.data.order=e.slides[o+1].data.order/2:i.data.order=c.data.order+1;gwtUpdateSlide(i)}r()},e.createSlide=function(){globalStreams.addSlideStream.push()},e.svgContainerStyle=function(e){92/e.width,70/e.height;return""};var i=[];e.addSlide=function(e){i.push(e)},e.getSlides=function(){return i},e.slideSvg=function(e){return n.trustAsHtml(e.svg)},e.quitEdit=function(){t.path("/").search({}),globalState.cancelAddSlideMode()}}]).controller("PresentationController",["$scope","$location","PresentationService","NotifyService",function(e,t,n,o){return e.currentBoard.isPro()?void(e.quit=function(){t.path("/").search({}),n.quit()}):(t.path("/").search({}),void o.info("Presentation is available only on private boards."))}]),angular.module("myApp.directives",[]).directive("whenScrolled",function(){return function(e,t,n){var o=t[0];t.bind("scroll",function(){o.scrollTop+o.offsetHeight>=o.scrollHeight&&e.$apply(n.whenScrolled)})}}).directive("whenScrolledUp",function(){return function(e,t,n){var o=t[0];t.bind("scroll",function(){0==o.scrollTop&&e.$apply(n.whenScrolledUp)})}}).directive("closeOnEsc",function(){return function(e,t,n){$("body").on("keyup",function(e){if(27===e.keyCode){var n=t.find("input");n&&n.blur(),t.hide()}})}}).directive("escHandler",function(){return function(e,t,n){$("body").on("keyup",function(o){if(27===o.keyCode){var r=t.find("input");r&&r.blur(),e.$apply(n.escHandler)}})}}).directive("clickOutsideHandler",function(){return function(e,t,n){Hammer(document).on("tap",function(o){if(!t.is(o.target)&&0===t.has(o.target).length){var r=t.find("input");r&&r.blur(),e.$eval(n.clickOutsideHandler)}})}}).directive("closeClickOutside",function(){return function(e,t,n){$("body").on("mousedown",function(e){if(!t.is(e.target)&&0===t.has(e.target).length){var n=t.find("input");n&&n.blur(),t.fadeOut(250)}})}}).directive("capitalize",function(){return function(e,t,n){function o(e){return e.substring(0,1).toUpperCase()+e.substring(1)}t.text(o(t.text()))}}).directive("toggle",["$timeout",function(e){return function(t,n,o){o.$observe("toggle",function(o){t.$on("event:toggle:"+o,function(){n.slideToggle(),e(function(){n.find("input[type=text]").focus()})})})}}]).directive("toggleOn",["$timeout",function(e){return function(t,n,o){t.$on(o.toggleOn,function(){n.is(":visible")?n.hide():n.hasClass("btn")?n.css({display:"inline-block"}):(n.toggle(),e(function(){n.find("input[type=text]").focus()}))})}}]).directive("slideOnStateVisible",function(){return function(e,t,n){e.$watch("state.visible",function(e,n){n!=e&&t.slideToggle()})}}).directive("popover",["Helpers",function(e){return function(t,n,o){var r=e.format('<div class="popover {}"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>',"help-popover"),a=function(){n.popover("hide")};t.hidePopovers=a,n.popover({html:!0,content:o.popover,placement:o.popoverPlacement,trigger:"hover",container:"body",template:r})}}]).directive("tooltip",function(){return function(e,t,n){function o(){var e={title:n.tooltip,placement:n.tooltipPlacement};n.tooltipEmbedContainer?e.container=!1:e.container="body",n.tooltipHtml&&(e.html=!0),t.tooltip(e),t.on("mousedown",function(){t.tooltip("hide")})}isTouch()||(n.tooltipDelay?_.delay(o,parseInt(n.tooltipDelay)):o())}}).directive("enterKey",function(){return function(e,t,n){t.on("keydown",function(t){if(13==t.which)return e.$apply(function(){e[n.enterKey]()}),void t.preventDefault()})}}).directive("enterCmd",function(){return function(e,t,n){t.on("keydown",function(t){if(13==t.which&&(t.ctrlKey||t.metaKey))return e.$apply(n.enterCmd),void t.preventDefault()})}}).directive("enterSubmit",function(){return function(e,t,n){t.on("keydown keypress",function(t){13!==t.which||t.shiftKey||t.altKey||(t.preventDefault(),e.$apply(n.enterSubmit))})}}).directive("addMentionsSymbol",["$rootScope",function(e){return function(t,n,o){n.on("click",function(){e.$broadcast(o.addMentionsSymbol)})}}]).directive("mentionsTextarea",["$rootScope","MentionsEditor",function(e,t){return function(n,o,r){n.getSelectionStart=function(){var e=o.prop("selectionStart");return e},n.getSelectionEnd=function(){var e=o.prop("selectionEnd");return e},n.textAreaValue=function(){return o[0].value},n.setTextareaValue=function(e){function t(e,n,o,r){if(o==n.length-1){var a=n[o];return void(e[a]=r)}var a=n[o],i=e[a];return t(i,n,++o,r)}var o=r.ngModel.split(".");t(n,o,0,e)},n.getTextareaElement=function(){return o[0]},n.textAreaFocus=function(){o[0].focus()},n.setCursorPosition=function(e){o.prop("selectionStart",e),o.prop("selectionEnd",e)},n.$on(r.threadid+"-atsign",function(){n.addMentionSymbolOnEditor(n,n)}),n.$on(r.mentionsTextarea,function(){t.addMentionSymbol(n,r.mentionsEvent)}),o.on("click keyup",function(e){t.handleEvent(e,n,r.mentionsEvent)}),o.on("keydown",function(o){!t.shouldHandleKeyDown(o.which)||38!=o.which&&40!=o.which&&13!=o.which||(o.preventDefault(),t.handleSelectKey(n,o.which),e.$broadcast("mentions-highlight-updated"))})}}]).directive("keyUp",function(){return function(e,t,n){t.on("keyup",function(t){13!=t.which&&32!=t.which&&37!=t.which&&38!=t.which&&39!=t.which&&40!=t.which&&e.$apply(function(){e[n.keyUp](t)})})}}).directive("keyUpDelayed",function(){return function(e,t,n){var o=_.debounce(function(){e.$apply(n.keyUpDelayed)},1e3);t.on("keyup",function(e){13!=e.which&&32!=e.which&&37!=e.which&&38!=e.which&&39!=e.which&&40!=e.which&&o()})}}).directive("enterKeyGetsVal",function(){return function(e,t,n){t.on("keydown",function(o){if(13==o.which)return e[n.enterKeyGetsVal](t.val()),void o.preventDefault()})}}).directive("sbPopover",function(){return function(e,t,n){t.ngInclude=n.sbPopover,e.$on("show-"+n.sbPopover,function(){})}}).directive("focusOnEvent",["$timeout",function(e){return function(t,n,o){function r(e){if("number"==typeof e.selectionStart)e.selectionStart=e.selectionEnd=e.value.length;else if("undefined"!=typeof e.createTextRange){e.focus();var t=e.createTextRange();t.collapse(!1),t.select()}}t.$on(o.focusOnEvent,function(t,o){touchEnabledDevice?n.focus():e(function(){n.focus(),o&&r(n[0])})})}}]).directive("focus",["$timeout",function(e){return function(t,n,o){e(function(){n.focus()})}}]).directive("select",["$timeout",function(e){return function(t,n,o){e(function(){n.select()})}}]).directive("focusOn",["$timeout",function(e){return function(t,n,o){uiutils.isMobile()||t.$on(o.focusOn,function(){e(function(){n.focus()})})}}]).directive("ngTokenizer",["$compile",function(e){return function(e,t,n){function o(e){return e.replace(/&/g,"&amp;").replace(r,function(e){return"&#"+e.charCodeAt(0)+";"}).replace(/</g,"&lt;").replace(/>/g,"&gt;")}var r=/([^\#-~| |!])/g,a=function(){return o(t.contents().filter(function(){return 3===this.nodeType}).text().trim())},i=function(){t.contents().filter(function(){return 3===this.nodeType}).remove()};e.candidateText=a,e.clearText=i,t.on("blur keyup change",function(){e.$apply(function(){t.contents().filter("br").remove(),e[n.ngTokenizer](t.contents())})}),t.on("keydown",function(n){return 13==n.which?void n.preventDefault():void(188===n.which&&(e.$apply(function(){e.completeToken(t,n)}),n.preventDefault()))}),n.typeahead&&e.$watch(e.accountEmails,function(){t.typeahead({source:e.accountEmails,text:a,selected:function(t){t&&e.$apply(function(){e.completeSelectedToken(t)})}})}),t.on("blur",function(n){e.$apply(function(){e.completeToken(t,n)})})}}]).directive("customHtml",["$compile","$timeout",function(e,t){return function(n,o,r){function a(e){if(e.focus(),"undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange){var t=document.createRange();t.selectNodeContents(e[0]),t.collapse(!1);var n=window.getSelection();n.removeAllRanges(),n.addRange(t)}else if("undefined"!=typeof document.body.createTextRange){var o=document.body.createTextRange();o.moveToElementText(e[0]),o.collapse(!1),o.select()}}n.$watch(r.customHtml,function(){var i=n[r.customHtml];o.html(e(i)(n)),""!=i&&o.append("&ensp;"),t(function(){a(o)})})}}]).directive("modalShowOnLoad",["$location","$rootScope",function(e,t){return function(n,o,r){o.on("hidden",function(r){r.target!=o[0]||t.$$phase||n.$apply(function(){e.path("/").search({})})}),n.$on("$routeChangeStart",function(){o.modal("hide")}),n.$on("$routeChangeSuccess",function(){o.modal("show")})}}]).directive("modalCloseOn",["$location","$rootScope",function(e,t){return function(t,n,o){t.$on(o.modalCloseOn,function(){n.modal("hide"),e.path("/").search({})})}}]).directive("pageClose",["$location",function(e){return function(t,n,o){Hammer(n[0]).on("tap",function(){e.path("/").search({}),t.$apply()})}}]).directive("scrollToBottomOn",["$timeout",function(e){return function(t,n,o){var r=n[0];o.$observe("scrollToBottomOn",function(n){t.$on(n,function(){e(function(){$(r).animate({scrollTop:r.scrollHeight},1e3)})})})}}]).directive("profileImgUpload",function(){return function(e,t,n){var o=[{action:"loadImageMetaData",disableExif:!1},{action:"loadImage",fileTypes:/^image\/(gif|jpeg|png)$/,maxFileSize:5e6},{action:"resizeImage",maxWidth:7200,maxHeight:7200,orientation:!0,forceResize:!0},{action:"saveImage"}];t.fileupload({dataType:"json",autoUpload:!1,maxNumberOfFiles:1,limitConcurrentUploads:1,dropZone:"nodrop"==n.profileImgUpload?null:$(document),pasteZone:"nodrop"==n.profileImgUpload?null:$(document),acceptFileTypes:/(\.|\/)(gif|jpe?g|png)$/i,maxFileSize:5e6,processQueue:o,disableImageResize:/Android(?!.*Chrome)|Opera/.test(window.navigator&&navigator.userAgent),add:function(n,o){var r=function(e){function n(){e.process(function(){return t.fileupload("process",e)}).done(function(){e.submit()})}try{n()}catch(e){t.fileupload(),n()}};switch(e.allowToUpload(o)){case 0:e.fileUploadStart(),o.url=e.uploadUrl(),t.fileupload(),o.files.length>0&&o.files[0].size>3e5?(o.autoUpload=!1,e.confirmSize(t,o,o.files[0].size,r)):r(o);break;case-1:e.fileUploadStart(),e.fileUploadFailed({errorThrown:"unauthorized"})}}}).on("fileuploaddrop",function(t,n){if(t.originalEvent){var o=null;t.originalEvent.delegatedEvent&&t.originalEvent.delegatedEvent.originalEvent?o=t.originalEvent.delegatedEvent.originalEvent:t.originalEvent.originalEvent&&(o=t.originalEvent.originalEvent),o&&e.fileUploadDropPosition(o.clientX,o.clientY)}}).on("fileuploadfail",function(t,n){e.fileUploadFailed(n)}).on("fileuploaddone",function(t,n){e.fileUploaded(n)})}}).directive("librarySettings",["DirectiveHelpers",function(e){return function(t,n,o){e.injectLibrary(t,n,o,{showOn:"show-library-settings",hideOn:"hide-library-settings",hideAlt1:"library-hide",showAlt1:"library-show-library_settings"},t.getTemplatePath())}}]).directive("imageLibrary",["DirectiveHelpers",function(e){return function(t,n,o){e.injectLibrary(t,n,o,{showOn:"show-image-library",hideOn:"hide-image-library",hideAlt1:"library-hide",showAlt1:"library-show-images"},t.getImageLibraryTemplatePath(),function(){t.loadImages()})}}]).directive("shapePath",function(){}).directive("shapeLibrary",["DirectiveHelpers",function(e){return function(t,n,o){t.setLibrary(o.shapeLibrary),e.injectLibrary(t,n,o,{showOn:"show-library-"+o.shapeLibrary,hideOn:"hide-library-"+o.shapeLibrary,hideAlt1:"library-hide",showAlt1:"library-show-"+o.shapeLibrary},t.getShapeLibraryTemplatePath(),function(){t.loadShapes()})}}]).directive("slideDrag",["$document","ImageProxyService",function(e,t){return function(n,o,r){function a(e){if(null!=e){var t=e.find(".pe-highlight-normal");t.removeClass("pe-highlight")}}function i(){for(var e=n.getSlides(),t=0;t<e.length;++t){var o=e[t];a(o)}}function c(e){for(var t=n.getSlides(),o=0;o<t.length;++o){var r=t[o];if(r!=b){var i=uiutils.getPosition(r);if(i.top<e&&e<i.top+i.height){var c=r.find(".pe-highlight-normal");c.addClass("pe-highlight"),a(b),b=r}}}}function s(e){if(e.preventDefault(),h=e.gesture.touches[0].screenX-p,g=e.gesture.touches[0].screenY-m,c(e.gesture.touches[0].clientY),o.css("visibility","hidden"),!y){var n=t.getProxy("slide");uiutils.applyPos(v,0,g,n)}}function l(){var e=t.getProxy("slide");uiutils.getPosition(e);u()}function u(){var e=t.getProxy("slide");e.css("display","none")}function d(t){Hammer(e[0]).off("drag",s),Hammer(e[0]).off("dragend",d),i(),o.css("visibility","visible");var r=o.data("slide-id"),a=b.data("slide-id");n.changeSlideOrder(r,a),l()}function f(n){n.preventDefault(),y=!1,h=0,g=0,m=n.gesture.touches[0].screenY-g;var r=t.getProxy("slide");r.html(o.find("svg").clone()),r.css("display","inline-block"),v=uiutils.getPosition(o),uiutils.applyPos(v,p,m,r),Hammer(e[0]).on("drag",s),Hammer(e[0]).on("dragend",d)}var p=0,m=0,h=0,g=0,v={left:0,top:0},y=!1,b=null;n.addSlide(o),Hammer(o[0]).on("dragstart",f)}}]).directive("dragProxy",["$document","ImageProxyService",function(e,t){return function(n,o,r){function a(){var e=t.getProxy(n.getProxyName());e.css("display","none")}function i(r){r.preventDefault(),b=!1,f=0,p=0,u=r.gesture.touches[0].clientX-f,d=r.gesture.touches[0].clientY-p;var a=t.getProxy(n.getProxyName());"img"==n.getProxyName()?a.attr("src",o.attr("src")):a.html(o.find("svg").clone()),a.css("display","inline-block"),m=h(o),g(u,d),Hammer(e[0]).on("drag",c),Hammer(e[0]).on("dragend",l)}function c(e){e.preventDefault(),f=e.gesture.touches[0].clientX-u,p=e.gesture.touches[0].clientY-d,b||g(f,p)}function s(){var e=t.getProxy(n.getProxyName()),o=h(e),r=o.left>y.left;if(!b&&!r){var i=n.img;"img"==n.getProxyName()?n.addImage(i,o.left,o.top):n.addShape(n.shape,o.left,o.top)}a()}function l(t){Hammer(e[0]).off("drag",c),Hammer(e[0]).off("dragend",l),s()}var u=0,d=0,f=0,p=0,m={left:0,top:0};o.css({cursor:"pointer"});var h=function(e){var t=e[0];return $.extend({},"function"==typeof t.getBoundingClientRect?t.getBoundingClientRect():{width:t.offsetWidth,height:t.offsetHeight},e.offset())},g=function(e,o){var r=t.getProxy(n.getProxyName());r.css({top:m.top+o+"px",left:m.left+e+"px"})},v=angular.element(r.dragProxy),y=h(v),b=!1;cancelStream.onValue(function(){b=!0,a()}),Hammer(o[0]).on("dragstart",i)}}]).directive("guide",function(){return function(e,t,n){e.hideGuide=function(){t.hide()},e.show=function(){t.show()},angular.element(document).on("touchstart",function(e){t.hide()})}}).directive("feedback",["$document",function(e){return function(e,t,n){isTouch()||t.css({display:"block"})}}]).directive("showPreview",function(){return function(e,t,n){t.on("mouseover",function(){t.tooltip({html:!0,placement:"bottom",title:'<img src="'+n.showPreview+'" width="300px">'})})}}).directive("showBoardDetails",["$filter",function(e){return function(t,n,o){var r=e("date")(o.updatedat,"'Updated: 'dd.MM.yyyy 'at' HH.mm"),a="";"true"===o.public?a="Public board":"true"!==o.public&&"true"===o.private?a="Private board":"true"!==o.public&&"true"!==o.private&&(a="Team board");var i=function(){var e=25;return o.team.length>e?_.first(o.team,e).join("")+"...":o.team};n.tooltip({html:!0,placement:"top",title:"<div style='text-align:left;'>"+r+"</div><div style='text-align:left;'>Owner: "+o.owner+"</div><div style='text-align:left;'>Visibility: "+a+"</div><div style='text-align:left;overflow:hidden;'>Team: "+i()+"</div>"})}}]).directive("stripeCheckout",["$compile",function(e){return function(t,n,o){var r='<form action="{{stripeAction()}}" class="hidden" method="POST"><input type="hidden" name="boardid" value="{{currentBoard.boardId}}"><input type="hidden" name="account" value="{{currentAccountHash()}}"></form>',a=angular.element(r);$("body").append(a),e(a)(t),$.getScript("https://checkout.stripe.com/checkout.js",function(){var e=StripeCheckout.configure({key:o.key,image:"/static/images/sketchoboardme-logo-128x128.png",allowRememberMe:!1,token:function(e,t){a.append('<input type="hidden" name="stripeToken" value="'+e.id+'">'),a.append('<input type="hidden" name="stripeEmail" value="'+e.email+'">'),a.submit()}});n.on("click",function(t){_trackGA("send","event","open-stripe","payment","subscribe"),e.open({name:"Sketchboard",description:"Sketchboard Subscription",panelLabel:o.panelLabel}),t.preventDefault()})})}}]).directive("stripeUpdateCreditCard",["$compile",function(e){return function(e,t,n){$.getScript("https://checkout.stripe.com/checkout.js",function(){var o=StripeCheckout.configure({key:n.key,image:"https://s3-eu-west-1.amazonaws.com/pub.sketchboard.io/img/logo-144x144.png",allowRememberMe:!1,token:function(t,n){e.saveCreditCard(t)}});t.on("click",function(e){_track("addcc",{category:"popup",label:"subscription"}),o.open({name:"Sketchboard",description:n.panelTitle,panelLabel:n.panelLabel,zipCode:!0,billingAddress:!0}),e.preventDefault()})})}}]).directive("conversionSubs",["$window",function(e){return function(t,n,o){var r=function(){var n=e;n.google_conversion_id=1012845830,n.google_conversion_label="98jgCOi81mYQhpr74gM",n.google_conversion_value=1;try{n.google_conversion_value=t.priceInfo.total}catch(e){console.error("Failed to set price info")}n.google_conversion_currency="USD",n.google_remarketing_only=!1};t.goog_report_conversion_subs=function(t){r(),e.google_conversion_format="3";var n=new Object;n.onload_callback=function(){"undefined"!=typeof t&&(e.location=t)};var o=e.google_trackConversion;"function"==typeof o&&o(n)},$.getScript("//www.googleadservices.com/pagead/conversion_async.js",function(){console.log("conversion configured")})}}]).directive("freeNotOwnedBoard",["$compile","boardmenu",function(e,t){return function(n,o,r){o.append(angular.element(t.freeNotOwnedBoard)),e(o.contents())(n)}}]).directive("onClickSelect",function(){return function(e,t,n){t.click(function(){t.select()})}}).directive("closeDialog",["$rootScope","$location",function(e,t){return function(n,o,r){function a(){n.done=!0,t.path("/")}function i(){n.$apply(function(){a()})}e.$on(r.closeDialog,function(){a()}),cancelStream.onValue(function(){i()}),o.on("click",function(){i()})}}]).directive("delayPlay",[function(){return function(e,t,n){function o(n){setTimeout(function(){try{t[0].play(),e.$digest()}catch(e){}},n)}t[0].addEventListener("ended",function(){o(3e3)}),o(2e3)}}]).directive("step",function(){return function(e,t,n){0==parseInt(n.step)&&t.addClass("step-focus"),e.$on("step-changed",function(e,o){o==parseInt(n.step)?t.addClass("step-focus"):t.removeClass("step-focus")})}}).directive("tour",function(){return function(e,t,n){var o=window.streamStartTour.onValue(function(){o(),t.addClass("overlay"),t.removeClass("hide")}),r=window.streamEndTour.onValue(function(){r(),t.addClass("hide")})}}).directive("copyText",["$timeout",function(e){return function(t,n,o){var r=new ClipboardJS(n[0]);r.on("error",function(e){Hammer(n[0]).on("tap",function(){window.prompt("1. Copy to clipboard: Cmd/Ctrl+C, Enter.\n2. Send link e.g. by email.",t.currentBoardLink())})});var a=o.title;n.tooltip({trigger:"hover",placement:"top",container:"body"}),r.on("success",function(t){n.attr("data-original-title",o.copiedHint),n.tooltip("show"),e(function(){n.tooltip("hide"),n.attr("data-original-title",a)},4500)})}}]).directive("copyTextSimple",["NotifyService",function(e){return function(t,n,o){var r=new ClipboardJS(n[0]);r.on("error",function(e){Hammer(n[0]).on("tap",function(){window.prompt("1. Copy to clipboard: Cmd/Ctrl+C, Enter.\n2. Send link e.g. by email.",t.currentBoardLink())})}),r.on("success",function(n){t.$apply(function(){e.info(o.copiedHint)})})}}]).directive("tourTip",["$timeout",function(e){return function(t,n,o){function r(n,o){var r=2500;o&&(r=1e3*parseInt(o)),e(function(){t.$broadcast("tour-tip"+(n+1))},r)}var a=parseInt(o.tourTip);1==a?r(a,o.tourDelay):n.hide(),t.$on("tour-tip"+o.tourTip,function(){n.show(),r(a,o.tourDelay)})}}]).directive("tipper",["$compile","$http",function(e,t){return function(n,o,r){function a(){var t=angular.element("#TipContainer"),o=t.find(".popover-content");e(o)(n)}var i=angular.element('<div class="tip-pulse pulse"></div>'),c=$.extend({},o.offset(),{height:o[0].offsetHeight});$("body").append(i);var s=c.left-1*i[0].offsetWidth/2,l=c.top-1*i[0].offsetHeight/2;r.tipBelow&&(s=c.left-i[0].offsetWidth/2,l=c.top+c.height-1*i[0].offsetHeight/2),i.css({top:l,left:s});var u=o,d="top";r.popoverTargetSelector&&(u=angular.element(r.popoverTargetSelector)),r.tipPlacement&&(d=r.tipPlacement);var f=null;if(Hammer(i[0]).on("tap",function(){f?(u.popover("show"),a()):t.get(r.tipContent).then(function(e){f=u.popover({html:!0,title:r.tipTitle,content:e.data,placement:d,trigger:"manual",container:"#TipContainer"}),u.popover("show"),a()})}),n.$on("hide-tip",function(){u.popover("hide"),i.hide()}),r.tipOnStream){i.hide();var p=null;p=_.has(globalStreams,r.tipOnStream)?globalStreams[r.tipOnStream]:window[r.tipOnStream];var m=p.onValue(function(){i.show(),m()})}e(i)(n)}}]).directive("offline",function(){return function(e,t,n){function o(){"function"==typeof window.isMaintenance?window.isMaintenance().then(function(n){e.releaseOn(n),e.$digest(),t.show()}).catch(function(n){n&&n.responseText&&console.error("offline directive:",n.responseText),e.releaseFalse(),t.show()}):t.show()}globalStreams.onlineStream.onValue(function(e){e?t.hide():o()}),globalStreams.cometSessionStream.onValue(function(e){e?t.hide():o()})}}).directive("localStorageNotSupported",function(){return function(e,t,n){webStorage.browserSupportsLocalStorage&&t.hide(),globalStreams.webStorageSupportedStream.onValue(function(e){e?t.hide():t.show()})}}).directive("localStorageSupported",function(){return function(e,t,n){webStorage.browserSupportsLocalStorage&&t.show(),globalStreams.webStorageSupportedStream.onValue(function(e){e?t.show():t.hide()})}}).directive("showOn",["$rootScope",function(e){return function(t,n,o){e.$on(o.showOn,function(){n.show()})}}]).directive("hideOn",["$rootScope",function(e){return function(t,n,o){e.$on(o.hideOn,function(){n.hide()})}}]).directive("onFocus",["$rootScope",function(e){return function(t,n,o){n.on("focus",function(){t.$apply(function(){e.$broadcast(o.onFocus)})})}}]).directive("scrollToBottomOn",["$rootScope","$timeout",function(e,t){return function(n,o,r){e.$on(r.scrollToBottomOn,function(){t(function(){o.each(function(e){this.scrollTop=this.scrollHeight})},100)})}}]).directive("hideOnOffline",function(){return function(e,t,n){globalStreams.onlineStream.onValue(function(e){e?t.show():t.hide()})}}).directive("hideIfReadOnly",function(){return function(e,t,n){function o(){t.css({display:"none"})}function r(){t.css({display:"none"})}var a=[],i=globalStreams.boardLoadedWrapStream.onValue(function(){var e=gwtIsEditable();e||o()});i&&a.push(i),a.push(globalStreams.onlineStream.onValue(function(e){var t=gwtIsEditable();t&&e?r():o()})),t.on("$destroy",function(){_.each(a,function(e){e()})})}}).directive("doubleEscExec",[function(){return function(e,t,n){globalStreams.doubleCancelStream.onValue(function(){e.$apply(n.doubleEscExec)})}}]).directive("doubleCancelHides",["$rootScope","$location",function(e,t){return function(e,n,o){globalStreams.doubleCancelStream.onValue(function(){t.path("/")})}}]).directive("hideClickedOutside",["$location","$timeout","Helpers",function(e,t,n){return function(o,r,a){function i(t){e.path()===a.hideClickedOutside&&n.isOutsideElement(r,t.target)&&(o.$apply(function(){e.path("/").search({})}),Hammer(document).off("tap",i))}t(function(){o.$on("$routeChangeStart",function(){Hammer(document).off("tap",i)}),Hammer(document).on("tap",i)})}}]).directive("onHoverChangePath",["$location",function(e){return function(t,n,o){n.on("mouseover",function(){t.$apply(function(){e.path("/"+o.onHoverChangePath)})})}}]).directive("tapOpen",["$location","$timeout",function(e,t){return function(n,o,r){Hammer(o[0]).on("tap",function(){n.$apply(function(){t(function(){r.tapOpenUri?location.href=r.tapOpen:e.path(r.tapOpen)})})})}}]).directive("chatButton",function(){return function(e,t,n){globalStreams.clearChatStateStream.onValue(function(){function n(){t.removeClass("highlight");var e=t.find("i");e.removeClass("main-ico-chat-white"),e.addClass("main-ico-chat")}e.$$phase?n():e.$apply(function(){n()})}),globalStreams.newChatMessageStream.onValue(function(){e.$apply(function(){t.addClass("highlight");var e=t.find("i");e.addClass("main-ico-chat-white"),e.removeClass("main-ico-chat")})})}}).directive("commentsButton",["$rootScope","$location","URLParser","Comments2Factory",function(e,t,n,o){return function(r,a,i){function c(){a.removeClass("highlight");var e=a.find("i");e.removeClass("main-ico2-comments-white")}e.$on("comment.create",function(n,r){if("/comments2"!==t.path()&&r.site_id!==gwtGetSiteId()){a.addClass("highlight");var i=a.find("i");i.addClass("main-ico2-comments-white");var s=o.findThread(r.thread.threadid);if(s.open)c();else var l=e.$on("open."+r.thread.threadid,function(){c(),l()})}}),e.$on("$locationChangeStart",function(e,t,o){var r=n.parseURL(t);"#/comments2"===r.hash&&c()})}}]).directive("miniThread",["$rootScope","$location","Comments2Factory","URLParser",function(e,t,n,o){return function(t,r,a){function i(){r.removeClass("highlight");
var e=r.find("i");e.addClass("menu-icon-comments"),e.removeClass("context-icon2-comment")}t.$on("new.comment."+t.thread.threadid,function(e,t){var o=n.findThread(t.thread.threadid);if(!o.open&&t.site_id!==gwtGetSiteId()){r.addClass("highlight");var a=r.find("i");a.removeClass("menu-icon-comments"),a.addClass("context-icon2-comment")}}),e.$on("open."+t.thread.threadid,function(){i()}),e.$on("$locationChangeStart",function(e,t,n){var r=o.parseURL(t);"#/comments2"===r.hash&&i()})}}]).directive("menuShortcut",["Helpers",function(e){return function(t,n,o){var r="";r=e.isMac()?"⌘"+o.menuShortcut:"Ctrl+"+o.menuShortcut,n.append('<span class="menu-shortcut">'+r+"</span>")}}]).directive("tooltipShortcut",["Helpers",function(e){return function(t,n,o){var r="";r=e.isMac()?" | ⌘"+o.tooltipShortcut:" | Ctrl+"+o.tooltipShortcut;var a=n.attr("title");n.attr("title",a+r)}}]).directive("openOrClose",["$location",function(e){return function(t,n,o){try{Hammer(n[0]).on("tap",function(){t.$apply(function(){e.path()===o.openOrClose?e.path("/").search({}):e.path(o.openOrClose)})})}catch(e){log.error(e)}}}]).directive("impress",["$location","$window","PresentationService",function(e,t,n,o){return function(t,o,r){var a=[],i=o.find(".presentation");a.push(cancelStream.onValue(function(){t.$apply(function(){e.path("/").search({})})})),a.push(globalStreams.quitPresentationStream.onValue(function(){t.$apply(function(){n.quit(),e.path("/").search({})})})),a.push(globalStreams.editPresentationStream.onValue(function(){t.$apply(function(){o.find(".presentation");n.quit(),e.path("/presentation-edit").search({})})})),n.play();var c=$('<iframe class="presentation-frame" src="/partials/presentation-frame.html"></iframe>');i.append(c),a.push(globalStreams.presentationCommandStream.onValue(function(e){"next"===e.cmd?c[0].contentWindow.presentation.nextSlide():"prev"===e.cmd&&c[0].contentWindow.presentation.prevSlide()})),o.on("$destroy",function(){_.each(a,function(e){e()})}),c.load(function(){function e(){var e=gwtGetSlides(t,o,!1),n=_.sortBy(e.slides,function(e){return e.data.order}),r=null,a=0,i=0,s=0,l=_.map(n,function(e){var n=e.width,c=e.height,l=t/n,u=o/c,d=l<u?l:u;d>1&&(d=1);var f=e.left,p=e.top,m=e.width,h=e.height;e.sleft=f,e.stop=p,e.swidth=m,e.sheight=h,e.sleft=a,e.left=a,a+=4*t,e.stop=i,e.top=i,i+=4*o,r=e;var g='<div class="step" data-x="'+e.left+'" data-y="'+e.top+'" data-scale='+d+' data-z="'+s+'">'+e.svg+"</div>";return s+=6*o,g}),u=e.width/t,d=e.height/o,f=9007199254740992,p=9007199254740992,m=0,h=0,g=!0;_.each(n,function(e){(g||e.sleft<f)&&(f=e.sleft),(g||e.stop<p)&&(p=e.stop);var t=e.sleft+e.swidth;(g||t>m)&&(m=t);var n=e.stop+e.sheight;(g||n>h)&&(h=n),g=!1}),f+=(m-f)/3,p+=(h-p)/3;c[0].contentWindow.presentation.setSlides(l),c[0].contentWindow.focus()}var t=$(window).width(),o=$(window).height();try{e()}catch(t){console.log("failed to load slides...",t),a.push(boardLoadedStream.onValue(function(){e(),n.play()}))}})}}]).directive("d3",function(){return function(e,t,n){$.cachedScript("/static/resources-static-1/js/app/lib/d3.js").done(function(e,t){console.log("d3 loaded...")})}}).directive("slideSvg",function(){return function(e,t,n){try{if(_.isArray(e.slide))_.isArray(e.slide)&&(t.empty(),t.append(e.slide[0].documentElement));else{var o=new DOMParser,r=o.parseFromString(e.slide.svg,"image/svg+xml");e.slide.documentElement=r.documentElement,t.empty(),t.append(e.slide.documentElement)}}catch(e){}}}).directive("documentState",[function(){return function(e,t,n){var o,r=!0;globalStreams.boardSaveStatusChangedStream.onValue(function(){r&&t.css("display","inline-block"),o&&clearTimeout(o),r=!1;var n=gwtIsSaved();n&&(e.savingTakesTime=!1),e.$$phase?e.setStatus(n):(e.setStatus(n),e.$digest()),o=setTimeout(function(){e.savingTakesTime=!0,e.$digest()},5e3)})}}]).directive("tagEditor",["$timeout",function(e){return function(t,n,o){var r=angular.element('<input class="tag-editor" placeholder="+ Tag" maxlength="50">');t.$on("clear-input",function(){r.val("")}),r.on("keydown",function(e){if(13==e.which){var a=n.find(".typeahead");if(a&&!a.is(":visible"))return t.$apply(function(){t[o.tagEditor](r.val())}),void e.preventDefault()}}),e(function(){r.focus()}),r.typeahead({source:t.searchTags,text:function(){return r.val()},matcher:function(e){return e},selected:function(e){e&&t.$apply(function(){r.val(e),t.select(e)})}}),n.append(r)}}]).directive("showCaretMenu",["Helpers",function(e){return function(t,n,o){function r(t){e.isOutsideElement(i,t.target)&&(c&&c.hide(),i.hide(),a=!1,Hammer(document).off("tap",r))}var a=!1,i=n.find(".caret-menu"),c=null;i&&i.hide(),n.on("mouseover",function(){i.show()}),n.on("mouseout",function(){a||i.hide()}),i.on("click",function(){c=angular.element("#tag-menu");var e=c.scope();e&&e.setTagName(o.showCaretMenu);var t=i.offset();c.css({left:t.left,top:t.top+i[0].offsetHeight}),c.show(),a=!0,Hammer(document).on("tap",r)})}}]).directive("threadCommentEdit",["$compile","$timeout",function(e,t){return function(n,o,r){var a=$("<form class='pure-form pure-form-stacked' ng-submit='updateComment(editData)'><fieldset><textarea class='pure-input-1' ng-model='editData.commentEdited' auto-resize enter-cmd='updateComment(editData)' mentions-textarea='{{editData.comment.id + \"-edit-comment\"}}'></textarea><a \t\t\tclass='pure-button mention-button' title='Add mention to notify others about the comment' add-mentions-symbol='{{editData.comment.id + \"-edit-comment\"}}'>@</a> <button class='pure-button pure-button-primary'>Comment</button> <a class='pure-button' ng-click='hideCommentEdit(\"hide-comment-edit\")'>Cancel</a></fieldset></form>");n.$on("hide-comment-edit",function(){o[0].parentNode.querySelector(".comment-section").style.display="block";var e=angular.element(a[0]).scope();e&&e.$destroy(),a.remove()}),n.$on("main-comments-closed",function(){n.editData&&n.$parent.$parent.updateComment(n.editData)}),n.$on("edit-"+r.threadCommentEdit,function(r,i){o[0].parentNode.querySelector(".comment-section").style.display="none";var c=n.$new();c.editData=i,c.editData.commentEdited=i.comment.comment_text,o.append(a),e(a)(c),t(function(){n.$broadcast("do-auto-resize");var e=a.find("textarea");e&&e.focus()})})}}]).directive("hideOnCommentEdit",function(){return function(e,t,n){e.$on("cancel-edit-"+n.hideOnCommentEdit,function(){t.show()}),e.$on("bedit-"+n.hideOnCommentEdit,function(e){t.hide()})}}).directive("boardCommentEdit",["$compile","$timeout","$http",function(e,t,n){return function(o,r,a){function i(n){c=$(n),r.append(c),e(c)(o),t(function(){o.$broadcast("do-auto-resize");var e=c.find("textarea");e&&e.focus()})}var c=null;o.$on("cancel-edit-"+a.boardCommentEdit,function(){c&&(c.remove(),c=null)}),o.$on("bedit-"+a.boardCommentEdit,function(e){var t=r[0].querySelector("textarea");t||n.get("/partials/board-comment-editor.html",{cache:!0}).then(function(e){i(e.data)})})}}]).directive("boardThreadReply",["$compile","$http","$timeout",function(e,t,n){return function(o,r,a){function i(t){s||(c=$(t),r.append(c),e(c)(o),n(function(){o.$broadcast("do-auto-resize");var e=c.find("textarea");e&&e.focus()}))}var c=null,s=!1;o.$on("hide-reply-thread."+a.boardThreadReply,function(){c.remove(),c=null,s=!1}),o.$on("breply-"+a.boardThreadReply,function(e){t.get("/partials/thread-reply.html",{cache:!0}).then(function(e){i(e.data),s=!0})})}}]).directive("threadMenu",["Helpers",function(e){return function(e,t,n){function o(n,o,a){e.currentCommentScope={comment:o,thread:a};var i=n.offsetLeft,c=document.querySelector(".comments-area"),s=n.offsetTop-c.scrollTop;animate({el:t,begin:function(){t.css({visibility:"hidden",display:"inline-block"}),t.css({left:i-t[0].offsetWidth+n.offsetWidth,top:s+n.offsetHeight,visibility:"visible"})},opacity:[0,1],scaleX:[.8,1],scaleY:[.8,1],duration:300,complete:function(){Hammer(document).on("tap",r)}})}function r(){animate({el:t,scaleX:[1,.8],scaleY:[1,.8],opacity:[1,0],duration:300,complete:function(e){e.forEach(function(e){e.style.display="none"}),Hammer(document).off("tap",r)}})}e.$on("open-thread-menu",function(e,n){t.is(":visible")?r():o(n.targetEvent.currentTarget,n.comment,n.thread)})}}]).directive("commentOptionsMenu",function(){return function(e,t,n){function o(n,o,a){e.currentCommentScope={comment:o,thread:a};var i=$(n),c=i.parents(".comment-thread"),s=c.position(),l=c.find(".thread-section"),u=l.position(),d=i.position(),f=s.left+u.left+d.left,p=s.top+u.top+d.top,m=gwtGetScaleFactor();f/=m,p/=m,animate({el:t,begin:function(){t.css({visibility:"hidden",display:"inline-block"}),t.css({left:f,top:p+n.offsetHeight,visibility:"visible"})},opacity:[0,1],scaleX:[.8,1],scaleY:[.8,1],duration:300,complete:function(){Hammer(document).on("tap",r)}})}function r(){animate({el:t,scaleX:[1,.8],scaleY:[1,.8],opacity:[1,0],duration:300,complete:function(e){e.forEach(function(e){e.style.display="none"}),Hammer(document).off("tap",r)}})}e.$on("open-comment-options-menu",function(e,n){t.is(":visible")?r():o(n.targetEvent.currentTarget,n.comment,n.thread)}),o(e.$parent.currentCommentScope.targetEvent.currentTarget,e.currentCommentScope.comment,e.currentCommentScope.thread)}}).directive("mentionsPopup",["MentionsPopup","MentionsEditor",function(e,t){return function(t,n,o){function r(t,o,r){var a=$(t),i=a.parents(".comment-thread"),c=i.position();if(!c)return void console.error("mentions-popup: invalid structure");var s=i.find(".thread-section"),l=s.position(),u=a.position(),d=c.left+l.left+u.left,f=c.top+l.top+u.top+t.offsetHeight,p=gwtGetScaleFactor();d/=p,f/=p,e.show(n,d,f)}e.onEvents(t,n,o.mentionsEvent,r)}}]).directive("mentionsPopup2",["MentionsEditor","MentionsPopup",function(e,t){return function(e,n,o){function r(e){var o=($(e),e.getBoundingClientRect()),r=o.left,a=o.top+e.offsetHeight;t.show(n,r,a)}t.onEvents(e,n,"open-mentions-selector",r)}}]).directive("popupEffect",function(){return function(e,t,n){t.show()}}).directive("showEffect",["$timeout",function(e){return function(t,n,o){var r=!1;t.$on(o.showEffect,function(){r?animate({el:n,opacity:[1,0],scaleX:[1.05,.8],scaleY:[1.05,.8],duration:200,easing:"easeOutQuad",complete:function(e){e.forEach(function(e){e.style.display="none"}),n[0].dataset.closeCallback&&t[n[0].dataset.closeCallback]()}}):(n[0].dataset.showCallback&&t[n[0].dataset.showCallback](),animate({el:n,opacity:[0,1],scaleX:[1.05,1],scaleY:[1.05,1],duration:300,easing:"easeInQuad",begin:function(e){e.forEach(function(e){e.style.display="block"})},complete:function(){t.$broadcast("do-auto-resize");var o=n.find("textarea");o&&e(function(){o.focus()})}})),r=!r})}}]).directive("autoResize",[function(){return function(e,t,n){function o(e,t){t&&(e.style.height="1px"),""!==n.autoResize&&(e.style.height=n.autoResize),e.scrollHeight<130?e.style.height=1+e.scrollHeight+"px":(e.style.height="130px",e.style.overflow="auto")}t[0].style.overflow="hidden",t.on("keyup",function(e){o(t[0])}),e.$on("do-auto-resize",function(){o(t[0],!0)})}}]).directive("formAutoButtons",["$timeout","Helpers",function(e,t){return function(n,o,r){function a(){var e=o[0].querySelectorAll(".pure-button");t.domArray(e).forEach(function(e){animate({el:e,duration:100,opacity:[1,0],easing:"easeInOutQuart",complete:function(){e.style.display="none"}})})}function i(e){t.domArray(e).forEach(function(e){animate({el:e,duration:100,opacity:[0,1],easing:"easeInOutQuart",complete:function(){e.style.display="inline-block"}})})}n.$on(r.formAutoButtons,function(){a()});var c=t.domArray(o[0].querySelectorAll(".pure-button"));c.forEach(function(e){e.style.display="none"}),t.domArray(o[0].querySelectorAll("textarea")).forEach(function(t){t.addEventListener("focus",function(e){i(o[0].querySelectorAll(".pure-button"))}),t.addEventListener("blur",function(t){var n=o[0].querySelector("textarea");n&&0==n.value.length&&e(function(){a()})})})}}]).directive("threadReply",["$timeout",function(e){return function(t,n,o){function r(){n[0].style.display="block",e(function(){var e=n[0].querySelector("textarea");e&&e.focus()})}t.thread.comments.length<2&&(n[0].style.display="none"),t.$on("main-comments-closed",function(){t.thread&&t.saveReply(t.thread)}),t.$on(o.threadReply,function(e,t){r()}),t.replyThreadId===o.threadReply&&r()}}]).directive("markdownInit",function(){return function(e,t,n){boardLoadedStream.onValue(function(){$.cachedScript(_config.staticPrefix+"/resources-static-1/js/app-keep/lib/marked-0.3.3.min.js").done(function(t,n){e.$broadcast("markdown-lib-loaded")})})}}).directive("showFreePlan",["AuthService",function(e){return function(t,n,o){e.currentBoard().isBoardAccountExpired()?n.show():n.hide()}}]).directive("themeChanged",[function(){return function(e,t,n){themeChangedStream.onValue(function(e){var n=t.attr("class");t.attr("class",n.replace(/theme-\S+/,"theme-"+e))})}}]).directive("boardComments",function(){return function(e,t,n){e.$on("comments-loaded",function(t){e.commentThreads.forEach(function(e){console.log("thread",e)})})}}).directive("commentThread",["$timeout","CommentPositionFactory","Comments2Factory",function(e,t,n){return function(e,o,r){function a(e){var n=t.position(e,c);o.left===n.left&&o.top===n.top||o.css({left:n.left,top:n.top})}o.css({pointerEvents:"auto"});var i=uiutils.getPosition(o),c=i.width;o.left=0,o.top=0,e.thread.dimension&&(e.$on("changed."+e.thread.threadid,function(e,t){t.dimension?(a(t),o.show()):o.hide()}),e.$on("hide."+e.thread.threadid,function(e,t){o.hide()}),e.$on("thread.resolved.animate."+e.thread.threadid,function(e,t){var n=$("#thread-resolved-target"),r=o.find(".thread-section"),a=uiutils.getPosition(n),i=uiutils.getPosition(o),c=gwtGetScaleFactor(),s=.2,l=(a.left-i.left+r.width()*s)/c,u=(a.top-i.top)/c;animate({el:o,translateX:l,translateY:u,scaleX:s,scaleY:s,easing:"easeOutExpo",begin:function(){o.css({transformOrigin:"left top"})},complete:function(){t.done()}})}),e.$on("scrollToBottom."+e.thread.threadid,function(e,t){var n=o.find("ul");n.each(function(e){this.scrollTop=this.scrollHeight})}),e.$on("minimize."+e.thread.threadid,function(t,r){var a=o.find(".thread-section");a&&animate({el:a,opacity:[1,0],scaleX:[1,.5],scaleY:[1,.5],translateX:["0","50%"],translateY:["0","-30%"],duration:300,easing:"easeOutExpo",begin:function(){},complete:function(){e.$apply(function(){n.openThread(r,!1)})}})}),a(e.thread))}}]).directive("createComment",["$http","$timeout","$compile",function(e,t,n){return function(o,r,a){function i(e,n){r.show(),r.addClass("show-before");var a=$(n),i=uiutils.getPosition(a);r.css({left:i.left-e[1].offsetWidth+72,top:i.top+a.height()+18}),t(function(){o.$broadcast("do-auto-resize");var t=e.find("textarea");t&&t.focus()})}function c(e,t){s=$(e),r.append(s),i(s,t),n(s)(o)}var s=null;r.addClass("hide-before"),o.$on("hide-create-thread",function(){r.hide(),r.removeClass("show-before"),r.addClass("hide-before")}),o.$on("create-comment-thread",function(t,n){s?i(s,n):e.get("/partials/create-comment-editor.html",{cache:!0}).then(function(e){c(e.data,n)})})}}]).directive("htmlLayer",["$window",function(e){return function(e,t,n){function o(){var e=gwtGetTransform(),n=e.matrix.dx.toFixed(8),o=e.matrix.dy.toFixed(8);t.css({transform:"matrix("+e.matrix.xx.toFixed(8)+","+e.matrix.yx.toFixed(8)+","+e.matrix.xy.toFixed(8)+","+e.matrix.yy.toFixed(8)+","+n+","+o+")"})}t.css({zIndex:5,position:"fixed",left:0,top:0,pointerEvents:"none",transformOrigin:"0 0"}),globalStreams.backgroundMoveStream.onValue(function(e){"start"===e.type||("move"===e.type?o():"end"===e.type&&o())}),globalStreams.scaleAtStream.onValue(function(e){o()}),globalStreams.surfaceTransformStream.onValue(function(e){o()})}}]),angular.module("myApp.factories",[]).factory("UserInfo",["$rootScope","accountType",function(e,t){function n(){}n.prototype.isTrial=function(){return this.defaultAccountType===t.trial},n.prototype.isDefaultAccountExpired=function(){return this.defaultAccountExpired},n.prototype.updateDefaultAccountType=function(t){this.defaultAccountType=t,e.$$phase||e.$apply()},n.prototype.isLoggedIn=function(){return this.loggedIn};var o=4,r=8;return n.prototype.isShowBoardUsers=function(){return!((this.properties&o)===o)},n.prototype.isLibraryManualShowHide=function(){return(this.properties&r)===r},n.prototype.isAccountRoleReadOnly=function(){return 2===this.accountRole},n.prototype.isAccountRoleAdminOrPrimaryOwner=function(){return 1===this.accountRole||3===this.accountRole},n.prototype.isAnonymous=function(){return"undefined"==typeof this.email},n.prototype.isGoogleUser=function(){return 2==this.authType},n}]).factory("MentionsEditor",["$rootScope","BoardUsers",function(e,t){function n(t,n,o){var i=t.getSelectionEnd(),c=t.textAreaValue().slice(0,i),s=t.textAreaValue().slice(i),u=/(^[^\s\n;,?!:]+)/.exec(s);u&&u.length>=2&&(c+=u[1],s=s.slice(u[1].length));var d=c.replace(/\S*@([^\s\n;,?!:]*)$/,"@"+n);0==s.length&&(s=" "),t.setTextareaValue(d+s),r(t,d.length+1);var f=a(o);return e.$broadcast(f),l=!1,t.$$phase||t.$digest(),l}function o(e){e.length>0&&"@"==e[0]&&(e=e.slice(1));var e=e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&"),t=c.filter(function(t){var n=new RegExp("("+e+")","ig").exec(t.mention);return n});return t}function r(e,t){setTimeout(function(){e.setCursorPosition(t),e.$broadcast("do-auto-resize"),e.textAreaFocus()},50)}function a(e){return e?"hide-"+e:f}var i,c=[],s=[],l=!1,u=0,d="open-mentions-selector",f="hide-open-mentions-selector",p={init:function(e){t.accountUsersForBoard(function(){c=[{mention:"team",display:"@team",help:"Notify everyone in this team"},{mention:"thread",display:"@thread",help:"Notify everyone in this comment thread"},{mention:"mute",display:"@mute",help:"Email notifications are not sent"}],t.mates.forEach(function(e){c.push({mention:e.email,display:e.email,help:""})}),s=c})},handleEdit:function(t,n){var r=t.getSelectionEnd(),i=t.textAreaValue().slice(0,r),c=i.match(/\S*@[^\s\n;,?!:]*$/m),f=c?c[0]:null,p=a(n);if(f)if(s=o(f),u>=s.length&&(u=0),u<0&&(u=0),0==s.length)e.$broadcast(p),l=!1;else{l||(u=0),l=!0;var m=n?n:d;e.$broadcast(m,{elem:t.getTextareaElement()})}else e.$broadcast(p),l=!1;return l},addMentionSymbol:function(t,n){var a=t.getSelectionEnd(),i=t.textAreaValue().slice(0,a),c=t.textAreaValue().slice(a);i.length>0&&!i.match(/\s$/)&&(i+=" "),t.setTextareaValue(i+"@"+c),s=o("@");var u=n?n:d;return e.$broadcast(u,{elem:t.getTextareaElement()}),r(t,(i+"@").length),t.$$phase||t.$digest(),l},handleSelectKey:function(e,t,o){switch(t){case 38:return s.length>1&&--u,l;case 40:return u<s.length-1&&++u,l;case 13:if(u>=0&&u<s.length)return n(e,s[u].mention,o)}},addMention:function(e,t){i&&n(i,e,t)},shouldHandleKeyDown:function(e){return s&&1==s.length?13==e:l},handleEvent:function(e,t,n){p.handleEdit(t,n)},getSelectionIndex:function(){return u},getMentions:function(){return s},hide:function(){l=!1,u=0,i=null},setCurrentTextArea:function(e){var t=angular.element(e).scope();t&&(i=t)}};return p}]).factory("MentionsPopup",["MentionsEditor",function(e){var t={onEvents:function(n,o,r,a){cancelStream.onValue(function(){t.hide(o)}),n.$on("hide-"+r,function(){o.is(":visible")&&(t.hide(o),n.$$phase||n.$digest())}),n.$on(r,function(t,r){o.is(":visible")||(a(r.elem),e.setCurrentTextArea(r.elem)),n.$$phase||n.$digest()}),n.$on("mentions-highlight-updated",function(){n.mentionsHighlightUpdated(),setTimeout(function(){var e=o[0].querySelector(".mention-highlight");e&&e.scrollIntoView({block:"nearest",inline:"nearest"})},1)})},show:function(e,t,n){animate({el:e,begin:function(){e.css({visibility:"hidden",display:"inline-block"}),e.css({left:t,top:n,visibility:"visible"})},opacity:[0,1],scaleX:[.8,1],scaleY:[.8,1],duration:300,complete:function(){}})},hide:function(t){animate({el:t,scaleX:[1,.8],scaleY:[1,.8],opacity:[1,0],duration:300,complete:function(e){e.forEach(function(e){e.style.display="none"})}}),e.hide()}};return t}]).factory("OrganizationInfo",[function e(){function e(){}return new e}]).factory("SubscriptionInfo",[function e(){function e(){}return e.prototype.legacySeatSubscription=1,e.prototype.legacyPlanSubscription=2,e.prototype.stripeSubscription=3,e.prototype.isExtended=function(){return!!this.subscription_type},e.prototype.extend=function(t){return _.extend(this,t,e.prototype)},e.prototype.isLegacySeatSubscription=function(){return this.subscription_type==this.legacySeatSubscription},e.prototype.isLegacyPlanSubscription=function(){return this.subscription_type==this.legacyPlanSubscription},e.prototype.isStripeSubscriptionOrSubscription=function(){return"undefined"==typeof this.subscription_type||this.subscription_type===this.stripeSubscription},new e}]).factory("AcceptAcccountInfo",[function e(){function e(){}return e.prototype.setAccounts=function(e){return this.accounts=e,this},new e}]).factory("AvatarUrl",[function e(){function e(){}return e.prototype.makeUrl=function(e,t){return makeUrl(e,t)},new e}]).factory("AuthService",["$rootScope","$location","anonymous","UserInfo",function(e,t,n,o){function r(){"undefined"!=typeof backendAuthService&&backendAuthService.currentAuthData({board_id:c.boardId}).then(function(t){_.extend(i,t.user,o.prototype),globalStreams.reduxStream.push({type:"currentUser",payload:{currentUser:i}}),_.extend(c,t.board,BoardInfo.prototype),globalStreams.reduxStream.push({type:"currentBoard",payload:{currentBoard:c}}),e.$digest(),globalStreams.currentUserStream.push(i)})}if("undefined"!=typeof initialState){var a={};"undefined"!=typeof _initialUser&&"undefined"!=typeof _initialUser.currentTeam&&(a=_initialUser.currentTeam);var i={email:_initialUser.email,avatarUrl:_initialUser.avatarUrl,sketchboardAvatar:_initialUser.sketchboardAvatar,firstName:"",lastName:"",displayName:"guest",defaultAccountName:"",internal:initialState.internal,defaultAccountExpired:_initialUser.defaultAccountExpired,defaultAccountType:initialState.defaultAccountType,loggedIn:"guest"!==initialState.userType,properties:_initialUser.properties?_initialUser.properties:0,currentTeam:a,accountRole:_auState.role,org_id:_initialUser.org_id};_.extend(i,o.prototype),globalStreams.reduxStream.push({type:"currentUser",payload:{currentUser:i}});var c={boardId:initialState.boardId,name:initialState.diagramName,updatedAt:-1,owner:initialState.diagramOwner,accountname:"",diagramType:initialState.diagramType,visibility:-1,diagramOwned:initialState.diagramOwned,editable:initialState.diagramEditable};_.extend(c,_initialBoard,BoardInfo.prototype),globalStreams.reduxStream.push({type:"currentBoard",payload:{currentBoard:c}}),r()}return"/upgradeinfo"==t.path()&&t.path("/").search({}),{login:function(){},logout:function(){},isLoggedIn:function(){return"undefined"!=typeof initialState&&i.isLoggedIn()},currentUser:function(){return i},currentBoard:function(){return c},refresh:function(){r()}}}]).factory("Comments2Factory",["$rootScope","$timeout","AuthService","BoardUsers",function(e,t,n,o){function r(t){e.$broadcast(s.constCommentsLoaded+t)}function a(){_.each(s.commentThreads,function(e){e.showAll=!1,e.uuat&&(e.uat=e.uuat,e.uuat=null)})}function i(e,t){return e.length>t&&(e=e.substring(0,t)+"..."),e}var c={},s={};return s.constCommentsLoaded="comments-loaded",s.loadResult=null,s.commentThreads=null,e.$on("comment.create",function(t,n){s.appendComment(n),e.$broadcast("do.comment.create",n)}),e.$on("comment.update",function(t,n){s.updateComment(n),e.$broadcast("do.comment.update",n)}),e.$on("comment.update.switch.shapes",function(t,n){s.updateCommentSwitchShapes(n),e.$broadcast("do.comment.update.switch.shapes",n)}),e.$on("comment.delete",function(t,n){s.deleteComment(n),e.$broadcast("do.comment.delete",n)}),e.$on("thread.resolve",function(t,n){s.updateThreadResolveStatus(n),s.appendComment(n),e.$broadcast("do.thread.resolve",n)}),s.loadCommentThreads=function(e){return s.commentThreads?(a(),void t(function(){r(e)})):void publicBackendComments.listComments({board_id:n.currentBoard().boardId}).then(function(t){s.loadResult=t.ok,s.commentThreads=t.data,Object.keys(c).forEach(function(e){var t=s.findThread(e);t&&(t.open=c[e])}),r(e)})},s.removeComment=function(e,t){var o="Are you sure you want to delete comment? This cannot be undone.";e.comment.topic&&(o="Are you sure you want to delete whole comment thread? All comments in this thread will be deleted. This cannot be undone."),confirm(o)&&backendComments.deleteComment({board_id:n.currentBoard().boardId,site_id:gwtGetSiteId(),comment_id:e.comment.id,thread_id:e.thread.threadid}).then(function(e){t(e)})},s.deleteComment=function(e){if(e.comment.topic){var t=s.findThreadIndex(e.thread.threadid);t>=0&&s.commentThreads.splice(t,1)}else{var n=s.findThread(e.thread.threadid);if(n){var t=s.findCommentIndex(n.comments,e.comment.id);t>=0&&n.comments.splice(t,1)}}},s.appendComment=function(e){var t=_.findIndex(s.commentThreads,function(t){return t.threadid==e.thread.threadid});if(t>=0){var n=s.commentThreads[t];n.resolved=e.thread.resolved,n.uuat=e.comment.uat,n.comments.push(e.comment)}else e.thread.comments.push(e.comment),s.commentThreads.unshift(e.thread)},s.updateComment=function(e){var t=s.findThread(e.thread.threadid);if(t){var n=s.findCommentIndex(t.comments,e.comment.id);n>=0&&(t.comments.splice(n,1,e.comment),t.uuat=e.comment.uat)}},s.updateCommentSwitchShapes=function(e){var t=s.findThread(e.thread_id);t&&(t.shape_ids=e.shape_ids)},s.updateThreadResolveStatus=function(e){var t=s.findThread(e.thread.threadid);return t&&(t.resolved=e.thread.resolved,t.forceShowReplies=!1),t},s.openThread=function(e,t){var n=s.findThread(e.threadid);n&&(n.open=t,e.open=t,c[e.threadid]=t,t||delete c[e.threadid])},s.findThread=function(e){return _.find(s.commentThreads,function(t){return t.threadid==e})},s.findThreadIndex=function(e){return _.findIndex(s.commentThreads,function(t){return t.threadid==e})},s.findCommentIndex=function(e,t){return _.findIndex(e,function(e){return e.id==t})},s.postSaveComment=function(e,t,r,a,i){if(!e||e&&""==e)return void(i&&i());var c={board_id:n.currentBoard().boardId,site_id:gwtGetSiteId(),comment:e,active_users:o.activeUsers()};t&&(c.thread_id=t.threadid),r&&(c.shape_ids=r),backendComments.createComment(c).then(function(e){a(e)})},s.postUpdateComment=function(e,t){var o={board_id:n.currentBoard().boardId,site_id:gwtGetSiteId(),comment:e.commentEdited,comment_id:e.comment.id,thread_id:e.thread.threadid};backendComments.updateComment(o).then(function(e){t(e)})},s.postUpdateThreadResolveStatus=function(e,t){backendComments.updateThreadResolveStatus({board_id:n.currentBoard().boardId,thread_id:e,site_id:gwtGetSiteId(),resolved:t})},s.getSelectedShapes=function(){var e=JSON.parse(gwtGetSelectedItems()),t="";e.length>0&&(t=i(t,350),t+="\n\n");var n=_.map(e,function(e){return e.clientId});return{selectedText:"",selectedShapeIds:n}},s.isSystemOrOthersOwn=function(e){return!(!e||!s.isSystemComment(e))||!(!e||e.email===n.currentUser().email)},s.isSystemComment=function(e){return!(!e||!e.opts)&&1==(1&e.opts)},s.shouldDisableCommentMenu=function(e,t){return!!s.isSystemComment(t)||(e.resolved===!0&&!t.topic||!(!t||t.topic||t.email===n.currentUser().email))},s}]).factory("Helpers",["$location",function(e){var t=navigator.platform.toUpperCase().indexOf("MAC")>=0;return{parseEmailDomain:function(e){var t=e.split("@");return 2==t.length?t[1]:null},format:function(){var e="";arguments.length>0&&(e=arguments[0]);for(var t=1;t<arguments.length;++t)e=e.replace(/\{\}/,arguments[t]);return e},jsonParse:function(e){return angular.fromJson(e)},currentBoardId:function(){var e=this.currentBoardFullId().split("-");return e.length>0?e[0]:this.currentBoardFullId()},currentBoardVersion:function(){var e=this.currentBoardFullId().split("-");return 2==e.length?e[1]:""},currentBoardFullId:function(){return location.pathname.substring(1)},isBoardVersion:function(){var e=this.currentBoardFullId().split("-");return 2==e.length},toggle:function(e,t){e.$broadcast("event:toggle:"+t)},capitalize:function(e){return e.substring(0,1).toUpperCase()+e.substring(1)},isMac:function(){return t},isOutsideElement:function(e,t){return!e.is(t)&&0===e.has(t).length},domArray:function(e){return Array.isArray(e)?e:e.nodeType?[e]:e instanceof NodeList||e instanceof HTMLCollection?Array.prototype.slice.call(e):e.get()},isPrimaryOwner:function(e){return 1==e.role}}}]).factory("TutorialHelpers",["$location","$rootScope",function(e,t){return{showTutorialShare:function(){var n=null;n=globalStreams.shapeAddedStream.onValue(function(o){n(),setTimeout(function(){e.path("/tutorial").search({share:!0}),t.$apply()},7e3)})}}}]).factory("DirectiveHelpers",["$rootScope","$compile","$document",function(e,t,n){return{injectLibrary:function(o,r,a,i,c,s){function l(){r.css("display","block")}function u(){r.css("display","none")}var d=!1;e.$on(i.showOn,function(){l(),d||(o.$apply(function(){var e=angular.element("<div ng-include src=\"'"+c+"'\">");r.html(t(e)(o))}),d=!0),s&&s()}),e.$on(i.hideOn,function(){u()}),n.on(i.hideAlt1,function(){u()}),n.on(i.showAlt1,function(){l()})}}}]).factory("DeleteLegacyCookies",["$cookies",function(e){return{doIt:function(){for(var t in e.getAll())0==t.indexOf("aboard-")&&e.remove(t)}}}]).factory("CommentPositionFactory",function(){function e(t,o,a){var i=t+"px"+o+"px";return!n[i]||n[i]&&n[i]===a?(n[i]=a,{left:t,top:o}):e(t-r,o,a)}var t={},n={},o=25,r=30;return t.resetAllocations=function(){n={}},t.position=function(t,n){var r={left:0,top:0};if(t.dimension){var a=t.dimension.left-o,i=t.dimension.top-o;r=e(a,i,t.threadid)}return r},t}).factory("TaxFactory",function(){var e={},t="FI",n=["BE","EL","LT","PT","BG","ES","LU","RO","CZ","FR","HU","SI","DK","HR","MT","SK","DE","IT","NL",t,"EE","CY","AT","SE","IE","LV","PL","UK","GB"];return e.isEUCountry=function(e){var t=_.filter(n,function(t){return t==e});return t.length>0},e.isFinland=function(e){return t===e},e.resolveCreditCardCountry=function(e){return _config&&_config.devCountryCode&&2==_config.devCountryCode.length?_config.devCountryCode:null!=e&&""==e?"FI":e},e}).factory("PlanFactory",["AccountService",function(e){function t(e){if("org-standard"===e)return[{text:"Easily split work between different user groups",title:""},{text:"Multiple teams for a user and charged only once",title:""},{text:"Single billing for all teams",title:""},{text:"Unlimited private teams",title:""},{text:"Team level access rights",title:""},{text:"Store more images and versions",title:""}];var t=[{text:r(e),title:a(e)},{text:"Search boards' content",title:"All your private boards will be searchable which your future self will be very grateful"},{text:"Storage for images & revisions "+i.spaceFor(e),title:"Sketch on top of images and snapshot important sketches."}];return n(e)&&(t.push({text:"Team Comments",title:""}),t.push({text:"Presentation",title:""}),t.push({text:"Slack Integration",title:""})),o(e)&&t.push({text:"Priority Email Support",title:""}),t}function n(e){return"personal"!==e}function o(e){return"medium"===e||"small"===e}function r(e){return"personal"===e?"Unlimited personal boards":"Unlimited personal & team boards"}function a(e){return"personal"===e?"Create private personal boards.":"Create private personal and team boards."}var i={};i.plans=[],i.fetch=function(){backend.allPlans().then(function(e){i.plans=e,_.each(i.plans,function(e){e.features=t(e.id_name)})})};var c=[];return i.featuresFor=function(e){var t=_.find(i.plans,function(t){return t.id_name==e});return t?t.features:c},i.planName=function(e){var t=_.find(i.plans,function(t){return t.id_name==e});return t?t.name:""},i.priceFor=function(t,n){var o=_.find(i.plans,function(e){return e.id_name==t});return o&&n==e.yearly.id?o.amountYearly/100:o?o.amount/100:""},i.collaboratorsFor=function(e){var t=_.find(i.plans,function(t){return t.id_name==e});return t?t.max_members:""},i.spaceFor=function(e){var t=_.find(i.plans,function(t){return t.id_name==e});return t&&t.space<1e3?t.space+" MB":t?t.space/1e3+" GB":""},i}]).factory("BoardUsers",["AuthService","AvatarUrl","anonymous",function(e,t,n){function o(e){_.each(e,function(e){var t=_.find(l.mates,function(t){return e.email==t.email});t?t.username=e.username:s(e)}),_.chain(l.mates).filter(function(t){
return _.find(e,function(e){return t.email===e.email})}).each(function(e){e.online=!0,e.expires=(new Date).getTime()+f})}function r(){var t=(new Date).getTime();_.each(l.mates,function(n){n.online&&t>n.expires&&n.email!=e.currentUser().email?n.online=!1:n.email==e.currentUser().email&&(n.online=t<=mousews.userLastActivity+f)})}function a(){for(var e=l.mates.length-1;e>=0;--e){var t=l.mates[e];t.online||"guest"!=t.username||l.mates.splice(e,1)}}function i(){l.mates=_.sortBy(l.mates,function(e){return e.online?-1:1})}function c(){setTimeout(function(){r(),a(),i(),l.statusChangedStream.push(),c()},u)}function s(e){e.avatarUrl&&""!=e.avatarUrl||(e.avatarUrl=l.defaultAvatarURL),e.email&&""!=e.email&&e.email!=n&&l.mates.push(e)}var l={mates:[],defaultAvatarURL:"https://dly2br18d18gh.cloudfront.net/img/user_icon_100x100.png"};l.accountUsersForBoard=function(t){return l.mates=[],"undefined"!=typeof backend&&globalStreams.boardLoadedWrapStream.onValue(function(){backend.accountUsersForBoard({boardId:e.currentBoard().boardId}).then(function(e){_.each(e.users,function(e){e.username=e.displayName;var t=_.find(l.mates,function(t){return t.email==e.email});t||s(e)}),t()})}),l.mates},l.avatarUrl=function(e){var n=l.findUser(e);return n?t.makeUrl(n,50):l.defaultAvatarURL},l.findUser=function(e){return _.find(l.mates,function(t){return t.email===e})},l.reloadUsers=function(e){l.mates=[],globalStreams.reloadBoardUsersStream.push()},l.statusChangedStream=new Bacon.Bus;var u=8e3,d=4e3,f=6e4,p=null;return globalStreams.websocketMouseStream.onValue(function(e){var t=(new Date).getTime();p&&t<p.when+d||(p={when:t,email:e.email},o([e]))}),globalStreams.usersStream.onValue(function(e){o(e)}),l.activeUsers=function(){return _.chain(l.mates).filter(function(e){return e.online}).map(function(e){return e.email}).value()},c(),l}]).factory("BoardPositionFactory",["AuthService",function(e){function t(){if("undefined"==typeof e.currentBoard())return null;var t=webStorage.get("pos_"+e.currentBoard().boardId),n={};return t&&(n=JSON.parse(t)),n}function n(n){gwtIsOkToSaveZoom()&&(clearTimeout(a),a=setTimeout(function(){var o=t();o&&(o.zoom=n,webStorage.set("pos_"+e.currentBoard().boardId,JSON.stringify(o)))},500))}function o(n){gwtIsOkToSaveZoom()&&(clearTimeout(i),i=setTimeout(function(){if(t()){var o=t();o.dx=n.dx,o.dy=n.dy,o.zoom=n.xx,webStorage.set("pos_"+e.currentBoard().boardId,JSON.stringify(o))}},500))}function r(n){if(gwtIsOkToSaveZoom()){var o=t();o.map=n,webStorage.set("pos_"+e.currentBoard().boardId,JSON.stringify(o))}}var a=null,i=null;return globalStreams.boardScaledStream.onValue(function(e){try{var t=Number(e.toFixed(3));n(t)}catch(e){console.error("BoardPositionFactory.boardScaledStream failed",e)}}),globalStreams.backgroundMoveStream.onValue(function(e){"move-end"===e.type?o(e.matrix):"move"===e.type&&o(e.matrix)}),globalStreams.surfaceTransformStream.onValue(function(){var e=gwtGetTransform();o(e.matrix)}),globalStreams.mapViewStateStream.onValue(function(e){if(e)r(e);else{r(e);var t=gwtGetTransform();o(t.matrix)}}),{getCurrent:function(){return t()}}}]);var BoardInfo=function(){};BoardInfo.prototype.getProClass=function(){var e={pro:"context-icon-pro",free:""};return 1==this.diagramType?e.pro:e.free},BoardInfo.prototype.getTitle=function(){return 1==this.diagramType?"Business Board":"Free Board"},BoardInfo.prototype.isFree=function(){return 0==this.diagramType},BoardInfo.prototype.isPublic=function(){return this.isFree()},BoardInfo.prototype.isPro=function(){return 1==this.diagramType},BoardInfo.prototype.isPasswordProtected=function(){return this.passwordProtected},BoardInfo.prototype.isPrivate=function(){return 0==this.visibility&&1==this.diagramType},BoardInfo.prototype.isPrivateTeam=function(){return 2==this.visibility&&1==this.diagramType},BoardInfo.prototype.iAmTheOwner=function(){return"me"===this.owner},BoardInfo.prototype.noOwner=function(){return"undefined"===this.owner||""===this.owner},BoardInfo.prototype.isOwnedBySomeoneElse=function(){return!this.iAmTheOwner()&&this.diagramOwned},BoardInfo.prototype.isAccountVisibility=function(){return 2==this.visibility&&1==this.diagramType},BoardInfo.prototype.isPaidBoard=function(){return this.paidBoard},BoardInfo.prototype.isBoardAccountExpired=function(){return this.boardAccountExpired},BoardInfo.prototype.isCreatedBeforeGalleryLaunch=function(){return this.createdAt<_config.galleryLaunchDate},BoardInfo.prototype.setVisibility=function(e){this.visibility=e,globalStreams.reduxStream.push({type:"currentBoard",payload:{currentBoard:this}})},BoardInfo.prototype.setBoardInfo=function(e){var t=_.extend(this,e);return globalStreams.reduxStream.push({type:"currentBoard",payload:{currentBoard:t}}),t},BoardInfo.prototype.isSketchMode=function(){var e=1;return(this.properties&e)==e},BoardInfo.prototype.isShowCommentsPublicly=function(){var e=2;return(this.properties&e)==e},BoardInfo.prototype.isUserBoardTeamMember=function(){return this.userIsBoardTeamMember},angular.module("myApp.services",[]).service("AppStateService",[function(){this.isDialogOpen=function(){var e=angular.element(document.activeElement);return e.is(":focus")}}]).service("SettingsService",function(){this.showWelcomeGuideNextTime=function(e){"undefined"!=typeof boardService&&boardService.showWelcomeGuideNextTime({show:e})}}).service("ClipboardService",["Helpers",function(e){this.copyToClipboard=function(){if("undefined"!=typeof backendClipboard){var t=gwtCopy(),n=e.currentBoardFullId();backendClipboard.copyToClipboard({boardId:n,items:t}).then(function(e){})}},this.pasteFromClipboard=function(){if("undefined"!=typeof backendClipboard){var t=e.currentBoardFullId();backendClipboard.pasteFromClipboard(t).then(function(e){e&&gwtPaste(e.items)})}}}]).service("BrowserService",function(){function e(){var e=document.createElement("div");try{e.contentEditable="PLAINtext-onLY"}catch(e){return!1}return"plaintext-only"==e.contentEditable}var t=e();this.supportContentEditablePlainText=function(){return t}}).service("CommentsService",["$rootScope","AuthService",function(e,t){this.applyCommentOperation=function(t,n){e.$broadcast(t,n)}}]).service("URLParser",function(){this.parseURL=function(e){var t=document.createElement("a");return t.href=e,t}}).service("PresentationService",["AuthService",function(e){function t(){try{r=gwtGetSiteId()}catch(e){boardLoadedStream.onValue(function(){r=gwtGetSiteId()})}}function n(){libraryService.presentationCommand({board_id:e.currentBoard().boardId,site_id:r,cmd:"next"})}function o(){libraryService.presentationCommand({board_id:e.currentBoard().boardId,site_id:r,cmd:"prev"})}var r=null;t(),this.play=function(){"undefined"!=typeof libraryService&&r&&libraryService.presentationCommand({board_id:e.currentBoard().boardId,site_id:r,cmd:"play"})},this.quit=function(){"undefined"!=typeof libraryService&&r&&libraryService.presentationCommand({board_id:e.currentBoard().boardId,site_id:r,cmd:"quit"})},this.next=function(){"undefined"!=typeof libraryService&&r&&libraryService.presentationCommand({board_id:e.currentBoard().boardId,site_id:r,cmd:"quit"})},this.presentationRealTimeNavigation2=function(e){"undefined"!=typeof libraryService&&r&&("next"===e?n():"prev"===e&&o())},this.presentationRealTimeNavigation=function(e){if("undefined"!=typeof libraryService&&r)switch(e){case 33:case 37:case 38:o();break;case 9:case 32:case 34:case 39:case 40:n()}},this.presentationRealTimeApplyCmd=function(e){e.site_id!==r&&globalStreams.presentationCommandStream.push(e)}}]).service("ImageService",["AuthService",function(e){this.loadThumbnails=function(t,n){"undefined"!=typeof backendProfileService&&backendProfileService.loadThumbnails({boardId:e.currentBoard().boardId,offset:t,max:n}).then(function(e){gwtLoadedImages(e)})}}]).service("LibrarySettingsService",["$rootScope",function(e){this.showLibrarySettings=function(){e.$broadcast("show-library-settings")},this.hideLibrarySettings=function(){e.$broadcast("hide-library-settings")}}]).service("ImageLibraryService",["$rootScope",function(e){this.showImageLibrary=function(){e.$broadcast("show-image-library")},this.hideImageLibrary=function(){e.$broadcast("hide-image-library")}}]).service("LibraryShapeService",["$rootScope",function(e){this.show=function(t){e.$broadcast("show-library-"+t)},this.hide=function(t){e.$broadcast("hide-library-"+t)}}]).service("ImageProxyService",function(){function e(e){e.pelem=angular.element(e.proxy),angular.element("body").append(e.pelem),e.installed=!0}var t={proxy:'<img class="img-proxy">',installed:!1,pelem:null},n={proxy:'<div class="shape-proxy"></div>',installed:!1,pelem:null},o={proxy:'<div class="slide-proxy"></div>',installed:!1,pelem:null};this.getProxy=function(r){var a=n;return"img"==r?a=t:"slide"===r&&(a=o),a.installed||e(a),a.pelem}}).service("NotifyService",["$timeout",function(e){var t={visible:!1,msg:""};this.getInfoState=function(){return t},this.info=function(n){t.visible||e(function(){t.visible=!1},14e3),t.visible=!0,t.msg=n},cancelStream.onValue(function(){t.visible=!1})}]).service("IntegrationsService",function(){this.selectAccount=function(e){var t=_.find(e,function(e){return 1==e.defaultAccount});return!t&&e.length>0&&(t=e[0]),t}}).service("AccountService",["accountType",function(e){this.timeLeft=function(e){return 1==e.daysLeft?e.daysLeft+" day":e.daysLeft+" days"},this.isActiveBusinessAccount=function(t){return t.accountType===e.business&&t.daysLeft>0};var t=null;this.selectPlan=function(e,n){t={plan_id:e,interval_id:n}},this.selectedPlanAndReset=function(){var e=t;return t=null,e},this.monthly={id:"month",name:"Monthly Billing",unit:"monthly"},this.yearly={id:"year",name:"Yearly Billing",unit:"yearly"};var n=[this.monthly,this.yearly];this.periodIntervals=n,this.findIntervalByIntervalId=function(e){var t=_.filter(n,function(t){return t.id==e});return t&&t.length>0?t[0]:null}}]).service("BoardManagerService",["$rootScope","PopoverService","AuthService",function(e,t,n){var o=n.currentBoard;e.$watch(n.currentBoard,function(e){o=e}),this.getBoardsInfo=function(e,t,n){return getBoardInfo(e,t,n)},this.currentBoard=function(){return o},this.showChangeBoardName=function(){t.closeAllOpenPopovers(),showChangeBoardName(n.currentBoard().boardId)},this.changeBoardName=function(e){changeBoardName(this.currentBoard().boardId,e)},this.boardNameOrEmpty=function(){var e=this.currentBoard().name;return e===this.currentBoard().boardId&&(e=""),e}}]).service("PopoverService",["$q","$templateCache","$http","$compile","$timeout","Helpers",function(e,t,n,o,r,a){var i=this;this.isMenuOpen=function(){var e=!1;return $(".popover.in").each(function(){e=!0}),e},this.closeAllOpenPopovers=function(){$(".popover.in[data-launcher]").each(function(){var e=$(this),t=e.attr("data-launcher"),n=t.split(":");"string"==typeof n?$(n).popover("hide"):$(n[0]).popover("hide",n[1])}),$(".tooltip.in").each(function(){var e=$(this);e.hide()})},this.participateCloseAllOpenPopover=function(e){e.on("mousedown",function(){i.closeAllOpenPopovers()})},this.popoverTitle=function(e,t,n){return n?a.format('<strong>{}</strong><button type="button" class="close" onclick="$(&quot;{}&quot;).popover(&quot;hide&quot;,&quot;{}&quot;);">&times;</button>',e,t,n):a.format('<strong>{}</strong><button type="button" class="close" onclick="$(&quot;{}&quot;).popover(&quot;hide&quot;);">&times;</button>',e,t)},this.popoverTemplate=function(e,t){return a.format('<div class="popover {}" data-launcher="{}"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>',e,t)},this.popoverConfig=function(e,t,n,o){var r=$(e);o?r.popover({placement:"top",trigger:"manual",html:"true",title:this.popoverTitle(t,e,o),template:this.popoverTemplate(n,e+":"+o)},o):jQuery(e).popover({placement:"top",trigger:"manual",html:"true",title:this.popoverTitle(t,e),template:this.popoverTemplate(n,e)}),i.participateCloseAllOpenPopover(r)},this.popoverShow=function(e,t,n){var o=$(e);o.attr("data-content",t),n?o.popover("show",n):o.popover("show")},this.popoverShowAndFocus=function(e,t,n,o){i.popoverShow(e,t,o),$(n).focus()},this.tooltipWithCloseConfig=function(e,t){$selector=jQuery(e),$selector.tooltip({title:t,trigger:"hover"}),$selector.on("mousedown",function(e){$this=$(this),$this.tooltip("hide")})},this.tooltipAndPopoverFullConfig=function(e,t,n){},this.showFormAndFocus=function(r,a,i,c,s,l){e.when(t.get(r)||n.get(r,{cache:!0}).then(function(e){if(angular.isObject(e.data)){var t=a.attr("data-content",e.data.data).data("popover");a.popover("show"),$(i).focus(),l(t),o(c)(s)}}))},this.showFormAndFocus2=function(e,t,n,i,c,s){function l(){var t=a.format("<div id='{}' ng-include src='\"{}\"'></div>",i,e);return t}var u=l(),d=t.attr("data-content",u).data("popover");t.popover("show"),s(d),o("#"+i)(c),r(function(){$(n).focus()},100)}}]),angular.module("myApp.filters",[]).filter("formatUserRole",["$sce",function(e){return function(t){switch(t){case 0:return e.trustAsHtml('<span class="label label-rw" style="margin-left: 5px;">member</span>');case 1:return e.trustAsHtml('<span class="label label-po" style="margin-left: 5px;">primary owner</span>');case 2:return e.trustAsHtml('<span class="label label-ro" style="margin-left: 5px;">read-only member</span>');case 3:return e.trustAsHtml('<span class="label label-admin" style="margin-left: 5px;">admin</span>');default:return""}}}]).filter("formatAccepted",["$sce",function(e){return function(e){return e>0?"":0==e?'<span class="label label-warning" style="margin-left: 5px;" title="Team member has been invited, but has not joined the team yet">invited</span>':""}}]).filter("formatDefaultAccount",["$sce",function(e){return function(t){switch(t){case!0:return e.trustAsHtml('<span class="label" style="margin-left: 5px;">Default Team</span>');default:return""}}}]).filter("formatFreePlan",function(){return function(e){return"<span class='label'>Free Plan</span>"}}).filter("formatAccountType",["Helpers","$sce",function(e,t){return function(n){function o(){var t='<span class="label {}">{}</span>';switch(n){case 0:return e.format(t,"","Free");case 1:return e.format(t,"label-warning","Trial");case 2:return e.format(t,"","Business Team");case 3:return e.format(t,"","Team");case 4:return e.format(t,"","Unit");case 5:return e.format(t,"","Department");case 6:return e.format(t,"","Division");default:return""}}return t.trustAsHtml(o())}}]).filter("formatPlan",["Helpers","$sce",function(e,t){return function(n){function o(){var t='<span class="label {}">Plan {}</span>';return e.format(t,"",n)}return t.trustAsHtml(o())}}]).filter("formatAccountPlan",function(){return function(e){return"undefined"!=typeof e.plan||e.expired?"undefined"==typeof e.plan&&e.expired?"Free":"undefined"!=typeof e.plan&&e.expired?e.plan.name+" - Expired":"undefined"!=typeof e.plan?e.plan.name:"":"Trial"}}).filter("formatVisibility",["Helpers","$sce",function(e,t){return function(n){function o(){var t='<span class="green-highlight" title="{}">{}</span>';switch(n){case 0:return e.format(t,"Only you can see the board, click to publish.","Private");case 1:return e.format(t,"Team members can open the board who have the URL","Team Members With URL");case 2:return e.format(t,"Team members can see board listed and open the board","Team");default:return""}}return t.trustAsHtml(o())}}]).filter("formatBoardVisibility",[function(){return function(e){var t="";return e.isFree()?t="Public board":!e.isFree()&&e.isPrivate()?t="Private board":e.isFree()||e.isPrivate()||(t="Team board"),t}}]).filter("formatUserName",["Helpers",function(e){return function(t){return""===t.firstName&&""===t.lastName?e.capitalize(t.email):t.displayName+" – "+t.firstName+" "+t.lastName}}]).filter("capitalLetters",function(){return function(e,t){var n="";return e?(e.length>0&&(n=_.map(_.first(e.split(" "),t),function(e){return e.substring(0,1).toUpperCase()}).join(""),1==n.length&&e.length>=2&&(n+=e[1])),n):n}}).filter("resolved",function(){return function(e){switch(e){case 0:return"Open";case 1:return"Done"}return"Open"}}).filter("checked",["$sce",function(e){return function(t){switch(t){case 0:return"";case 1:return e.trustAsHtml("&#x2713;")}return""}}]).filter("capitalize",["Helpers",function(e){return function(t,n){return e.capitalize(t)}}]).filter("apiMessage",["apimsg",function(e){return function(t){switch(t){case"1":return e.insufficienPlan;case"2":return e.notAdmin;default:return"Sorry, unexpected error."}}}]).filter("formatMates",function(){return function(e){for(var t=_.map(e,function(e){return e.email}),n="",o=0;o<t.length;++o)o==t.length-1&&t.length>1?n+=" and ":o>0&&(n+=", "),n+=t[o];return n}}).filter("boardName",function(){return function(e){return""==e.boardName?e.boardId:e.boardName}}).filter("tagName",function(){return function(e){return e.boardCount>1?e.name+" ("+e.boardCount+")":e.name}}).filter("simplifyDate",["$filter",function(e){return function(t,n){function o(e,t){return e.getMonth()===t.getMonth()&&e.getFullYear()===t.getFullYear()&&e.getDate()===t.getDate()}var r=new Date,a=new Date;a.setDate(a.getDate()-1);var i=new Date(t);return o(i,r)?e("date")(t,"HH:mm")+" today":o(i,a)?e("date")(t,"HH:mm")+" yesterday":e("date")(t,"HH:mm MMM d, y")}}]).filter("createdBy",function(){return function(e){return e.uname?e.uname:e.email}}).filter("statusMessage",[function(){return function(e){var t="";return e.opts&&e.opts&&(2==(2&e.opts)?t="Marked as resolved":4==(4&e.opts)&&(t="Re-opened")),e.uat!==e.cat&&(t+=0===t.length?"edited":", edited"),t}}]).filter("shortcut",["Helpers",function(e){return function(t,n){var o="";return t||(t=o),o=e.isMac()?t+" | ⌘"+n:t+" | Ctrl+"+n}}]).filter("shortcut2",["Helpers",function(e){return function(t,n){var o="";return t||(t=o),o=e.isMac()?t+"⌘"+n:t+"Ctrl+"+n}}]),angular.module("myApp.constants",[]).value("anonymous","anonymous").value("elementType",{comment:"comment",commentThread:"comments"}).value("accountType",{free:0,trial:1,business:2}).value("contextMenuFillColor","#efefef"),angular.module("myApp.controllers").controller("ShapeContextMenuCtrl",["$scope","ShapeService","AuthService","ShapeConfService","ShapeInfo","contextMenuFillColor",function(e,t,n,o,r,a){function i(t){libraryService.searchShapes({shape_type:tsCurrentSketchMode(),term:e.searchTerms,offset:e.offsetSearch,max:e.maxSearch}).then(function(n){e.$apply(function(){e.shapes=[],_.each(n,function(t){t.extra=!0,e.allShapes.push(t)}),d(),e.search(t)}),e.offsetSearch+=n.length})}function c(){e.$broadcast("hide")}function s(){k=0,l()}function l(){k>=0&&k<e.shapes.length&&e.$broadcast("focus-changed")}function u(){e.allShapes=[],e.offset=0,e.offsetSearch=0,g=0}function d(){e.allShapes=_.uniq(e.allShapes,!1,function(e){return e.et})}function f(e){globalStreams.contextMenuStream.push({type:"add-image-on-board",image:e,x:$.x,y:$.y})}function p(){e.images=[],g=0}function m(){"undefined"!=typeof backendProfileService&&backendProfileService.loadThumbnails({team_id:e.currentUser.currentTeam.team_id,boardId:n.currentBoard().boardId,offset:g,max:v}).then(function(t){e.$apply(function(){_.each(t,function(t){e.images.push(t)}),g+=t.length})})}e.states={init:1,loaded:2,empty:3,notallowed:4},e.offset=0,e.max=30,e.offsetSearch=0,e.maxSearch=30;var h=1,g=0,v=30;e.allShapes=[],e.images=[];var y=53,b=y+8;e.showLibrary=1,e.searchTerms="";var S="",w=!1;e.shapeWidth=function(e){return b},e.shapeHeight=function(e){return b},e.styleTitle=function(e){var t=e.tdy?"margin-top:"+e.tdy+"px;":"";return"min-width:"+b+"px;min-height:"+b+"px;"+t},e.translateOrTransform=function(n){return n.extra?n.scaled?t.transform(y,n):t.transformCenter(b,y,n):e.translate(n)},e.translate=function(e){var t=y/e.w,n=y/e.h,o=t<n?t:n,r=e.w*o,a=e.h*o,i=(b-r)/2,c=(b-a)/2;return"translate("+i+","+c+")"},e.translateText=function(e){var t=b/2,n=e.tdy?e.tdy:0,o=b/2+3+n;return"translate("+t+","+o+")"},e.transform=function(e,n){return t.transform(y,e,n)},e.shapeStyle=function(e,n){return t.shapeStyle(e,a,n)},e.shortName=function(e){return e.short?e.short:""},e.searchServer=function(){!w&&e.searchTerms.length>h&&S!==e.searchTerms&&(S=e.searchTerms,e.offsetSearch=0,i(!1))},e.search=function(t){var n=e.searchTerms.toLowerCase().split(/\s+/);e.shapes=_.filter(e.allShapes,function(e){for(var t=0;t<n.length;++t)if(e.et.indexOf(n[t])>=0)return __updateGradients__(e),!0;return!1}),t||s(),w=!1};var $={x:0,y:0};e.createShapeOn=function(e,t){$.x=e,$.y=t},e.newShape=function(e){_.extend(e,r.prototype),t.saveBoardShape(e,function(e){globalStreams.newShapeStream.push({element_type:e.getElementType(),shape_config:e.c,x:$.x,y:$.y}),c(),s()})},e.lassoSelect=function(){globalStreams.contextMenuStream.push({type:"select-button"}),c()},e.showImages=function(t){e.showLibrary=2,m()},e.showDiagrams=function(){e.showLibrary=1},e.uploadImage=function(e){var t=0,n=0;console.log("uploadImage",e),e.hasOwnProperty("originalEvent")&&e.originalEvent.pageX&&e.originalEvent.pageY?(t=e.originalEvent.pageX,n=e.originalEvent.pageY):e.clientX&&e.clientY?(t=e.clientX,n=e.clientY):(t=0,n=0),globalStreams.contextMenuStream.push({type:"upload",x:t,y:n}),c()},e.switchAwesome=function(){globalStreams.contextMenuStream.push({type:"switch-mode"})},e.styleOpposite=function(){return!e.currentBoard||e.currentBoard.isSketchMode()?"Corporate":"Awesome"};var C=!1,k=(0!=(1&_initialBoard.properties),0),B=6;e.hasFocus=function(t){var n=_.findIndex(e.shapes,function(e){return e.et==t.et});return n===k&&k>=0&&k<e.shapes.length},e.focusPrev=function(){k>0&&k<e.shapes.length?(--k,l(),w=!0):s()},e.focusNext=function(){k>=0&&k<e.shapes.length-1?(++k,l(),w=!0):s()},e.focusRowNext=function(){k>=0&&k+B<e.shapes.length?(k+=B,l(),w=!0):s()},e.focusRowPrev=function(){k-B>=0&&k<e.shapes.length?(k-=B,l(),w=!0):s()},e.selectShape=function(){k>=0&&k<e.shapes.length&&e.newShape(e.shapes[k])},e.load=function(){C=!1,globalStreams.contextMenuStream.push({type:"context-menu-open"}),e.loadDefaultShapes(),e.showLibrary=1,e.searchTerms="",e.search(),e.$broadcast("context-open"),s(),S="",w=!1},e.loadDefaultShapes=function(){if(!C){var t={};u(),_.each(gwtScaledShapes(y,y),function(e){e.scaled=!0,t[e.et]=e}),_.each(gwtScaledContextShapes(y,y),function(e){var n=_.mapObject(e,function(e,t){if("et"===t){var n=e.replace(/^l_/,"");return n}return e});n.scaled=!0,t[n.et]=n}),_.each(t,function(t,n,r){var a=o.details[t.et];a&&_.each(a,function(e,n,o){t[n]=e}),"o_slide"!==t.et&&e.allShapes.push(t)}),e.allShapes=_.chain(e.allShapes).filter(function(e){return"comments"!==e.et}).sortBy(function(e){var t=_.indexOf(o.order,e.et);return t>=0?t:5e3}).value(),C=!0}d()},e.loadMoreShapes=function(){if("undefined"!=typeof libraryService&&e.searchTerms.length>h)i(!0);else if("undefined"!=typeof libraryService&&0==e.searchTerms.length){var t="tutorial";currentBoard()&&(t=currentBoard().boardId),libraryService.loadShapes({library_name:"extra",board_id:t,shape_type:tsCurrentSketchMode(),offset:e.offset,max:e.max}).then(function(t){e.$apply(function(){_.each(t,function(t){t.extra=!0,e.allShapes.push(t)}),d();var n=!0;e.search(n),e.state=e.states.loaded}),e.offset+=t.length})}else e.state=e.states.notallowed},e.addImage=function(e){globalStreams.contextMenuStream.push({type:"add-image",hash:e.hash,handler:f}),c()},deleteLibraryImageStream.onValue(function(){p()}),newLibraryImageStream.onValue(function(){p()})}]),angular.module("myApp.directives").directive("searchKeys",[function(){return function(e,t,n){t.on("keypress",function(e){switch(e.which){case 32:e.preventDefault()}}),t.on("keydown",function(t){switch(t.which){case 32:t.preventDefault(),e.selectShape();break;case 37:t.preventDefault(),e.$apply(function(){e.focusPrev()});break;case 38:t.preventDefault(),e.$apply(function(){e.focusRowPrev()});break;case 39:t.preventDefault(),e.$apply(function(){e.focusNext()});break;case 40:t.preventDefault(),e.$apply(function(){e.focusRowNext()})}})}}]).directive("scrollOnFocus",function(){return function(e,t,n){var o=angular.element(n.scrollOnFocus);e.$on("focus-changed",function(){if(e.hasFocus(e.shape)){var n=t[0].offsetTop,r=n+t[0].offsetHeight,a=o.scrollTop(),i=a+o[0].offsetHeight;(n<a||r>i)&&o.scrollTop(a+t.position().top-t[0].offsetHeight)}})}}).directive("shapeContextMenu",["$document","$window","$timeout",function(e,t,n){return function(o,r,a){function i(){r.hide(),c=!1,n(function(){globalStreams.contextMenuStream.push({type:"context-menu-hide"})},200)}r.hide();var c=!1;Hammer2(e[0],{tapAlways:!0}).on("tap",function(e){r.is(e.target)||0!==r.has(e.target).length||c&&i()}),cancelStream.onValue(function(){i()}),o.$on("hide",function(){i()});var s=globalStreams.shapeContextStream.onValue(function(e){if(!c){r.css({visibility:"hidden"}),r.show();var n=r[0].offsetWidth,a=r[0].offsetHeight,i=e.x-n/2,s=e.y-a/2,l=t.innerWidth,u=t.innerHeight;i<0&&(i=0),i+n>l&&(i=l-n),s<0&&(s=0),s+a>u&&(s=u-a),r.css({left:i,top:s}),o.createShapeOn(e.x,e.y),o.load(),o.$digest(),r.css({visibility:"visible"}),c=!0}});r.on("$destroy",function(){s()})}}]),angular.module("myApp.factories").factory("ShapeInfo",function(){function e(){}return e.prototype.getElementType=function(){return this.target_type?this.target_type:this.et},e}),angular.module("myApp.services").service("ShapeService",["contextMenuFillColor",function(e){function t(e){for(var t=e.split(";"),n={},o=0;o<t.length;++o){var r=t[o].split(":");r&&2==r.length&&(n[r[0]]=r[1])}return n}function n(e){var t="";for(var n in e)e.hasOwnProperty(n)&&(t.length>0&&(t+=";"),t+=n+":"+e[n]);return t}function o(e,t){for(var n in t)e[n]=t[n];return e}function r(e,t,n){var o=gwtThemeColors();t||(t=o.border_color),n&&n.c&&n.c.dboc&&(t=n.c.dboc),e=a(e,n),e=i(e,n);var r="fill:bordercolor;";return e.replace(r,"fill:"+t+";fill-opacity:1;").replace("fill:bgcolor;","fill:#656464;fill-opacity:1;")}function a(e,t){return e.replace("fill:bordercolor-dark;","fill:#b3b3b3;fill-opacity:1;").replace("fill:bgcolor-light;","fill:#ececec;fill-opacity:1;").replace("fill:bgcolor-dark;","fill:#cccccc;fill-opacity:1;")}function i(e,t){return t&&e&&t.c&&t.c.dbc&&(e.includes("fill:")?e=e.replace("fill:shape-bgcolor;","fill:"+t.c.dbc+";"):(e.length>0&&(e+=";"),e+="fill:"+t.c.dbc+";fill-opacity:1;")),e}function c(t,n){var o="fill";return t.hasOwnProperty(o)&&e===n&&(t[o]="#000000"),t}function s(e,t){var n="tutorial";currentBoard()&&(n=currentBoard().boardId),"undefined"!=typeof libraryService&&libraryService.saveBoardShape({board_id:n,element_type:e.et,shape_type:tsCurrentSketchMode()}).then(function(n){0==n.ok?t(e):globalStreams.notifyStream.push("Sorry, failed to add shape. Please contact support@sketchboard.io.")})}this.shapeWidth=function(e,t){var n=e/t.w,o=e/t.h,r=n<o?n:o;return parseInt(r*t.w)},this.shapeHeight=function(e,t){var n=e/t.w,o=e/t.h,r=n<o?n:o;return parseInt(r*t.h)},this.transform=function(e,t,n){var o=e/t.w,r=e/t.h,a=o<r?o:r;return"matrix("+a+" 0 0 "+a+" 0 0)"},this.transformCenter=function(e,t,n,o){var r=t/n.w,a=t/n.h,i=r<a?r:a,c=Math.abs(e-n.w*i)/2,s=Math.abs(e-n.h*i)/2;return"matrix("+i+" 0 0 "+i+" "+c+" "+s+")"},this.shapeStyle=function(e,a,i){if(e.sl&&e.sl.length>0){var s=r(e.s,a,i),l=t(s),u=t(e.sl);return u=c(u,a),l=o(l,u),n(l)}return r(e.s,a,i)},this.saveBoardShape=function(e,t){gwtIsShapeCached(e.getElementType())?t(e):s(e,function(e){gwtShapeCacheAdd(e),t(e)})}}]).service("ShapeConfService",[function(){this.order=["noteitem","actoritem","usecase","classitem","sequenceitem","server","comp","storage","textitem","comments","astart","activity","choice","hfork","vfork","aend","centtop","maintopic","subtopic","package","star4","star5","envelope","triangle","bubble-l","bubble-r","rect","lightbulb","circle","smiley","polygon4","polygon8","arrow-up","arrow-d","arrow-r","arrow-l","cloud","firewall","switch","router","w-browser","desktop","laptop","server2","iphone","android","phone","tablet_u","tablet_h"],this.details={noteitem:{short:"Note",c:{dt:"**Markdown** _note_"}},classitem:{short:"Class",c:{dt:"Class"}},actoritem:{c:{dt:"User"}},sequenceitem:{short:"Sequence",tdy:-18,c:{dt:"Sequence"}},storage:{short:"Db",tdy:-2,c:{dt:"Db"}},textitem:{short:"Markdown<br><i>text</i>",tdy:-15,c:{dt:"**Markdown** _text_"}},"bubble-l":{short:"Markdown<br><i>bubble</i>",tdy:-15,c:{dt:"**Markdown** _bubble_"}},"bubble-r":{short:"Markdown<br><i>bubble</i>",tdy:-15,c:{dt:"**Markdown** _bubble_"}},astart:{short:"Start<br>flow",tdy:-15},comp:{short:"Comp",c:{dt:"Component"}},usecase:{short:"Use case",c:{dt:"Use Case"}},package:{short:"Package",c:{dt:"Package"}},rect:{short:"Rect"},circle:{short:"Circle"},vpart:{target_type:"rectcont",c:{tw:170,th:225}},activity:{short:"Activity",c:{dt:"Activity"}},centtop:{short:"Central<br>topic",tdy:-15,c:{dt:"Central Topic"}},maintopic:{short:"Main topic",target_type:"activity",c:{dt:"Main Topic"}},subtopic:{short:"Sub topic",target_type:"textitem",c:{dt:"Sub topic"}},comments:{short:"Comments"},server2:{c:{tw:43,th:86}},firewall:{c:{tw:74,th:139}}}}]),window.appInjector=function(){return angular.element("html").injector()},window.popoverConfig=function(e,t,n,o){setTimeout(function(){var r=appInjector().get("PopoverService");r.popoverConfig(e,t,n,o)},500)},window.popoverShow=function(e,t,n){var o=appInjector().get("PopoverService");o.popoverShow(e,t,n)},window.popoverShowAndFocus=function(e,t,n,o){var r=appInjector().get("PopoverService");r.popoverShowAndFocus(e,t,n,o)},window.closeAllPopovers=function(){var e=appInjector().get("PopoverService");e.closeAllOpenPopovers()},$.cachedScript=function(e,t){return t=$.extend(t||{},{dataType:"script",cache:!0,url:e}),jQuery.ajax(t)},$.cachedCss=function(e,t){return t=$.extend(t||{},{dataType:"text",cache:!0,url:e}),jQuery.ajax(t)};var uiutils=function(){function e(){var e=window.navigator.userAgent;return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|mobile/i.test(e)}var t={};return t.getPosition=function(e){var t=e[0];return $.extend({},"function"==typeof t.getBoundingClientRect?t.getBoundingClientRect():{width:t.offsetWidth,height:t.offsetHeight},e.offset())},t.applyPos=function(e,t,n,o){o.css({top:e.top+n+"px",left:e.left+t+"px"})},t.mobile=e(),t.isMobile=function(){return t.mobile},t}(),bigcssloader=function(){var e=function(e){var t=document.createElement("link");t.rel="stylesheet",t.href=e;var n=document.getElementsByTagName("head")[0];n.parentNode.insertBefore(t,n)},t=[];"undefined"!=typeof _config&&t.push(_config.staticPrefix+"/resources-static-1/css/font-awesome/4.5.0/css/font-awesome.min.css");var n=function(){for(var n=0;n<t.length;++n)e(t[n])},o=requestAnimationFrame||mozRequestAnimationFrame||webkitRequestAnimationFrame||msRequestAnimationFrame;o?o(n):window.addEventListener("load",n)}(),SketchboardClipboard;SketchboardClipboard=new(function(){function e(){this.value="",$(document).keydown(function(e){return function(t){if(!$(t.target).is("input:visible,textarea:visible")){var o,r;"function"==typeof window.getSelection&&null!=(o=window.getSelection())&&o.toString()||null!=(r=document.selection)&&r.createRange().text||n(e,t)}}}(this)),$(document).keyup(function(e){if($(e.target).is("#clipboard"))return $("#clipboard-container").empty().hide()})}var t=function(e){var t=e.clipboardData?e.clipboardData:e.originalEvent&&e.originalEvent.clipboardData,n=t&&t.getData("text/plain");if(n)try{var o=JSON.parse(n),r=location.pathname.substring(1);if(o.boardId&&o.items){var t={to_board:r,from_board:o.boardId,items:JSON.stringify(o.items)};backendClipboard.pasteFromClipboard2(t).then(function(e){e&&gwtPaste(n)})}}catch(e){}};$(document).on("paste",function(e){var n=e.originalEvent&&e.originalEvent.clipboardData&&e.originalEvent.clipboardData.items,o={files:[]};n&&n.length&&$.each(n,function(e,t){var n=t.getAsFile&&t.getAsFile();n&&o.files.push(n)}),0==o.files&&t(e)});var n=function(e,t){try{if(!t.ctrlKey&&!t.metaKey)return;if(e.value=gwtCopy(),!e.value||"[]"==e.value)return;_.defer(function(){var t;t=$("#clipboard-container"),t.empty().show(),$("<textarea id='clipboard'></textarea>").val(e.value).appendTo(t).focus().select()})}catch(e){}};return e}()),angular.module("texts",[],["$provide",function(e){
e.value("sharemenu",{nowpublic:"Board is now public, world viewable.",nowsharedwithaccount:"Board is now shared with {} team.",nowprivate:"Board is now private personal.",rememberSharePassword:"Remember to share password with collaborators.",sharedWithAccount:"Board is shared with your team."}),e.value("boardmenu",{makePrivate:"Board has been associated with {} account and it's visibility is private. Share board to give access within a team.",renameCondition:"You need to be logged in to rename a board.",onlyOwnerCanChangeBoardName:"Only board owner can change board name.",cannotRenameTeamAccountExpired:"Sorry, cannot rename since your default team account is expired. Please subscribe to activate your team account.",restoreTip:"None of your other versions will be lost. This version will be copied and become the current editable board.",freeOwnedSomeoneElse:'This is <strong>public read only</strong> board. You need to be logged in and accepted as collaborator in the team to edit the board. <a href="/service/signup/{}" class="action-text">Sign up</a>.',freeMyBoard:"This is <strong>public board</strong>. Anyone can access the board as read only. Only team members can edit the board.",freeNotOwnedBoard:'<span>This is public board. <a ng-click="markCurrentAsPro()" class="action-text">Make it private.</a></span>',freeNotOwnedBoardNotLoggedIn:'This is a public board. <a href="/service/signup/{}" class="action-text">Sign up and take ownership.</a>'}),e.value("errormsg",{fileTypeNotSupported:"Upload failed. Supported file types are gif, png and jpg.",fileUploadFull:"You cannot upload any more images. Maximum storage space exceeded. Try to upload smaller image or remove images from the library.",tooBigFile:"Maximum file size is 5 MB. Please, try to upload a smaller file.",paymentFailed1:'You already have an active subscription. Please contact <a style="text-decoration: underline;" href="mailto:info@7scales.net">info@7scales.net</a> if needed.'}),e.value("apimsg",{notAdmin:"Non admin tried to add users to the team. Team admin should add team members manually.",insufficienPlan:"Current team plan doesn't support this many members. Team admin should check team members and upgrade team plan to add new collaborators."}),e.value("hipchatint",{enabledText:"Yesh, HipChat Sketchboard.io integration is enabled!",disabledText:"HipChat Sketchboard.io integration is disabled."})}]),function(e){e.fn.markdownify=function(t){if(t&&t.cloudinary)var n=t.cloudinary.cloudName,o=t.cloudinary.unsignedUploadingKey;var r;return this.each(function(){function t(e,t){c.replaceSelection(e+c.getSelection()),t&&c.replaceSelection(t,"start")}function a(){var e=c.getSelection(),t="type url";0!==e.indexOf("http://")&&0!==e.indexOf("https://")&&0!==e.indexOf("mailto:")||(t=e);var n=!0;t===e&&(n=!1),c.replaceSelection("["+e+"]("+t+")");var o=c.getCursor(),r=_.clone(o);n?(o.ch-=1,r.ch-=t.length+1):(o.ch-=t.length+3,r.ch-=2*t.length+3),c.setSelection(r,o)}var i=this,c=CodeMirror.fromTextArea(i,{lineWrapping:!0,theme:"default",dragDrop:!1});r=c;var s=e('.btn--preview[data-target="'+i.id+'"]'),l=s.text()||"Preview";s.data("toggle-text")||"Edit";s.text(l);var u={el:function(e){t(e.data("prefix"),e.data("suffix"))},line:function(e){var t=c.getCursor();c.setSelection({line:t.line,ch:0}),c.replaceSelection(e.data("prefix")+" "+c.getSelection());var n=c.getLine(t.line);c.setSelection({line:t.line,ch:n.length})},link:function(){a()},video:function(){var e=window.prompt("Enter a video url ex: https://www.youtube.com/watch?v=bGutVrdL3M8");e&&c.replaceSelection("\n"+e+"\n\n")},img:function(t){e("#"+t.parent(".markdownify-menu").data("target")+"-upload_field").trigger("click")}};c.setOption("extraKeys",{Tab:function(e){var t=Array(5).join(" ");e.replaceSelection(t)},"Cmd-B":function(e){t("**","**")},"Ctrl-B":function(e){t("**","**")},"Cmd-I":function(e){t("_","_")},"Ctrl-I":function(e){t("_","_")},"Cmd-L":function(e){a()},"Ctrl-L":function(e){a()}}),e(i.parentNode).find('.markdownify-menu[data-target="'+i.id+'"] .btn--insert').click(function(t){u[e(this).data("type")||"el"](e(this)),c.focus(),t.preventDefault()}),n&&(e("body").append("          <form enctype='multipart/form-data'>            <input class='upload_field' data-target='"+i.id+"' id='"+i.id+"-upload_field' name='file' type='file'/>          </form>        "),e(".upload_field[data-target="+i.id+"]").unsigned_cloudinary_upload(o,{cloud_name:n,tags:"browser_uploads"},{multiple:!0}).bind("cloudinarydone",function(t,o){c.replaceSelection("![]("+e.cloudinary.url(o.result.public_id,{cloud_name:n})+")\n"),c.focus()}))}),r}}(jQuery);